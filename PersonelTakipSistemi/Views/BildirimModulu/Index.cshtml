@{
    ViewData["Title"] = "Bildirim Modülü";
}

@section Styles {
    <!-- Select2 -->

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        .personel-table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .personel-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .personel-card:hover {
            background-color: #f8f9fa;
        }
        .personel-card.selected {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
        }
        .search-box {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #fff;
            background: #fff;
            padding-bottom: 10px;
        }
        .passive-row {
            opacity: 0.5;
            background-color: #f2f2f2;
        }
        .passive-row .personel-checkbox {
            cursor: not-allowed;
        }
    </style>
}

<div class="row">
    <!-- SOL PANEL: Personel Listesi & Filtreler -->
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header border-bottom">
                <h5 class="card-title mb-3">Hedef Kitle Seçimi</h5>
                
                <!-- Detaylı Filtre Alanı (Grid Inputs) -->
                <div class="filter-bar row row-cols-1 row-cols-md-2 row-cols-xl-4 g-2 align-items-center mb-3">
                    <!-- 1. Search -->
                    <div class="col">
                        <input type="text" id="filterSearch" class="form-control w-100" placeholder="Ad Soyad Ara...">
                    </div>
                    
                    <!-- 2. Teskilat -->
                    <div class="col">
                        <select id="filterTeskilat" class="form-select w-100">
                            <option value="">Teşkilat: Tümü</option>
                            @if(ViewBag.TeskilatList != null) {
                                foreach(var item in ViewBag.TeskilatList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 3. Koordinatorluk -->
                    <div class="col">
                        <select id="filterKoordinatorluk" class="form-select w-100" disabled>
                            <option value="">Önce Teşkilat Seçiniz</option>
                        </select>
                    </div>

                    <!-- 4. Komisyon -->
                    <div class="col">
                        <select id="filterKomisyon" class="form-select w-100" disabled>
                            <option value="">Önce Koordinatörlük Seçiniz</option>
                        </select>
                    </div>

                    <!-- 5. Branş -->
                    <div class="col">
                        <select id="filterBrans" class="form-select w-100">
                            <option value="">Branş: Tümü</option>
                            @if(ViewBag.BransList != null) {
                                foreach(var item in ViewBag.BransList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 6. Kurumsal Rol -->
                    <div class="col">
                        <select id="filterKurumsalRol" class="form-select w-100">
                            <option value="">Kurumsal Rol: Tümü</option>
                            @if(ViewBag.KurumsalRolList != null) {
                                foreach(var item in ViewBag.KurumsalRolList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 7. Sistem Rolü -->
                    <div class="col">
                        <select id="filterSistemRol" class="form-select w-100">
                            <option value="">Sistem Rolü: Tümü</option>
                            @if(ViewBag.SistemRolList != null) {
                                foreach(var item in ViewBag.SistemRolList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 8. Yazılım -->
                    <div class="col">
                        <select id="filterYazilim" class="form-select w-100">
                            <option value="">Yazılım: Tümü</option>
                            @if(ViewBag.YazilimList != null) {
                                foreach(var item in ViewBag.YazilimList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 9. Uzmanlık -->
                    <div class="col">
                        <select id="filterUzmanlik" class="form-select w-100">
                            <option value="">Uzmanlık: Tümü</option>
                            @if(ViewBag.UzmanlikList != null) {
                                foreach(var item in ViewBag.UzmanlikList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 10. Görev Türü -->
                    <div class="col">
                        <select id="filterGorevTuru" class="form-select w-100">
                            <option value="">Görev Türü: Tümü</option>
                            @if(ViewBag.GorevTuruList != null) {
                                foreach(var item in ViewBag.GorevTuruList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 11. İş Niteliği -->
                    <div class="col">
                        <select id="filterIsNiteligi" class="form-select w-100">
                            <option value="">İş Niteliği: Tümü</option>
                            @if(ViewBag.IsNiteligiList != null) {
                                foreach(var item in ViewBag.IsNiteligiList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 12. Butonlar (Grid İçinde) -->
                    <div class="col">
                        <div class="d-flex gap-2">
                             <button class="btn btn-primary btn-sm flex-grow-1" onclick="loadPersonelList()" title="Filtrele">
                                <i class="bx bx-filter-alt me-1"></i> Filtrele
                            </button>
                            <button class="btn btn-outline-secondary btn-sm flex-grow-1" onclick="clearFilters()" title="Temizle">
                                <i class="bx bx-reset me-1"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-3 mt-2">
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            Tümünü Seç
                        </label>
                    </div>
                    <span class="text-muted small" id="totalCountBadge">0 kişi listelendi</span>
                    
                    <button id="btnClearSelection" class="btn btn-sm btn-text-danger ms-auto" type="button" title="Tüm seçimleri kaldır">
                        <span class="small"><i class="bx bx-x-circle me-1"></i>Seçimi Temizle</span>
                    </button>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive personel-table-container">
                    <table class="table table-hover mb-0" id="personelTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th style="width: 60px;"></th> <!-- Avatar -->
                                <th>Ad Soyad</th>
                                <th>Koordinatörlük / Komisyon</th>
                                <th>Uzmanlık</th>
                            </tr>
                        </thead>
                        <tbody id="personelTableBody">
                            <!-- JS ile doldurulacak -->
                            <tr><td colspan="5" class="text-center p-4">Yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            

        </div>
    </div>

    <!-- SAĞ PANEL: Bildirim Formu -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title text-white mb-0">Bildirim Oluştur</h5>
            </div>
            <div class="card-body pt-4">
                <form id="notificationForm">
                    <!-- Gönderen -->
                    <div class="mb-3">
                        <label class="form-label">Gönderen Kimliği</label>
                        <select id="senderSelect" class="form-select" style="width: 100%;">
                            <!-- JS ile dolacak -->
                        </select>
                    </div>

                    <!-- Alıcı Özeti -->
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="bx bx-group me-2"></i>
                        <div>
                            <span id="selectedCount" class="fw-bold">0</span> kişi seçildi.
                        </div>
                    </div>

                    <!-- Başlık -->
                    <div class="mb-3">
                        <label class="form-label">Başlık *</label>
                        <input type="text" class="form-control" id="notifTitle" required placeholder="Bildirim başlığı">
                    </div>

                    <!-- İçerik -->
                    <div class="mb-3">
                        <label class="form-label">Mesaj İçeriği *</label>
                        <textarea class="form-control" id="notifContent" rows="4" required placeholder="Mesajınız..."></textarea>
                    </div>

                    <!-- Zamanlama -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="scheduleSwitch">
                            <label class="form-check-label" for="scheduleSwitch">İleri Tarihli Gönderim</label>
                        </div>
                        <div id="datePickerContainer" style="display:none;">
                            <input type="text" class="form-control" id="scheduleDate" placeholder="Tarih ve Saat Seçin">
                        </div>
                    </div>

                    <!-- Buton -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="btnSend">
                            <i class="bx bx-paper-plane me-1"></i> Gönder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Libs -->

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/tr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // GLOBAL STATE
        var selectedMap = new Map(); // Store full object: id -> personelObj
        var isProgrammaticChange = false; // Flag to prevent recursive filter triggers

        $(document).ready(function() {
            console.log("Bildirim Modülü Yükleniyor...");
            initSenderSelect();
            initDatePicker();
            initFilters();
            
            // Event Listeners
            $('#scheduleSwitch').change(function() {
                $('#datePickerContainer').toggle(this.checked);
            });

            $('#selectAll').change(function() {
                // Sadece GÖRÜNEN satırları seçer
                const isChecked = $(this).is(':checked');
                $('.personel-checkbox').each(function() {
                    // Sadece o anki görünümde unchecked olanları ekle veya çıkar
                    var row = $(this).closest('tr');
                    // Data attribute'dan veriyi al
                    var pData = row.data('personel'); 
                    var id = pData.personelId;
                    
                    if(isChecked) {
                        if(!selectedMap.has(id)) selectedMap.set(id, pData);
                        $(this).prop('checked', true);
                        row.addClass('selected');
                    } else {
                        // Tümünü kaldır dediğinde, sadece görünürleri mi kaldırmalı yoksa hepsini mi?
                        // Genelde "Tümünü Seç" checkbox'ı o anki listeyi yönetir.
                        // "Seçimi Temizle" butonu genel temizlik yapar.
                         if(selectedMap.has(id)) selectedMap.delete(id);
                         $(this).prop('checked', false);
                         row.removeClass('selected');
                    }
                });
                updateCount();
            });
            
            $('#notificationForm').on('submit', function(e) {
                e.preventDefault();
                submitForm();
            });

            // "Seçimi Temizle" Button Event (Added dynamically or static)
            // But we need to add the button to the DOM first (see HTML update below)
            $('#btnClearSelection').on('click', function() {
                if(selectedMap.size === 0) return;
                
                Swal.fire({
                    title: 'Emin misiniz?',
                    text: "Tüm seçimleriniz kaldırılacak.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Evet, Temizle',
                    cancelButtonText: 'İptal'
                }).then((res) => {
                    if(res.isConfirmed) {
                        selectedMap.clear();
                        // Re-render current view to remove checks/highlights
                        // Or just simplistic UI update:
                        $('.personel-checkbox').prop('checked', false);
                        $('.personel-card').removeClass('selected');
                        $('#selectAll').prop('checked', false);
                        
                        // If we are showing "only selected" or merged list, we might want to refresh to remove them from view if they don't match filter
                        // But simpler is just uncheck.
                        // Actually, if they was pinned and don't match filter, they should disappear?
                        // Let's reload list to be clean.
                        loadPersonelList(false); // Reload without prompt, but since map is empty, it's a fresh load.
                        updateCount();
                    }
                });
            });
        });

        // --- FILTERS ---
        function initFilters() {
            $('.form-select').select2({
                theme: 'bootstrap-5', width: '100%', allowClear: false, language: "tr"
            });

            $('#filterKoordinatorluk, #filterKomisyon').prop('disabled', true).val(null).trigger('change');

            loadPersonelList(true); // Initial load

            // Cascading
            $('#filterTeskilat').on('change', function() { loadKoordinatorlukler($(this).val()); });
            $('#filterKoordinatorluk').on('change', function() { loadKomisyonlar($(this).val()); });

            // Search (Debounced slightly ideally, but direct is fine for now)
            // Search (Debounced slightly ideally, but direct is fine for now)
            $('#filterSearch').on('input', function() { loadPersonelListWithCheck(); });

            // Filter Change Handlers (Intercept logic)
            var filters = '#filterTeskilat, #filterKoordinatorluk, #filterKomisyon, #filterBrans, #filterKurumsalRol, #filterSistemRol, #filterYazilim, #filterUzmanlik, #filterGorevTuru, #filterIsNiteligi';
            
            $(filters).on('change', function(e) {
                if(isProgrammaticChange) return;
                loadPersonelListWithCheck();
            });
        }

        // Wrapper to check if we should prompt user
        function loadPersonelListWithCheck() {
            if (selectedMap.size > 0) {
                // Ask user
                Swal.fire({
                    title: 'Seçimleriniz Var',
                    text: "Filtreleme kriterlerini değiştirdiniz. Mevcut seçimleriniz korunsun mu?",
                    icon: 'question',
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'Evet, Koru',
                    denyButtonText: 'Hayır, Temizle',
                    cancelButtonText: 'İptal' // User can cancel the filter change? Hard to revert select2 easily without state tracking. 
                    // Let's assume Cancel = Keep working but don't refresh list? No, that leaves UI inconsistent.
                    // Treating Cancel as "Do nothing" implies we revert filter value? Too complex for Select2.
                    // Let's simplify: Cancel -> Treat as Keep. Or Hide Cancel.
                }).then((result) => {
                    if (result.isConfirmed) {
                        // YES -> Keep selections, Append new results
                        loadPersonelList(false, true); // keepSelection = true
                    } else if (result.isDenied) {
                        // NO -> Clear selections, Load new results
                        selectedMap.clear();
                        $('#selectAll').prop('checked', false);
                        loadPersonelList(false, false);
                    } else {
                        // Cancel -> Do nothing? But filter IS changed. 
                        // User might want to revert the filter change.
                        // Difficult to implement revert. sticking to "Keep" logic if cancelled is safer.
                        loadPersonelList(false, true); 
                    }
                });
            } else {
                // No selections, just load
                loadPersonelList(false, false);
            }
        }

        function loadKoordinatorlukler(teskilatId) {
            isProgrammaticChange = true;
            var $dropdown = $('#filterKoordinatorluk');
            var $child = $('#filterKomisyon');
            
            if (!teskilatId) {
                $dropdown.empty().append('<option value="">Önce Teşkilat Seçiniz</option>').prop('disabled', true).val(null).trigger('change');
                $child.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true).val(null).trigger('change');
                isProgrammaticChange = false;
                return;
            }

            $.ajax({
                url: '/BildirimModulu/GetKoordinatorlukler', data: { teskilatId: teskilatId },
                success: function(data) {
                    $dropdown.empty().append('<option value="">Koordinatörlük: Tümü</option>');
                    if (data && data.length > 0) {
                        $.each(data, function(i, item) { $dropdown.append(new Option(item.text || item.Text, item.value || item.Value)); });
                        $dropdown.prop('disabled', false);
                    } else {
                        $dropdown.empty().append('<option value="">Kayıt Yok</option>');
                    }
                    $dropdown.trigger('change');
                },
                complete: function() { isProgrammaticChange = false; }
            });
        }

        function loadKomisyonlar(koordinatorlukId) {
            isProgrammaticChange = true;
            var $dropdown = $('#filterKomisyon');
            if (!koordinatorlukId) {
                $dropdown.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true).val(null).trigger('change');
                isProgrammaticChange = false;
                return;
            }
            $.ajax({
                url: '/BildirimModulu/GetKomisyonlar', data: { koordinatorlukId: koordinatorlukId },
                success: function(data) {
                    $dropdown.empty().append('<option value="">Komisyon: Tümü</option>');
                    if (data && data.length > 0) {
                        $.each(data, function(i, item) { $dropdown.append(new Option(item.text || item.Text, item.value || item.Value)); });
                        $dropdown.prop('disabled', false);
                    } else {
                        $dropdown.empty().append('<option value="">Kayıt Yok</option>');
                    }
                    $dropdown.trigger('change');
                },
                complete: function() { isProgrammaticChange = false; }
            });
        }

        // --- DATA LOADING & RENDERING ---
        function loadPersonelList(isInitial = false, keepSelection = false) {
             var payload = {
                search: $('#filterSearch').val(),
                teskilatId: $('#filterTeskilat').val(),
                koordinatorlukId: $('#filterKoordinatorluk').val(),
                komisyonId: $('#filterKomisyon').val(),
                sistemRolId: $('#filterSistemRol').val(),
                kurumsalRolId: $('#filterKurumsalRol').val(),
                bransAd: $('#filterBrans').val(),
                yazilimAd: $('#filterYazilim').val(),
                uzmanlikAd: $('#filterUzmanlik').val(),
                gorevTuruAd: $('#filterGorevTuru').val(),
                isNiteligiAd: $('#filterIsNiteligi').val()
            };

            $('#personelTableBody').html('<tr><td colspan="5" class="text-center p-3">Yükleniyor...</td></tr>');

            $.ajax({
                url: '/BildirimModulu/GetPersonelList',
                data: payload,
                success: function(serverData) {
                    // Logic:
                    // 1. If keepSelection is true, we take all items from selectedMap.values()
                    // 2. We add items from serverData that are NOT in selectedMap
                    // 3. We render the combined list. Pinned items first.
                    
                    var displayList = [];
                    
                    if (keepSelection && selectedMap.size > 0) {
                        // Add pinned items
                        selectedMap.forEach((v, k) => {
                            // Optionally mark as pinned visually if desired, but not strictly asked
                            displayList.push(v);
                        });
                        
                        // Add new items from filter
                        if (serverData && serverData.length > 0) {
                            serverData.forEach(p => {
                                if (!selectedMap.has(p.personelId)) { // Avoid duplicates
                                    displayList.push(p);
                                }
                            });
                        }
                    } else {
                        // Standard flow
                        displayList = serverData || [];
                    }
                    
                    renderTable(displayList);
                },
                error: function() {
                    $('#personelTableBody').html('<tr><td colspan="5" class="text-center text-danger">Yükleme hatası!</td></tr>');
                }
            });
        }

        function renderTable(data) {
            var $tbody = $('#personelTableBody');
            $tbody.empty();

            if (!data || data.length === 0) {
                // If map has items (shouldn't happen here if logic above is right, but check)
               if(selectedMap.size > 0) {
                   // Just render selected
                   // Handled in loadPersonelList actually
               } else {
                   $tbody.html('<tr><td colspan="5" class="text-center p-4">Kayıt bulunamadı.</td></tr>');
                   $('#totalCountBadge').text('0 kişi listelendi');
                   return;
               }
            }

            $('#totalCountBadge').text(data.length + ' kişi listelendi');

            data.forEach(function(p) {
                // Check if selected
                var isSel = selectedMap.has(p.personelId);
                var rowClass = 'personel-card' + (isSel ? ' selected' : '');
                var checkProp = isSel ? 'checked' : '';
                
                 // Avatar Logic
                var avatarHtml = '';
                if (p.fotografYolu) {
                    avatarHtml = `<img src="${p.fotografYolu}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">`;
                } else {
                    var initials = getInitials(p.adSoyad);
                    var colorClass = getColorClass(initials);
                    avatarHtml = `<div class="rounded-circle d-flex align-items-center justify-content-center fw-bold text-white ${colorClass}" style="width: 40px; height: 40px; font-size: 14px;">${initials}</div>`;
                }
                
                 // Column 2: Birimler
                var birimHtml = '';
                if(p.koordinatorlukler) p.koordinatorlukler.forEach(k => birimHtml += `<div class="badge bg-info text-dark mb-1 d-block text-truncate" style="max-width: 150px;" title="${k}">${k}</div>`);
                if(p.komisyonlar) p.komisyonlar.forEach(k => birimHtml += `<div class="badge bg-warning text-dark mb-1 d-block text-truncate" style="max-width: 150px;" title="${k}">${k}</div>`);
                if(!birimHtml) birimHtml = '-';
                
                 // Column 3: Uzmanlık
                var uzmanlikHtml = '';
                if(p.uzmanliklar) p.uzmanliklar.forEach(u => uzmanlikHtml += `<span class="badge bg-secondary me-1 mb-1">${u}</span>`);
                else uzmanlikHtml = '-';

                // JSON string for data storage (store in a way we can retrieve)
                // We'll attach the object via jQuery data() to the row after creation, or parse on click
                
                var isPassive = !p.aktifMi;
                if(isPassive) rowClass += ' passive-row';

                var $tr = $(`
                    <tr class="${rowClass}">
                        <td class="align-middle">
                            <div class="form-check">
                                <input class="form-check-input personel-checkbox" type="checkbox" value="${p.personelId}" ${checkProp} ${isPassive ? 'disabled' : ''}>
                            </div>
                        </td>
                        <td class="align-middle">${avatarHtml}</td>
                        <td class="align-middle">
                            <div class="fw-bold">${p.adSoyad} ${isPassive ? '(Pasif)' : ''}</div>
                            <small class="text-muted"><i class="bx bx-map"></i> ${p.sehir}</small>
                        </td>
                        <td class="align-middle">${birimHtml}</td>
                        <td class="align-middle">${uzmanlikHtml}</td>
                    </tr>
                `);
                
                // Attach Data
                $tr.data('personel', p);
                
                // Click Event
                $tr.on('click', function(e) {
                     if(isPassive) return; // Block click for passive
                     // If clicked on checkbox, don't double trigger
                     if($(e.target).is('input')) return;
                     toggleBox(p.personelId, $tr);
                });
                
                $tr.find('input').on('change', function() {
                     toggleBoxState(p.personelId, $tr, $(this).is(':checked'));
                });

                $tbody.append($tr);
            });
            
            updateCount();
        }

        function toggleBox(id, $row) {
            var $cb = $row.find('input');
            var newState = !$cb.prop('checked');
            $cb.prop('checked', newState);
            toggleBoxState(id, $row, newState);
        }

        function toggleBoxState(id, $row, isChecked) {
            var pData = $row.data('personel');
            
            if(isChecked) {
                $row.addClass('selected');
                selectedMap.set(id, pData);
            } else {
                $row.removeClass('selected');
                selectedMap.delete(id);
            }
            updateCount();
        }

        function updateCount() {
            var count = selectedMap.size;
            $('#selectedCount').text(count);
            $('#bottomSelectedCount').text(count);
            // SelectAll check logic
            var visibleCount = $('.personel-checkbox').length;
             var checkedVisible = $('.personel-checkbox:checked').length;
            $('#selectAll').prop('checked', visibleCount > 0 && visibleCount === checkedVisible);
        }
        
        function clearFilters() {
            // "Filtreleri temizle dediğinde seçim yapılanlar listenin üzerinde tutulsun"
            // So we just reset inputs and loadList(keepSelection=true)
            
            isProgrammaticChange = true;
            $('#filterSearch').val('');
            $('select').val('').trigger('change'); // Resets simple selects
            // Specific Select2 Resets
            // Reset Cascading manually to be sure
            $('#filterKoordinatorluk').empty().append('<option value="">Önce Teşkilat Seçiniz</option>').prop('disabled', true).trigger('change.select2');
            $('#filterKomisyon').empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true).trigger('change.select2');
            isProgrammaticChange = false;

            loadPersonelList(false, true); // Keep selections!
        }
        
        // --- HELPERS ---
        function getInitials(name) {
            if(!name) return '';
            var names = name.split(' ');
            var initials = names[0].substring(0, 1).toUpperCase();
            if (names.length > 1) initials += names[names.length - 1].substring(0, 1).toUpperCase();
            return initials;
        }

        function getColorClass(str) {
            var colors = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning text-dark', 'bg-info text-dark', 'bg-dark'];
            var hash = 0;
            for (var i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            var index = Math.abs(hash % colors.length);
            return colors[index];
        }

        function initSenderSelect() {
            $.get('/BildirimModulu/GetSenders', function(data) {
                var $sel = $('#senderSelect');
                $sel.empty();
                data.forEach(function(s) { $sel.append(new Option(s.ad, s.id)); });
            });
        }

        function initDatePicker() {
            flatpickr("#scheduleDate", { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today", time_24hr: true, locale: "tr" });
        }

        function submitForm() {
            if (selectedMap.size === 0) {
                Swal.fire('Uyarı', 'Lütfen en az bir kişi seçiniz.', 'warning');
                return;
            }

            var recipientIds = Array.from(selectedMap.keys());
            var senderId = $('#senderSelect').val();
            var title = $('#notifTitle').val();
            var content = $('#notifContent').val();
            var isScheduled = $('#scheduleSwitch').is(':checked');
            var scheduledTime = isScheduled ? $('#scheduleDate').val() : null;

            if (isScheduled && !scheduledTime) {
                Swal.fire('Uyarı', 'Planlanan tarihi seçiniz.', 'warning');
                return;
            }

            var payload = {
                RecipientIds: recipientIds,
                SenderId: senderId,
                Baslik: title,
                Icerik: content,
                ScheduledTime: scheduledTime
            };

            $('#btnSend').prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin"></i> Gönderiliyor...');

            $.ajax({
                url: '/BildirimModulu/SendBulk',
                type: 'POST', contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    Swal.fire('Başarılı', isScheduled ? 'Bildirim planlandı.' : 'Bildirimler gönderildi.', 'success')
                        .then(() => {
                           $('#notifTitle').val('');
                           $('#notifContent').val('');
                           selectedMap.clear();
                           loadPersonelList(false, false);
                           updateCount();
                           $('#btnSend').prop('disabled', false).html('<i class="bx bx-paper-plane me-1"></i> Gönder');
                        });
                },
                error: function(xhr) {
                    Swal.fire('Hata', 'Gönderim başarısız: ' + xhr.responseText, 'error');
                    $('#btnSend').prop('disabled', false).html('<i class="bx bx-paper-plane me-1"></i> Gönder');
                }
            });
        }
    </script>
}

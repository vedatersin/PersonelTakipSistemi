@{
    ViewData["Title"] = "Bildirim Modülü";
}

@section Styles {
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        .personel-table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .personel-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .personel-card:hover {
            background-color: #f8f9fa;
        }
        .personel-card.selected {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
        }
        .search-box {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #fff;
            padding-bottom: 10px;
        }
    </style>
}

<div class="row">
    <!-- SOL PANEL: Personel Listesi & Filtreler -->
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header border-bottom">
                <h5 class="card-title mb-3">Hedef Kitle Seçimi</h5>
                
                <!-- Detaylı Filtre Alanı (Grid Inputs) -->
                <div class="filter-bar row row-cols-1 row-cols-md-2 row-cols-xl-4 g-2 align-items-center mb-3">
                    <!-- 1. Search -->
                    <div class="col">
                        <input type="text" id="filterSearch" class="form-control w-100" placeholder="Ad Soyad Ara...">
                    </div>
                    
                    <!-- 2. Teskilat -->
                    <div class="col">
                        <select id="filterTeskilat" class="form-select w-100">
                            <option value="">Teşkilat: Tümü</option>
                            @if(ViewBag.TeskilatList != null) {
                                foreach(var item in ViewBag.TeskilatList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 3. Koordinatorluk -->
                    <div class="col">
                        <select id="filterKoordinatorluk" class="form-select w-100" disabled>
                            <option value="">Önce Teşkilat Seçiniz</option>
                        </select>
                    </div>

                    <!-- 4. Komisyon -->
                    <div class="col">
                        <select id="filterKomisyon" class="form-select w-100" disabled>
                            <option value="">Önce Koordinatörlük Seçiniz</option>
                        </select>
                    </div>

                    <!-- 5. Branş -->
                    <div class="col">
                        <select id="filterBrans" class="form-select w-100">
                            <option value="">Branş: Tümü</option>
                            @if(ViewBag.BransList != null) {
                                foreach(var item in ViewBag.BransList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 6. Kurumsal Rol -->
                    <div class="col">
                        <select id="filterKurumsalRol" class="form-select w-100">
                            <option value="">Kurumsal Rol: Tümü</option>
                            @if(ViewBag.KurumsalRolList != null) {
                                foreach(var item in ViewBag.KurumsalRolList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 7. Sistem Rolü -->
                    <div class="col">
                        <select id="filterSistemRol" class="form-select w-100">
                            <option value="">Sistem Rolü: Tümü</option>
                            @if(ViewBag.SistemRolList != null) {
                                foreach(var item in ViewBag.SistemRolList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 8. Yazılım -->
                    <div class="col">
                        <select id="filterYazilim" class="form-select w-100">
                            <option value="">Yazılım: Tümü</option>
                            @if(ViewBag.YazilimList != null) {
                                foreach(var item in ViewBag.YazilimList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 9. Uzmanlık -->
                    <div class="col">
                        <select id="filterUzmanlik" class="form-select w-100">
                            <option value="">Uzmanlık: Tümü</option>
                            @if(ViewBag.UzmanlikList != null) {
                                foreach(var item in ViewBag.UzmanlikList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 10. Görev Türü -->
                    <div class="col">
                        <select id="filterGorevTuru" class="form-select w-100">
                            <option value="">Görev Türü: Tümü</option>
                            @if(ViewBag.GorevTuruList != null) {
                                foreach(var item in ViewBag.GorevTuruList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 11. İş Niteliği -->
                    <div class="col">
                        <select id="filterIsNiteligi" class="form-select w-100">
                            <option value="">İş Niteliği: Tümü</option>
                            @if(ViewBag.IsNiteligiList != null) {
                                foreach(var item in ViewBag.IsNiteligiList) { <option value="@item.Value">@item.Text</option> }
                            }
                        </select>
                    </div>

                    <!-- 12. Butonlar (Grid İçinde) -->
                    <div class="col">
                        <div class="d-flex gap-2">
                             <button class="btn btn-primary btn-sm flex-grow-1" onclick="loadPersonelList()" title="Filtrele">
                                <i class="bx bx-filter-alt me-1"></i> Filtrele
                            </button>
                            <button class="btn btn-outline-secondary btn-sm flex-grow-1" onclick="clearFilters()" title="Temizle">
                                <i class="bx bx-reset me-1"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-3 mt-2">
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            Tümünü Seç
                        </label>
                    </div>
                    <span class="text-muted small" id="totalCountBadge">0 kişi listelendi</span>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive personel-table-container">
                    <table class="table table-hover mb-0" id="personelTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th style="width: 60px;"></th> <!-- Avatar -->
                                <th>Ad Soyad</th>
                                <th>Koordinatörlük / Komisyon</th>
                                <th>Uzmanlık</th>
                            </tr>
                        </thead>
                        <tbody id="personelTableBody">
                            <!-- JS ile doldurulacak -->
                            <tr><td colspan="5" class="text-center p-4">Yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- SAĞ PANEL: Bildirim Formu -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title text-white mb-0">Bildirim Oluştur</h5>
            </div>
            <div class="card-body pt-4">
                <form id="notificationForm">
                    <!-- Gönderen -->
                    <div class="mb-3">
                        <label class="form-label">Gönderen Kimliği</label>
                        <select id="senderSelect" class="form-select" style="width: 100%;">
                            <!-- JS ile dolacak -->
                        </select>
                    </div>

                    <!-- Alıcı Özeti -->
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="bx bx-group me-2"></i>
                        <div>
                            <span id="selectedCount" class="fw-bold">0</span> kişi seçildi.
                        </div>
                    </div>

                    <!-- Başlık -->
                    <div class="mb-3">
                        <label class="form-label">Başlık *</label>
                        <input type="text" class="form-control" id="notifTitle" required placeholder="Bildirim başlığı">
                    </div>

                    <!-- İçerik -->
                    <div class="mb-3">
                        <label class="form-label">Mesaj İçeriği *</label>
                        <textarea class="form-control" id="notifContent" rows="4" required placeholder="Mesajınız..."></textarea>
                    </div>

                    <!-- Zamanlama -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="scheduleSwitch">
                            <label class="form-check-label" for="scheduleSwitch">İleri Tarihli Gönderim</label>
                        </div>
                        <div id="datePickerContainer" style="display:none;">
                            <input type="text" class="form-control" id="scheduleDate" placeholder="Tarih ve Saat Seçin">
                        </div>
                    </div>

                    <!-- Buton -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="btnSend">
                            <i class="bx bx-paper-plane me-1"></i> Gönder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/tr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            console.log("Bildirim Modülü Yükleniyor...");
            // Init Components
            initSenderSelect();
            initDatePicker();
            initFilters();
            
            // Event Listeners
            $('#scheduleSwitch').change(function() {
                $('#datePickerContainer').toggle(this.checked);
            });

            $('#selectAll').change(function() {
                const isChecked = $(this).is(':checked');
                $('.personel-checkbox').prop('checked', isChecked).trigger('change');
            });
            
            // Form Submit
            $('#notificationForm').on('submit', function(e) {
                e.preventDefault();
                submitForm();
            });
        });

        // --- FILTERS ---
        // Unified initFilters (Server-Side AJAX Cascading)
        function initFilters() {
            // 1. Init Select2 for all
            $('.form-select').select2({
                theme: 'bootstrap-5', 
                width: '100%', 
                allowClear: true,
                language: "tr"
            });

            // 2. Set placeholders and disable dependent ones
            $('#filterKoordinatorluk').prop('disabled', true).val(null).trigger('change');
            $('#filterKomisyon').prop('disabled', true).val(null).trigger('change');

            // 3. Initial Load (Just Personnel)
            // Independent lists are now server-rendered via ViewBag
            loadPersonelList();

            // 4. Cascading Events (Server-Side)
            $('#filterTeskilat').on('change', function() {
                var teskilatId = $(this).val();
                loadKoordinatorlukler(teskilatId);
            });

            $('#filterKoordinatorluk').on('change', function() {
                var koordinatorlukId = $(this).val();
                loadKomisyonlar(koordinatorlukId);
            });

            // Search input (Instant)
            $('#filterSearch').on('input', function() {
                loadPersonelList();
            });

             // Trigger list reload on any filter change
             $('#filterTeskilat, #filterKoordinatorluk, #filterKomisyon, #filterBrans, #filterKurumsalRol, #filterSistemRol, #filterYazilim, #filterUzmanlik, #filterGorevTuru, #filterIsNiteligi').on('change', function() {
                 loadPersonelList();
             });
        }

        function loadKoordinatorlukler(teskilatId) {
            var $dropdown = $('#filterKoordinatorluk');
            var $childDropdown = $('#filterKomisyon');

            if (!teskilatId) {
                // Disable and Reset
                $dropdown.empty().append('<option value="">Önce Teşkilat Seçiniz</option>').prop('disabled', true).val(null).trigger('change');
                $childDropdown.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true).val(null).trigger('change');
                return;
            }

            // AJAX Call to Server
            $.ajax({
                url: '/BildirimModulu/GetKoordinatorlukler',
                data: { teskilatId: teskilatId },
                success: function(data) {
                    $dropdown.empty().append('<option value="">Koordinatörlük: Tümü</option>');
                    
                    if (data && data.length > 0) {
                        $.each(data, function(i, item) {
                            // Handle potential case differences just in case, though Controller returns Value/Text
                            var val = item.value || item.Value;
                            var txt = item.text || item.Text;
                            $dropdown.append(new Option(txt, val, false, false));
                        });
                        $dropdown.prop('disabled', false);
                    } else {
                        $dropdown.empty().append('<option value="">Bu teşkilata ait koordinatörlük yok</option>');
                        $dropdown.prop('disabled', false); // Keep enabled to see message
                    }
                    $dropdown.trigger('change'); // Refresh Select2
                },
                error: function() {
                    console.error("Koordinatörlükler yüklenemedi.");
                    $dropdown.prop('disabled', false); // Allow retry or show error state if needed
                }
            });
        }

        function loadKomisyonlar(koordinatorlukId) {
            var $dropdown = $('#filterKomisyon');

            if (!koordinatorlukId) {
                // Disable and Reset
                $dropdown.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true).val(null).trigger('change');
                return;
            }

            $.ajax({
                url: '/BildirimModulu/GetKomisyonlar',
                data: { koordinatorlukId: koordinatorlukId },
                success: function(data) {
                    $dropdown.empty().append('<option value="">Komisyon: Tümü</option>');
                    
                    if (data && data.length > 0) {
                         $.each(data, function(i, item) {
                            var val = item.value || item.Value;
                            var txt = item.text || item.Text;
                            $dropdown.append(new Option(txt, val, false, false));
                        });
                        $dropdown.prop('disabled', false);
                    } else {
                        $dropdown.empty().append('<option value="">Komisyon Yok</option>');
                        $dropdown.prop('disabled', false);
                    }
                    $dropdown.trigger('change');
                },
                error: function() {
                     console.error("Komisyonlar yüklenemedi.");
                }
            });
        }
        
        // --- RENDER TABLE ---
        function renderTable(data) {
            console.log("Tablo render ediliyor:", data ? data.length + " kayıt" : "Veri yok");
            var $tbody = $('#personelTableBody');
            $tbody.empty();

            if (!data || data.length === 0) {
                $tbody.html('<tr><td colspan="5" class="text-center p-4">Kayıt bulunamadı.</td></tr>');
                $('#totalCountBadge').text('0 kişi listelendi');
                return;
            }

            // Update Badge
            $('#totalCountBadge').text(data.length + ' kişi listelendi');

            data.forEach(function(p) {
                // Avatar Logic
                var avatarHtml = '';
                if (p.fotografYolu) {
                    avatarHtml = `<img src="${p.fotografYolu}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">`;
                } else {
                    var initials = getInitials(p.adSoyad);
                    // Generate a consistent color based on char code
                    var colorClass = getColorClass(initials);
                    avatarHtml = `<div class="rounded-circle d-flex align-items-center justify-content-center fw-bold text-white ${colorClass}" style="width: 40px; height: 40px; font-size: 14px;">${initials}</div>`;
                }

                // Column 2: Koordinatörlük / Komisyon (Instead of System Role)
                var birimHtml = '';
                if(p.koordinatorlukler && p.koordinatorlukler.length > 0) {
                     p.koordinatorlukler.forEach(k => {
                        birimHtml += `<div class="badge bg-info text-dark mb-1 d-block text-truncate" style="max-width: 150px;" title="${k}">${k}</div>`;
                     });
                }
                if(p.komisyonlar && p.komisyonlar.length > 0) {
                     p.komisyonlar.forEach(k => {
                        birimHtml += `<div class="badge bg-warning text-dark mb-1 d-block text-truncate" style="max-width: 150px;" title="${k}">${k}</div>`;
                     });
                }
                if(!birimHtml) birimHtml = '<span class="text-muted small">-</span>';
                
                // Column 3: Uzmanlık (Instead of Birimler)
                var uzmanlikHtml = '';
                if(p.uzmanliklar && p.uzmanliklar.length > 0) {
                     p.uzmanliklar.forEach(u => {
                        uzmanlikHtml += `<span class="badge bg-secondary me-1 mb-1">${u}</span>`;
                     });
                } else {
                    uzmanlikHtml = '<span class="text-muted small">-</span>';
                }
                
                var row = `
                    <tr class="personel-card" onclick="toggleSelection(${p.personelId}, this)">
                        <td class="align-middle">
                            <div class="form-check">
                                <input class="form-check-input personel-checkbox" type="checkbox" value="${p.personelId}" onclick="event.stopPropagation(); updateCount();">
                            </div>
                        </td>
                        <td class="align-middle">
                            ${avatarHtml}
                        </td>
                        <td class="align-middle">
                            <div class="fw-bold">${p.adSoyad}</div>
                            <small class="text-muted"><i class="bx bx-map"></i> ${p.sehir}</small>
                        </td>
                        <td class="align-middle">
                            ${birimHtml}
                        </td>
                        <td class="align-middle">
                            ${uzmanlikHtml}
                        </td>
                    </tr>
                `;
                $tbody.append(row);
            });
        }
        
        function getInitials(name) {
            if(!name) return '';
            var names = name.split(' ');
            var initials = names[0].substring(0, 1).toUpperCase();
            if (names.length > 1) {
                initials += names[names.length - 1].substring(0, 1).toUpperCase();
            }
            return initials;
        }

        function getColorClass(str) {
            var colors = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning text-dark', 'bg-info text-dark', 'bg-dark'];
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            var index = Math.abs(hash % colors.length);
            return colors[index];
        }        
        function toggleSelection(id, row) {
            var cb = $(row).find('.personel-checkbox');
            cb.prop('checked', !cb.prop('checked'));
            updateCount();
        }

        function updateCount() {
            var count = $('.personel-checkbox:checked').length;
            $('#selectedCount').text(count);
            
            // Eğer hepsi seçiliyse "Tümünü Seç" kutusunu işaretle, değilse kaldır
            var total = $('.personel-checkbox').length;
            $('#selectAll').prop('checked', total > 0 && count === total);
            
            // Satır stili (opsiyonel)
            $('.personel-card').removeClass('selected');
            $('.personel-checkbox:checked').closest('tr').addClass('selected');
        }

        // --- HELPERS (Sender, Datepicker) ---
        function initSenderSelect() {
            $.get('/BildirimModulu/GetSenders', function(data) {
                var $sel = $('#senderSelect');
                $sel.empty();
                data.forEach(function(s) {
                    $sel.append(new Option(s.ad, s.id));
                });
            });
        }

        function initDatePicker() {
            flatpickr("#scheduleDate", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                minDate: "today",
                time_24hr: true,
                locale: "tr"
            });
        }

        // --- PERSONEL LIST ---
        function loadPersonelList() {
            var search = $('#filterSearch').val();
            // IDs
            // var koordinatorlukId = $('#filterKoordinatorluk').val(); // This might be Name or ID depending on my resolution
            
            // Let's stick to IDs.
            
             var payload = {
                search: search,
                teskilatId: $('#filterTeskilat').val(),
                koordinatorlukId: $('#filterKoordinatorluk').val(),
                komisyonId: $('#filterKomisyon').val(),
                sistemRolId: $('#filterSistemRol').val(),
                kurumsalRolId: $('#filterKurumsalRol').val(),
                
                bransAd: $('#filterBrans').val(),
                yazilimAd: $('#filterYazilim').val(),
                uzmanlikAd: $('#filterUzmanlik').val(),
                gorevTuruAd: $('#filterGorevTuru').val(),
                isNiteligiAd: $('#filterIsNiteligi').val()
            };

            $('#personelTableBody').html('<tr><td colspan="5" class="text-center p-3">Yükleniyor...</td></tr>');

            $.ajax({
                url: '/BildirimModulu/GetPersonelList',
                data: payload,
                success: function(data) {
                    renderTable(data);
                },
                error: function() {
                    $('#personelTableBody').html('<tr><td colspan="5" class="text-center text-danger">Yükleme hatası!</td></tr>');
                }
            });
        }

        function clearFilters() {
            $('#filterSearch').val('');
            $('select').val('').trigger('change');
            
            // Reset cascading
             $('#filterKoordinatorluk').empty().append('<option value="">Önce Teşkilat Seçiniz</option>').prop('disabled', true);
             $('#filterKomisyon').empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true);
             
            loadPersonelList();
        }

        // --- SUBMIT ---
        function submitForm() {
            var recipientIds = [];
            $('.personel-checkbox:checked').each(function() {
                recipientIds.push(parseInt($(this).val()));
            });

            if (recipientIds.length === 0) {
                Swal.fire('Uyarı', 'Lütfen en az bir kişi seçiniz.', 'warning');
                return;
            }

            var senderId = $('#senderSelect').val();
            var title = $('#notifTitle').val();
            var content = $('#notifContent').val();
            var isScheduled = $('#scheduleSwitch').is(':checked');
            var scheduledTime = isScheduled ? $('#scheduleDate').val() : null;

            if (isScheduled && !scheduledTime) {
                Swal.fire('Uyarı', 'Planlanan tarihi seçiniz.', 'warning');
                return;
            }

            var payload = {
                RecipientIds: recipientIds,
                SenderId: senderId,
                Baslik: title,
                Icerik: content,
                ScheduledTime: scheduledTime
            };

            $('#btnSend').prop('disabled', true).html('<i class="bx bx-loader-alt bx-spin"></i> Gönderiliyor...');

            $.ajax({
                url: '/BildirimModulu/SendBulk',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    Swal.fire('Başarılı', isScheduled ? 'Bildirim planlandı.' : 'Bildirimler gönderildi.', 'success')
                        .then(() => {
                           // Reset Form? 
                           $('#notifTitle').val('');
                           $('#notifContent').val('');
                           $('.personel-checkbox').prop('checked', false);
                           updateCount();
                           $('#btnSend').prop('disabled', false).html('<i class="bx bx-paper-plane me-1"></i> Gönder');
                        });
                },
                error: function(xhr) {
                    Swal.fire('Hata', 'Gönderim başarısız: ' + xhr.responseText, 'error');
                    $('#btnSend').prop('disabled', false).html('<i class="bx bx-paper-plane me-1"></i> Gönder');
                }
            });
        }
    </script>
}

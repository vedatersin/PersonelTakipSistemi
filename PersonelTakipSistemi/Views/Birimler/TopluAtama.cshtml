@model PersonelTakipSistemi.ViewModels.TopluAtamaViewModel
@{
    ViewData["Title"] = "Toplu Personel Atama";
}

@section Styles {
    <!-- Select2 -->

    <style>
        .personel-card {
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #e8eaed; /* Darker background by default */
        }
        .personel-card.passive {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .personel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: #dfe1e5;
        }
        .personel-card.selected {
            border-color: #71dd37; /* Success Color */
            background-color: #d1e7dd; /* Light green for selected */
        }
        .check-badge {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background: #71dd37;
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            align-items: center;
            justify-content: center;
        }
        .personel-card.selected .check-badge {
            display: flex;
        }
        .sticky-toolbar {
            position: sticky;
            top: 10px;
            z-index: 100;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            border-radius: 0.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
}

<div class="row">
    <!-- Filters & Action Bar -->
    <div class="col-12 mb-4">
        <div class="card sticky-toolbar">
            <div class="card-body p-3">
                
                <!-- ROW 1: Target Unit Selection -->
                <div class="row g-3 align-items-end mb-3 pb-3 border-bottom">
                     <div class="col-md-3">
                        <label class="form-label small text-uppercase text-muted">Hedef Teşkilat</label>
                        <select id="targetTeskilat" class="form-select">
                            <option value="">Seçiniz</option>
                            @foreach(var t in Model.Teskilatlar) { <option value="@t.TeskilatId">@t.Ad</option> }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-uppercase text-muted">Hedef Koordinatörlük</label>
                        <select id="targetKoordinatorluk" class="form-select" disabled>
                            <option value="">Önce Teşkilat Seçiniz</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                         <label class="form-label small text-uppercase text-muted">Hedef Komisyon</label>
                        <select id="targetKomisyon" class="form-select" disabled>
                            <option value="">Önce Koordinatörlük Seçiniz</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-grid">
                        <button class="btn btn-primary" onclick="submitAssignments()" id="btnSubmit" disabled>
                            <i class='bx bx-check-double me-1'></i> Seçilileri Ekle (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>



            </div>
        </div>
    </div>

    <!-- Personnel Grid -->
    <div class="col-12">
        <div class="row row-cols-1 row-cols-md-4 row-cols-lg-5 g-3" id="personelGrid">
            @foreach(var p in Model.Personeller)
            {
                <div class="col personel-col" data-search="@p.Ad.ToLower() @p.Soyad.ToLower()" data-city="@(p.GorevliIl?.Ad ?? "")">
                    <div class="card h-100 personel-card @(!p.AktifMi ? "passive" : "")" onclick="@(!p.AktifMi ? "" : "toggleSelection(this)")" data-id="@p.PersonelId">
                        <div class="card-body text-center">
                            <div class="check-badge"><i class='bx bx-check'></i></div>
                            
                            @if (!string.IsNullOrEmpty(p.FotografYolu))
                            {
                                <img src="@p.FotografYolu" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="avatar avatar-xl d-flex justify-content-center align-items-center bg-label-secondary rounded-circle mx-auto mb-3" style="width:80px; height:80px; font-size:2rem;">
                                    @p.Ad.Substring(0,1)@p.Soyad.Substring(0,1)
                                </div>
                            }
                            
                            <h6 class="mb-1 text-truncate">@p.Ad @p.Soyad</h6>
                            <small class="text-muted d-block text-truncate">@p.Brans?.Ad</small>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    </div>

    <!-- Sticky Bottom Filter Bar -->
    <div class="col-12 mt-4" style="position: sticky; bottom: 74px; z-index: 1020;">
        <div class="card border-0 shadow-lg rounded-3" style="box-shadow: 0 0 45px rgba(0,0,0,0.30) !important;">
             <div class="card-body p-3 bg-white rounded-3">
                  <div class="row g-3 align-items-center">
                    <!-- Search by Name -->
                    <div class="col-md-5">
                        <div class="input-group input-group-merge">
                             <span class="input-group-text bg-transparent border-end-0"><i class='bx bx-search'></i></span>
                             <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Ad Soyada göre filtrele..." onkeyup="filterPersonnel()">
                        </div>
                    </div>
                    <!-- Filter by City -->
                    <div class="col-md-4">
                        <select id="cityFilter" class="form-select">
                            <option value="">Görevli olduğu ile göre filtrele</option>
                            @{
                                var uniqueCities = Model.Personeller.Where(p => p.GorevliIl != null).Select(p => p.GorevliIl.Ad).Distinct().OrderBy(x => x);
                                foreach(var city in uniqueCities)
                                {
                                    <option value="@city">@city</option>
                                }
                            }
                        </select>
                    </div>
                     <!-- Selected Count Display -->
                    <div class="col-md-3">
                        <div class="badge bg-label-primary w-100 p-3 d-flex align-items-center justify-content-between fs-6">
                            <span><i class='bx bx-check-circle me-2'></i>Seçili Kişi Sayısı:</span>
                            <strong id="selectedCountDisplay">0</strong>
                        </div>
                    </div>
                </div>
             </div>
        </div>
    </div>
</div>

@section Scripts {

    <script>
        // State
        let selectedIds = new Set();
        let targetUnit = { tesId: null, koordId: null, komId: null };

        $(document).ready(function() {
            // Select2 Init
            $('#cityFilter').select2({
                theme: 'bootstrap-5',
                width: '100%', 
                dropdownParent: $('body')
            });

            // Initialize Select2 for Target Dropdowns (Searchable)
            $('#targetTeskilat, #targetKoordinatorluk').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Seçiniz',
                allowClear: true
            });
            
            // Fix Select2 width issue in input-group if needed, or just let it replace.
            
            $('#cityFilter').on('change', function() {
                filterPersonnel();
            });
        });
        
        // Search & Filter Logic
        function filterPersonnel() {
            const nameInput = document.getElementById('searchInput');
            const cityInput = $('#cityFilter').val(); // Use jQuery for Select2 value
            const nameFilter = nameInput.value.toLowerCase();
            const cityFilter = cityInput;

            const items = document.getElementsByClassName('personel-col');

            for (let i = 0; i < items.length; i++) {
                const searchData = items[i].getAttribute('data-search');
                const cityData = items[i].getAttribute('data-city');

                // Check Name Match
                const nameMatch = searchData.includes(nameFilter);
                
                // Check City Match
                const cityMatch = cityFilter === "" || cityData === cityFilter;

                if (nameMatch && cityMatch) {
                    items[i].style.display = ""; // Show
                } else {
                    items[i].style.display = "none"; // Hide
                }
            }
        }

        // Toggle Selection
        function toggleSelection(el) {
            const id = parseInt(el.getAttribute('data-id'));
            
            if(selectedIds.has(id)) {
                selectedIds.delete(id);
                el.classList.remove('selected');
            } else {
                selectedIds.add(id);
                el.classList.add('selected');
            }
            updateUI();
        }

        function updateUI() {
            const count = selectedIds.size;
            $('#selectedCount').text(count); // Update Button Text
            $('#selectedCountDisplay').text(count); // Update new Label in Filter Row
            
            // Enable submit if at least Teskilat selected AND at least 1 person
            const validUnit = targetUnit.tesId || targetUnit.koordId || targetUnit.komId;
            const validIds = count > 0;
            
            $('#btnSubmit').prop('disabled', !(validUnit && validIds));
        }

        // Dropdown Logic
        $('#targetTeskilat').change(function() {
             const id = $(this).val();
             targetUnit.tesId = id; targetUnit.koordId = null; targetUnit.komId = null;

             const $koord = $('#targetKoordinatorluk');
             const $kom = $('#targetKomisyon');
             $koord.empty().append('<option value="">Seçiniz</option>').prop('disabled', true);
             $kom.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true);

             if(id) {
                 $.get('/Birimler/GetKoordinatorlukler?teskilatId=' + id, function(data) {
                     $koord.prop('disabled', false);
                     data.forEach(x => $koord.append(new Option(x.ad, x.koordinatorlukId)));
                 });
             }
             updateUI();
        });

        $('#targetKoordinatorluk').change(function() {
             const id = $(this).val();
             targetUnit.koordId = id; targetUnit.komId = null;

             const $kom = $('#targetKomisyon');
             $kom.empty().append('<option value="">Seçiniz (Opsiyonel)</option>').prop('disabled', true);

             if(id) {
                 $.get('/Birimler/GetKomisyonlar?koordinatorlukId=' + id, function(data) {
                     $kom.prop('disabled', false);
                     data.forEach(x => $kom.append(new Option(x.ad, x.komisyonId)));
                 });
             }
             updateUI();
        });

        $('#targetKomisyon').change(function() {
             targetUnit.komId = $(this).val();
             updateUI();
        });

        function submitAssignments() {
             const payload = {
                 PersonelIds: Array.from(selectedIds),
                 TeskilatId: targetUnit.tesId,
                 KoordinatorlukId: targetUnit.koordId,
                 KomisyonId: targetUnit.komId
             };

             const btn = $('#btnSubmit');
             btn.prop('disabled', true).html('Kaydediliyor...');

             $.ajax({
                url: '/Birimler/YapTopluAtama', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(resp) { 
                    Swal.fire({
                        icon: 'success', 
                        title: 'Tamamlandı', 
                        text: resp.count + ' kişi başarıyla eklendi.',
                        timer: 2000
                    }).then(() => location.reload()); 
                },
                error: function(xhr) { 
                    let errMsg = 'İşlem başarısız.';
                    if (xhr.responseText) {
                         try {
                             // Try parsing as JSON first (if ProblemDetails)
                             const json = JSON.parse(xhr.responseText);
                             errMsg = json.message || json.title || xhr.responseText;
                         } catch(e) {
                             errMsg = xhr.responseText;
                         }
                    }
                    Swal.fire('Uyarı', errMsg, 'warning');
                    btn.prop('disabled', false).html('Tekrar Dene');
                }
            });
        }
    </script>
}

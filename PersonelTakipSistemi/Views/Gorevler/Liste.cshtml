@model IEnumerable<PersonelTakipSistemi.Models.Gorev>

@{
    ViewData["Title"] = "Görevler";
    var kategoriler = ViewBag.Kategoriler as IEnumerable<PersonelTakipSistemi.Models.GorevKategori>;
    
    // Assignment Lists for Filters & Drawer
    var teskilatlar = ViewBag.Teskilatlar as IEnumerable<PersonelTakipSistemi.Models.Teskilat>;
    var koordinatorlukler = ViewBag.Koordinatorlukler as IEnumerable<PersonelTakipSistemi.Models.Koordinatorluk>;
    
    // ViewBag.Komisyonlar is List<SelectListItem> now
    var komisyonlar = ViewBag.Komisyonlar as List<SelectListItem>;
    
    // ViewBag.Personeller is List<SelectListItem>
    var personeller = ViewBag.Personeller as List<SelectListItem>;
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        .select2-container--bootstrap-5 .select2-selection {
            border-color: #ced4da;
        }
    </style>
}

<div class="row">
    <div class="col-12">
        
         <!-- FILTER CARD -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" id="filterForm">
                    <div class="row g-3">
                        <!-- Row 1: Search, Status, Category -->
                        <div class="col-md-4">
                            <label class="form-label">Görev Ara</label>
                            <input type="text" name="q" class="form-control" placeholder="Görev adı veya açıklama..." value="@ViewBag.CurrentSort">
                        </div>
                        <div class="col-md-4">
                             <label class="form-label">Kategori</label>
                             <select name="kategoriId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(kategoriler != null) {
                                    foreach(var k in kategoriler) {
                                        <!option value="@k.GorevKategoriId" @(ViewBag.KategoriId == k.GorevKategoriId ? "selected" : "")>@k.Ad</!option>
                                    }
                                }
                            </select>
                        </div>
                         <div class="col-md-4">
                            <label class="form-label">Durum</label>
                            <select name="durum" class="form-select select2">
                                <option value="">Tümü</option>
                                <!option value="0" @(ViewBag.Durum == 0 ? "selected" : "")>Bekliyor</!option>
                                <!option value="1" @(ViewBag.Durum == 1 ? "selected" : "")>Devam Ediyor</!option>
                                <!option value="2" @(ViewBag.Durum == 2 ? "selected" : "")>Tamamlandı</!option>
                                <!option value="3" @(ViewBag.Durum == 3 ? "selected" : "")>İptal</!option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <!-- Row 2: Assignment Filters -->
                        <div class="col-md-3">
                             <label class="form-label">Teşkilat Atanan</label>
                             <select name="assignedTeskilatId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(teskilatlar != null) {
                                    foreach(var t in teskilatlar) {
                                         <!option value="@t.TeskilatId" @(ViewBag.AssignedTeskilatId == t.TeskilatId ? "selected" : "")>@t.Ad</!option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Koordinatörlük Atanan</label>
                             <select name="assignedKoordinatorlukId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(koordinatorlukler != null) {
                                    foreach(var k in koordinatorlukler) {
                                         <!option value="@k.KoordinatorlukId" @(ViewBag.AssignedKoordinatorlukId == k.KoordinatorlukId ? "selected" : "")>@k.Ad</!option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Komisyon Atanan</label>
                             <select name="assignedKomisyonId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(komisyonlar != null) {
                                    foreach(var k in komisyonlar) {
                                         <!option value="@k.Value" @(ViewBag.AssignedKomisyonId?.ToString() == k.Value ? "selected" : "")>@k.Text</!option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Personel Atanan</label>
                             <select name="assignedPersonelId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(personeller != null) {
                                    foreach(var p in personeller) {
                                         <!option value="@p.Value" @(ViewBag.AssignedPersonelId?.ToString() == p.Value ? "selected" : "")>@p.Text</!option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-1 align-items-end">
                         <!-- Row 3: Action Buttons & Dates -->
                         <!-- Dates could be here, but user didn't explicitly ask for Date *Filter*, just Table column merge. Keeping it simple. -->
                        <div class="col-12 d-flex justify-content-end gap-2">
                             <a href="/Gorevler/Liste" class="btn btn-outline-secondary">Temizle</a>
                             <button type="submit" class="btn btn-primary">Filtrele</button>
                             <a href="/Gorevler/Yeni" class="btn btn-success"><i class="bx bx-plus"></i> Yeni Görev</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- TABLE CARD -->
        <div class="card">
            <div class="table-responsive text-nowrap">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Görev</th>
                            <th>Kategori</th>
                            <th>Atanan Kişi / Birimler</th>
                            <th>Tarih</th>
                            <th>Durum</th>
                            <th class="text-end">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="cursor-pointer" onclick="openAssignmentDrawer(@item.GorevId, '@item.Ad')">
                                <td>
                                    <strong>@item.Ad</strong><br/>
                                    <small class="text-muted">@item.Aciklama</small>
                                </td>
                                <td><span class="badge bg-label-info">@item.Kategori?.Ad</span></td>
                                
                                <!-- ATANAN COLUMN WITH TOGGLE LOGIC -->
                                <td>
                                    @{
                                        var allAssignments = new List<string>();
                                        if (item.GorevAtamaTeskilatlar != null) allAssignments.AddRange(item.GorevAtamaTeskilatlar.Select(x => $"<i class='bx bxs-building'></i> {x.Teskilat.Ad}"));
                                        if (item.GorevAtamaKoordinatorlukler != null) allAssignments.AddRange(item.GorevAtamaKoordinatorlukler.Select(x => $"<i class='bx bxs-business'></i> {x.Koordinatorluk.Ad}"));
                                        
                                         if (item.GorevAtamaKomisyonlar != null) {
                                            allAssignments.AddRange(item.GorevAtamaKomisyonlar.Select(x => $"<i class='bx bxs-group'></i> {x.Komisyon.Ad}" + (x.Komisyon.Koordinatorluk != null ? $" <small class='text-muted'>({x.Komisyon.Koordinatorluk.Ad})</small>" : "")));
                                         }

                                        if (item.GorevAtamaPersoneller != null) allAssignments.AddRange(item.GorevAtamaPersoneller.Select(x => $"<i class='bx bxs-user'></i> {x.Personel.Ad} {x.Personel.Soyad}"));
                                    }

                                    @if (allAssignments.Any())
                                    {
                                        var visibleCount = 2; // Show top 2
                                        if (allAssignments.Count <= visibleCount)
                                        {
                                            <div class="d-flex flex-wrap gap-1">
                                                @foreach (var assign in allAssignments)
                                                {
                                                    <span class="badge bg-label-secondary">@Html.Raw(assign)</span>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="d-flex flex-wrap gap-1">
                                                @for (int i = 0; i < visibleCount; i++)
                                                {
                                                     <span class="badge bg-label-secondary">@Html.Raw(allAssignments[i])</span>
                                                }
                                                <span class="badge bg-primary cursor-pointer show-more-btn" onclick="toggleContainer(this)">...</span>
                                            </div>
                                            <div class="d-none mt-1 extended-container d-flex flex-wrap gap-1">
                                                @for (int i = visibleCount; i < allAssignments.Count; i++)
                                                {
                                                     <span class="badge bg-label-secondary">@Html.Raw(allAssignments[i])</span>
                                                }
                                                <span class="badge bg-secondary cursor-pointer" onclick="toggleContainer(this)">X</span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- DATE COLUMN MERGED -->
                                <td>
                                    <span>@item.BaslangicTarihi.ToString("dd.MM.yyyy")</span>
                                    @if(item.BitisTarihi.HasValue)
                                    {
                                        <br/>
                                        <span class="text-danger small"><i class='bx bx-right-arrow-alt'></i> @item.BitisTarihi.Value.ToString("dd.MM.yyyy")</span>
                                    }
                                </td>

                                <td>
                                    @{
                                        string badgeClass = item.Durum switch { 0 => "bg-warning", 1 => "bg-primary", 2 => "bg-success", 3 => "bg-secondary", _ => "bg-secondary" };
                                        string statusText = item.Durum switch { 0 => "Bekliyor", 1 => "Devam Ediyor", 2 => "Tamamlandı", 3 => "İptal", _ => "Bilinmiyor" };
                                    }
                                    <span class="badge @badgeClass">@statusText</span>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-icon btn-label-primary" onclick="event.stopPropagation(); openAssignmentDrawer(@item.GorevId, '@item.Ad')">
                                        <i class="bx bx-user-plus"></i>
                                    </button>
                                    <a href="/Gorevler/Duzenle/@item.GorevId" class="btn btn-sm btn-icon btn-label-warning" onclick="event.stopPropagation()"><i class="bx bx-edit"></i></a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
             <!-- Pagination (Simplified) -->
             @if (ViewBag.TotalPages > 1) {
                 <div class="card-footer d-flex justify-content-center">
                    <nav>
                        <ul class="pagination">
                            @for(int i=1; i<=ViewBag.TotalPages; i++) {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="?page=@i&q=@ViewBag.CurrentSort">@i</a>
                                </li>
                            }
                        </ul>
                    </nav>
                 </div>
             }
        </div>
    </div>
</div>

<!-- ASSIGNMENT DRAWER (Offcanvas) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="assignmentDrawer" aria-labelledby="drawerLabel" style="width: 500px;">
  <div class="offcanvas-header border-bottom">
    <h5 id="drawerLabel" class="offcanvas-title">Atama Yönetimi</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-3">
        <label class="form-label fw-bold">Görev:</label>
        <div id="drawerTaskName" class="text-primary"></div>
        <input type="hidden" id="drawerTaskId" />
    </div>

    <!-- Add New Assignment Section -->
    <div class="card bg-lighter mb-3">
        <div class="card-body p-3">
            <h6 class="card-title small text-uppercase text-muted">Yeni Atama Ekle</h6>
            
            <!-- Type Selector -->
            <div class="mb-2">
                <select id="assignTypeSelector" class="form-select mb-2">
                    <option value="personel">Personel</option>
                    <option value="teskilat">Teşkilat</option>
                    <option value="koordinatorluk">Koordinatörlük</option>
                    <option value="komisyon">Komisyon</option>
                </select>
            </div>

            <!-- Dynamic Searchable Selects (All hidden initially except default) -->
            
            <!-- Personel Select -->
            <div id="selector-personel" class="entity-selector">
                <select class="form-select select2-drawer" id="drawerSelectPersonel" style="width: 100%;">
                    <option value="">Personel Seçiniz...</option>
                    @if(personeller != null) { foreach(var p in personeller) { <option value="@p.Value">@p.Text</option> } }
                </select>
            </div>
             <!-- Teskilat Select -->
            <div id="selector-teskilat" class="entity-selector d-none">
                <select class="form-select select2-drawer" id="drawerSelectTeskilat" style="width: 100%;">
                    <option value="">Teşkilat Seçiniz...</option>
                     @if(teskilatlar != null) { foreach(var t in teskilatlar) { <option value="@t.TeskilatId">@t.Ad</option> } }
                </select>
            </div>
             <!-- Koordinatorluk Select -->
            <div id="selector-koordinatorluk" class="entity-selector d-none">
                <select class="form-select select2-drawer" id="drawerSelectKoordinatorluk" style="width: 100%;">
                    <option value="">Koordinatörlük Seçiniz...</option>
                     @if(koordinatorlukler != null) { foreach(var k in koordinatorlukler) { <option value="@k.KoordinatorlukId">@k.Ad</option> } }
                </select>
            </div>
             <!-- Komisyon Select -->
            <div id="selector-komisyon" class="entity-selector d-none">
                <select class="form-select select2-drawer" id="drawerSelectKomisyon" style="width: 100%;">
                    <option value="">Komisyon Seçiniz...</option>
                     @if(komisyonlar != null) { foreach(var k in komisyonlar) { <option value="@k.Value">@k.Text</option> } }
                </select>
            </div>

            <button class="btn btn-primary w-100 mt-2" onclick="addAssignment()">Ekle</button>
        </div>
    </div>

    <!-- Current Assignments List -->
    <h6 class="small text-uppercase text-muted">Mevcut Atamalar</h6>
    <ul class="list-group list-group-flush" id="currentAssignmentsList">
        <!-- Loaded via JS -->
    </ul>
  </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Main Filters Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Seçiniz',
                allowClear: true
            });

            // Drawer Select2
            $('.select2-drawer').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#assignmentDrawer'), // Fix Z-Index issue
                width: '100%',
                placeholder: 'Seçiniz'
            });

            // Handle Type Change in Drawer
            $('#assignTypeSelector').change(function() {
                var type = $(this).val();
                $('.entity-selector').addClass('d-none');
                $('#selector-' + type).removeClass('d-none');
            });
        });

        // Toggle Container (Show More/Less)
        function toggleContainer(element) {
            if (event) event.stopPropagation();
            if (element.classList.contains('show-more-btn')) {
                var container = element.parentElement.nextElementSibling;
                if(container) {
                    element.classList.add('d-none');
                    container.classList.remove('d-none');
                }
            } else { // Close X
                var container = element.parentElement;
                var showBtnContainer = container.previousElementSibling;
                var showBtn = showBtnContainer.querySelector('.show-more-btn');
                
                container.classList.add('d-none');
                if(showBtn) showBtn.classList.remove('d-none');
            }
        }

        // Drawer Utils
        var offcanvasElement = document.getElementById('assignmentDrawer');
        var offcanvas = new bootstrap.Offcanvas(offcanvasElement);
        var currentTaskId = 0;

        function openAssignmentDrawer(id, name) {
            currentTaskId = id;
            $('#drawerTaskId').val(id);
            $('#drawerTaskName').text(name);
            loadAssignments(id);
            offcanvas.show();
        }

        function loadAssignments(id) {
            $('#currentAssignmentsList').html('<li class="list-group-item text-center"><div class="spinner-border spinner-border-sm text-primary"></div></li>');
            
            $.get('/Gorevler/GetAssignmentData/' + id, function(data) {
                $('#currentAssignmentsList').empty();
                if(!data || data.length === 0) {
                     $('#currentAssignmentsList').append('<li class="list-group-item text-muted small text-center">Henüz atama yapılmamış.</li>');
                     return;
                }

                data.forEach(function(item) {
                     var icon = 'bx-hash';
                     if(item.type === 'Teskilat') icon = 'bxs-building';
                     if(item.type === 'Koordinatorluk') icon = 'bxs-business';
                     if(item.type === 'Komisyon') icon = 'bxs-group';
                     if(item.type === 'Personel') icon = 'bxs-user';

                     var li = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class='bx ${icon} me-2 text-secondary'></i>
                                <span>${item.name}</span>
                                <br><small class="text-muted ms-4" style="font-size:0.75rem">${item.type}</small>
                            </div>
                            <button class="btn btn-xs btn-outline-danger" onclick="removeAssignment('${item.type}', ${item.id})"><i class="bx bx-trash"></i></button>
                        </li>
                     `;
                     $('#currentAssignmentsList').append(li);
                });
            });
        }

        function addAssignment() {
            var type = $('#assignTypeSelector').val();
            var id = 0;
            
            if(type === 'personel') id = $('#drawerSelectPersonel').val();
            if(type === 'teskilat') id = $('#drawerSelectTeskilat').val();
            if(type === 'koordinatorluk') id = $('#drawerSelectKoordinatorluk').val();
            if(type === 'komisyon') id = $('#drawerSelectKomisyon').val();

            if(!id) {
                alert("Lütfen bir seçim yapınız.");
                return;
            }

            var postData = {
                gorevId: currentTaskId,
                type: type, // 'personel', 'teskilat' etc. (Controller expects lowercase or handles mapping)
                // Controller 'SaveAssignments' expects: gorevId, type, [ids] OR separate calls?
                // Wait, previous SaveAssignments was Bulk Save of ALL IDs. 
                // I need an 'AddSingleAssignment' or adapt 'SaveAssignments'.
                // Let's check Controller's 'SaveAssignments' signature.
                // It accepted arrays: teskilatIds, koordinatorlukIds... 
                // So I should fetch existing, append new, and save? That is race-condition prone.
                // Better: Create a new Action 'AddAssignment' and 'RemoveAssignment' in Phase 2.5/3.
                // Or: Client side logic: Read current list from 'data' variable (need to store it), append, and send full lists. 
                // Let's implement "Client Side Append & Save" for now, or Check Controller.
            };
            
            // To be safe and quick without changing Controller significantly:
            // I will use a Helper JS function to Add Single Assignment by calling Save with specific arrays.
            // Actually, I can just call the existing Save API with *all* current + new.
            // BUT, `GetAssignmentData` returns a flat list. `SaveAssignments` takes 4 arrays.
            // I need to reconstruct the arrays from the current list.
            
            // Re-fetch current data cleanly:
            $.get('/Gorevler/GetAssignmentData/' + currentTaskId, function(currentData) {
                 var payload = {
                     GorevId: currentTaskId,
                     TeskilatIds: [],
                     KoordinatorlukIds: [],
                     KomisyonIds: [],
                     PersonelIds: []
                 };
                 
                 // Fill existing
                 currentData.forEach(i => {
                     if(i.type === 'Teskilat') payload.TeskilatIds.push(i.id);
                     if(i.type === 'Koordinatorluk') payload.KoordinatorlukIds.push(i.id);
                     if(i.type === 'Komisyon') payload.KomisyonIds.push(i.id);
                     if(i.type === 'Personel') payload.PersonelIds.push(i.id);
                 });
                 
                 // Add New
                 if(type === 'teskilat') payload.TeskilatIds.push(parseInt(id));
                 if(type === 'koordinatorluk') payload.KoordinatorlukIds.push(parseInt(id));
                 if(type === 'komisyon') payload.KomisyonIds.push(parseInt(id));
                 if(type === 'personel') payload.PersonelIds.push(parseInt(id));

                 // Send
                 $.ajax({
                     url: '/Gorevler/SaveAssignments',
                     type: 'POST',
                     data: JSON.stringify(payload),
                     contentType: 'application/json; charset=utf-8',
                     success: function(resp) {
                         if(resp.success) {
                             loadAssignments(currentTaskId); // Reload UI
                             // Clear selection
                             $('.select2-drawer').val(null).trigger('change');
                         } else {
                             alert("Hata: " + resp.message);
                         }
                     },
                     error: function(err) {
                         alert("Hata oluştu.");
                     }
                 });
            });
        }

        function removeAssignment(type, id) {
             if(!confirm("Bu atamayı kaldırmak istediğinize emin misiniz?")) return;
             
             // Same logic: Fetch, Remove, Save
             $.get('/Gorevler/GetAssignmentData/' + currentTaskId, function(currentData) {
                 var payload = {
                     GorevId: currentTaskId,
                     TeskilatIds: [],
                     KoordinatorlukIds: [],
                     KomisyonIds: [],
                     PersonelIds: []
                 };
                 
                 currentData.forEach(i => {
                     // logic: if match type & id, skip (don't add to payload)
                     if(i.type === type && i.id === id) return; 

                     if(i.type === 'Teskilat') payload.TeskilatIds.push(i.id);
                     if(i.type === 'Koordinatorluk') payload.KoordinatorlukIds.push(i.id);
                     if(i.type === 'Komisyon') payload.KomisyonIds.push(i.id);
                     if(i.type === 'Personel') payload.PersonelIds.push(i.id);
                 });

                 $.ajax({
                     url: '/Gorevler/SaveAssignments',
                     type: 'POST',
                     data: JSON.stringify(payload),
                     contentType: 'application/json; charset=utf-8',
                     success: function(resp) {
                         if(resp.success) {
                             loadAssignments(currentTaskId);
                         } else {
                             alert("Hata: " + resp.message);
                         }
                     },
                     error: function(err) {
                         alert("Hata oluştu.");
                     }
                 });
            });
        }
        
        // Refresh page on drawer close to show updates in table
        offcanvasElement.addEventListener('hidden.bs.offcanvas', function () {
            location.reload();
        });

    </script>
}

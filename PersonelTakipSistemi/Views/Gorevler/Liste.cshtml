@model IEnumerable<PersonelTakipSistemi.Models.Gorev>

@{
    ViewData["Title"] = "Görevler";
    var kategoriler = ViewBag.Kategoriler as IEnumerable<PersonelTakipSistemi.Models.GorevKategori>;
    
    // Assignment Lists for Filters & Drawer
    var teskilatlar = ViewBag.Teskilatlar as IEnumerable<PersonelTakipSistemi.Models.Teskilat>;
    var koordinatorlukler = ViewBag.Koordinatorlukler as IEnumerable<PersonelTakipSistemi.Models.Koordinatorluk>;
    
    // ViewBag.Komisyonlar is List<SelectListItem> now
    var komisyonlar = ViewBag.Komisyonlar as List<SelectListItem>;
    
    // ViewBag.Personeller is List<SelectListItem>
    var personeller = ViewBag.Personeller as List<SelectListItem>;
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        .select2-container--bootstrap-5 .select2-selection {
            border-color: #ced4da;
        }

        @@keyframes highlightBlue {
            0% { background-color: rgba(13, 110, 253, 0.4); }
            100% { background-color: transparent; }
        }
        
        .highlight-new {
            animation: highlightBlue 3s ease-out;
        }
        
        /* Circular Action Buttons */
        .btn-action-circle {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            font-size: 1.15rem; /* 15% larger icons approximation */
        }
    </style>
}

<div class="row">
    <div class="col-12">
        
         <!-- FILTER CARD -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" id="filterForm">
                    <div class="row g-3">
                        <!-- Row 1: Search, Status, Category -->
                        <div class="col-md-4">
                            <label class="form-label">Görev Ara</label>
                            <input type="text" name="q" class="form-control" placeholder="Görev adı veya açıklama..." value="@ViewBag.CurrentSort">
                        </div>
                        <div class="col-md-4">
                             <label class="form-label">Kategori</label>
                             <select name="kategoriId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(kategoriler != null) {
                                    foreach(var k in kategoriler) {
                                        if (ViewBag.KategoriId == k.GorevKategoriId) {
                                            <option value="@k.GorevKategoriId" selected="selected">@k.Ad</option>
                                        } else {
                                            <option value="@k.GorevKategoriId">@k.Ad</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                             <label class="form-label">Durum</label>
                            <select name="gorevDurumId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(ViewBag.GorevDurumlari != null)
                                {
                                    foreach(var d in ViewBag.GorevDurumlari)
                                    {
                                        if (ViewBag.GorevDurumId == d.GorevDurumId) {
                                            <option value="@d.GorevDurumId" selected="selected">@d.Ad</option>
                                        } else {
                                            <option value="@d.GorevDurumId">@d.Ad</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <!-- Row 2: Assignment Filters -->
                        <div class="col-md-3">
                             <label class="form-label">Teşkilat Atanan</label>
                             <select name="assignedTeskilatId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(teskilatlar != null) {
                                    foreach(var t in teskilatlar) {
                                        if (ViewBag.AssignedTeskilatId == t.TeskilatId) {
                                            <option value="@t.TeskilatId" selected="selected">@t.Ad</option>
                                        } else {
                                            <option value="@t.TeskilatId">@t.Ad</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Koordinatörlük Atanan</label>
                             <select name="assignedKoordinatorlukId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(koordinatorlukler != null) {
                                    foreach(var k in koordinatorlukler) {
                                        if (ViewBag.AssignedKoordinatorlukId == k.KoordinatorlukId) {
                                            <option value="@k.KoordinatorlukId" selected="selected">@k.Ad</option>
                                        } else {
                                            <option value="@k.KoordinatorlukId">@k.Ad</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Komisyon Atanan</label>
                             <select name="assignedKomisyonId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(komisyonlar != null) {
                                    foreach(var k in komisyonlar) {
                                        if (ViewBag.AssignedKomisyonId?.ToString() == k.Value) {
                                            <option value="@k.Value" selected="selected">@k.Text</option>
                                        } else {
                                             <option value="@k.Value">@k.Text</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Personel Atanan</label>
                             <select name="assignedPersonelId" class="form-select select2">
                                <option value="">Tümü</option>
                                @if(personeller != null) {
                                    foreach(var p in personeller) {
                                        if (ViewBag.AssignedPersonelId?.ToString() == p.Value) {
                                            <option value="@p.Value" selected="selected">@p.Text</option>
                                        } else {
                                            <option value="@p.Value">@p.Text</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-1 align-items-end">
                         <!-- Row 3: Action Buttons & Dates -->
                         <!-- Dates could be here, but user didn't explicitly ask for Date *Filter*, just Table column merge. Keeping it simple. -->
                        <div class="col-12 d-flex justify-content-end gap-2">
                             <button type="button" class="btn btn-danger d-none" id="bulkDeleteBtn" onclick="bulkDelete()">
                                <i class="bx bx-trash"></i> Seçilenleri Sil (<span id="selectedCount">0</span>)
                             </button>
                             <a href="/Gorevler/Liste" class="btn btn-outline-secondary">Temizle</a>
                             <button type="submit" class="btn btn-primary">Filtrele</button>
                             <a href="/Gorevler/Yeni" class="btn btn-success"><i class="bx bx-plus"></i> Yeni Görev</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- TABLE CARD -->
        <div class="card">
            <div class="table-responsive text-nowrap">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="form-check-input" id="selectAll">
                            </th>
                            <th>Görev</th>
                            <th>Kategori</th>
                            <th>Atanan Kişi / Birimler</th>
                            <th>Tarih</th>
                            <th>Durum</th>
                            <th class="text-end">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="cursor-pointer" id="row-@item.GorevId" onclick="openAssignmentDrawer(@item.GorevId, '@item.Ad')">
                                <td onclick="event.stopPropagation()">
                                    <input type="checkbox" class="form-check-input select-item" value="@item.GorevId" onchange="updateBulkActionState(event)">
                                </td>
                                <td>
                                    <!-- Link to Detail with stopPropagation -->
                                    <a href="/Gorevler/Detay/@item.GorevId" onclick="event.stopPropagation()" class="fw-bold text-body">@item.Ad</a><br/>
                                    <small class="text-muted">@item.Aciklama</small>
                                </td>
                                <td>
                                    <span class="badge" style="background-color: @(item.Kategori?.Renk ?? "#03c3ec"); color: white;">
                                        @item.Kategori?.Ad
                                    </span>
                                </td>
                                
                                <!-- ATANAN COLUMN WITH TOGGLE LOGIC -->
                                <td>
                                    @{
                                        var allAssignments = new List<string>();
                                        if (item.GorevAtamaTeskilatlar != null) allAssignments.AddRange(item.GorevAtamaTeskilatlar.Select(x => $"<i class='bx bxs-building'></i> {x.Teskilat.Ad}"));
                                        if (item.GorevAtamaKoordinatorlukler != null) allAssignments.AddRange(item.GorevAtamaKoordinatorlukler.Select(x => $"<i class='bx bxs-business'></i> {x.Koordinatorluk.Ad}"));
                                        
                                         if (item.GorevAtamaKomisyonlar != null) {
                                            allAssignments.AddRange(item.GorevAtamaKomisyonlar.Select(x => $"<i class='bx bxs-group'></i> {x.Komisyon.Ad}" + (x.Komisyon.Koordinatorluk != null ? $" <small class='text-muted'>({x.Komisyon.Koordinatorluk.Ad})</small>" : "")));
                                         }

                                        if (item.GorevAtamaPersoneller != null) allAssignments.AddRange(item.GorevAtamaPersoneller.Select(x => $"<i class='bx bxs-user'></i> {x.Personel.Ad} {x.Personel.Soyad}"));
                                    }

                                    @if (allAssignments.Any())
                                    {
                                        var visibleCount = 2; // Show top 2
                                        if (allAssignments.Count <= visibleCount)
                                        {
                                            <div class="d-flex flex-wrap gap-1">
                                                @foreach (var assign in allAssignments)
                                                {
                                                    <span class="badge bg-label-secondary">@Html.Raw(assign)</span>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="d-flex flex-wrap gap-1">
                                                @for (int i = 0; i < visibleCount; i++)
                                                {
                                                     <span class="badge bg-label-secondary">@Html.Raw(allAssignments[i])</span>
                                                }
                                                <span class="badge bg-primary cursor-pointer show-more-btn" onclick="toggleContainer(this)">...</span>
                                            </div>
                                            <div class="d-none mt-1 extended-container d-flex flex-wrap gap-1">
                                                @for (int i = visibleCount; i < allAssignments.Count; i++)
                                                {
                                                     <span class="badge bg-label-secondary">@Html.Raw(allAssignments[i])</span>
                                                }
                                                <span class="badge bg-secondary cursor-pointer" onclick="toggleContainer(this)">X</span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- DATE COLUMN MERGED -->
                                <td>
                                    <span>@item.BaslangicTarihi.ToString("dd.MM.yyyy")</span>
                                    @if(item.BitisTarihi.HasValue)
                                    {
                                        <br/>
                                        <span class="text-danger small"><i class='bx bx-right-arrow-alt'></i> @item.BitisTarihi.Value.ToString("dd.MM.yyyy")</span>
                                    }
                                </td>

                                <td>
                                    @{
                                        string badgeClass = item.GorevDurum?.RenkSinifi ?? "bg-secondary";
                                        string statusText = item.GorevDurum?.Ad ?? "Bilinmiyor";
                                    }
                                    <span class="badge" style="background-color: @(item.GorevDurum?.Renk ?? "#8592a3"); color: white;">@statusText</span>
                                    @if(!string.IsNullOrEmpty(item.DurumAciklamasi)) {
                                        <div class="mt-1">
                                            <i class="bx bx-info-circle text-muted" style="font-size: 0.8rem;"></i>
                                            <small class="text-muted" data-bs-toggle="tooltip" title="@item.DurumAciklamasi">
                                                @(item.DurumAciklamasi.Length > 20 ? item.DurumAciklamasi.Substring(0, 20) + "..." : item.DurumAciklamasi)
                                            </small>
                                        </div>
                                    }
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-info btn-action-circle text-white" data-bs-toggle="tooltip" title="Durum Geçmişi & Güncelle" onclick="event.stopPropagation(); openStatusDrawer(@item.GorevId, @item.GorevDurumId)">
                                        <i class="bx bx-flag"></i>
                                    </button>
                                    <button class="btn btn-warning btn-action-circle text-white" data-bs-toggle="tooltip" title="Yetkilendir" onclick="event.stopPropagation(); openAssignmentDrawer(@item.GorevId, '@item.Ad')">
                                        <i class="bx bx-user-plus"></i>
                                    </button>
                                    <a href="/Gorevler/Duzenle/@item.GorevId" class="btn btn-primary btn-action-circle" data-bs-toggle="tooltip" title="Düzenle" onclick="event.stopPropagation()">
                                        <i class="bx bx-edit"></i>
                                    </a>
                                    <button class="btn btn-danger btn-action-circle" data-bs-toggle="tooltip" title="Sil" onclick="event.stopPropagation(); deleteTask(@item.GorevId)">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
             <!-- Pagination (Smart) -->
             @if (ViewBag.TotalPages > 1) {
                 var currentPage = (int)ViewBag.CurrentPage;
                 var totalPages = (int)ViewBag.TotalPages;
                 var startPage = Math.Max(1, currentPage - 2);
                 var endPage = Math.Min(totalPages, currentPage + 2);

                 <div class="card-footer d-flex justify-content-center">
                    <nav>
                        <ul class="pagination">
                            <!-- Previous -->
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="?page=@(currentPage - 1)&q=@ViewBag.CurrentSort">«</a>
                            </li>

                            <!-- First Page -->
                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?page=1&q=@ViewBag.CurrentSort">1</a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                            }

                            <!-- Page Numbers -->
                            @for(int i = startPage; i <= endPage; i++) {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="?page=@i&q=@ViewBag.CurrentSort">@i</a>
                                </li>
                            }

                            <!-- Last Page -->
                            @if (endPage < totalPages)
                            {
                                @if (endPage < totalPages - 1)
                                {
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                                <li class="page-item">
                                    <a class="page-link" href="?page=@totalPages&q=@ViewBag.CurrentSort">@totalPages</a>
                                </li>
                            }

                            <!-- Next -->
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <a class="page-link" href="?page=@(currentPage + 1)&q=@ViewBag.CurrentSort">»</a>
                            </li>
                        </ul>
                    </nav>
                 </div>
             }
        </div>
    </div>
</div>

<!-- ASSIGNMENT DRAWER (Offcanvas) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="assignmentDrawer" aria-labelledby="drawerLabel" style="width: 500px;">
  <div class="offcanvas-header border-bottom">
    <h5 id="drawerLabel" class="offcanvas-title">Atama Yönetimi</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body p-0">
      <div class="p-3 bg-light border-bottom">
        <label class="form-label fw-bold">Görev:</label>
        <div id="drawerTaskName" class="text-primary fw-semibold"></div>
        <input type="hidden" id="drawerTaskId" />
      </div>

      <!-- TABS -->
      <ul class="nav nav-tabs nav-fill" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabAssignments" type="button"><i class="bx bx-user-pin me-1"></i> Atamalar</button>
        </li>
      </ul>

      <div class="tab-content p-3">
          <!-- TAB 1: ASSIGNMENTS -->
          <div class="tab-pane fade show active" id="tabAssignments">
                <!-- Add New Assignment Section -->
                <div class="card bg-lighter mb-3">
                    <div class="card-body p-3">
                        <h6 class="card-title small text-uppercase text-muted">Yeni Atama Ekle</h6>
                        
                        <!-- Type Selector -->
                        <div class="mb-2">
                            <select id="assignTypeSelector" class="form-select mb-2">
                                <option value="personel">Personel</option>
                                <option value="teskilat">Teşkilat</option>
                                <option value="koordinatorluk">Koordinatörlük</option>
                                <option value="komisyon">Komisyon</option>
                            </select>
                        </div>

                        <!-- Dynamic Searchable Selects (All hidden initially except default) -->
                        <div id="selector-personel" class="entity-selector">
                            <select class="form-select select2-drawer" id="drawerSelectPersonel" style="width: 100%;">
                                <option value="">Personel Seçiniz...</option>
                                @if(personeller != null) { 
                                    foreach(var p in personeller) { 
                                        if (p.Disabled) {
                                            <option value="@p.Value" disabled="disabled">@p.Text</option>
                                        } else {
                                            <option value="@p.Value">@p.Text</option>
                                        }
                                    } 
                                }
                            </select>
                        </div>
                        <div id="selector-teskilat" class="entity-selector d-none">
                            <select class="form-select select2-drawer" id="drawerSelectTeskilat" style="width: 100%;">
                                <option value="">Teşkilat Seçiniz...</option>
                                 @if(teskilatlar != null) { foreach(var t in teskilatlar) { <option value="@t.TeskilatId">@t.Ad</option> } }
                            </select>
                        </div>
                        <div id="selector-koordinatorluk" class="entity-selector d-none">
                            <select class="form-select select2-drawer" id="drawerSelectKoordinatorluk" style="width: 100%;">
                                <option value="">Koordinatörlük Seçiniz...</option>
                                 @if(koordinatorlukler != null) { foreach(var k in koordinatorlukler) { <option value="@k.KoordinatorlukId">@k.Ad</option> } }
                            </select>
                        </div>
                        <div id="selector-komisyon" class="entity-selector d-none">
                            <select class="form-select select2-drawer" id="drawerSelectKomisyon" style="width: 100%;">
                                <option value="">Komisyon Seçiniz...</option>
                                 @if(komisyonlar != null) { foreach(var k in komisyonlar) { <option value="@k.Value">@k.Text</option> } }
                            </select>
                        </div>

                        <button class="btn btn-primary w-100 mt-2" onclick="addAssignment()">Ekle</button>
                    </div>
                </div>

                <!-- Current Assignments List -->
                <h6 class="small text-uppercase text-muted">Mevcut Atamalar</h6>
                <ul class="list-group list-group-flush" id="currentAssignmentsList">
                    <!-- Loaded via JS -->
                </ul>
                
                <div class="mt-4 d-grid gap-2">
                     <button type="button" class="btn btn-primary" onclick="saveAssignments()">Atamaları Kaydet</button>
                </div>
          </div>


      </div>
  </div>
  <div class="offcanvas-footer p-3 border-top d-flex justify-content-end gap-2 bg-light">
      <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="offcanvas">Kapat</button>
  </div>
</div>

</div>

<!-- STATUS HISTORY DRAWER (Offcanvas) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="statusHistoryDrawer" aria-labelledby="statusDrawerLabel" style="width: 500px;">
    <div class="offcanvas-header border-bottom">
        <h5 id="statusDrawerLabel" class="offcanvas-title"><i class='bx bx-history me-2'></i>Görev Durum Geçmişi</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <!-- Update Section -->
        <div class="p-3 border-bottom">
            <h6 class="small text-uppercase text-muted mb-2">Yeni Durum Ekle</h6>
            <input type="hidden" id="drawerStatusGorevId" />
            <div class="mb-2">
                <select id="drawerStatusSelect" class="form-select">
                    @if (ViewBag.GorevDurumlari != null)
                    {
                        foreach (var d in ViewBag.GorevDurumlari)
                        {
                            <option value="@d.GorevDurumId">@d.Ad</option>
                        }
                    }
                </select>
            </div>
            <div class="mb-2">
                <textarea id="drawerStatusNote" class="form-control" rows="2" placeholder="Açıklama..."></textarea>
            </div>
            <button class="btn btn-primary w-100" onclick="submitStatusUpdateDrawer()">Güncelle</button>
        </div>

        <!-- History List -->
        <div class="p-3">
            <h6 class="small text-uppercase text-muted mb-3">Geçmiş Kayıtlar</h6>
            <ul class="timeline" id="statusHistoryList" style="list-style:none; padding-left:0;">
                <!-- Loaded via JS -->
            </ul>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Main Filters Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Seçiniz',
                allowClear: true
            });

            // Drawer Select2
            $('.select2-drawer').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#assignmentDrawer'), // Fix Z-Index issue
                width: '100%',
                placeholder: 'Seçiniz'
            });

            // Handle Type Change in Drawer
            $('#assignTypeSelector').change(function() {
                var type = $(this).val();
                $('.entity-selector').addClass('d-none');
                $('#selector-' + type).removeClass('d-none');
            });
            
            // Check for New Task Highlighting
            var newGorevId = '@TempData["NewGorevId"]';
            if (newGorevId) {
                var row = document.getElementById('row-' + newGorevId);
                if (row) {
                    row.classList.add('highlight-new');
                    // Scroll into view if needed
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Remove class after animation
                    setTimeout(function() {
                        row.classList.remove('highlight-new');
                    }, 3000);
                }
            }
            
            // Tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
        
        // --- BULK ACTION SCRIPTS ---
        document.addEventListener('DOMContentLoaded', function() {
            // Select All handler
            var selectAll = document.getElementById('selectAll');
            if(selectAll) {
                selectAll.addEventListener('change', function() {
                   var checkboxes = document.querySelectorAll('.select-item');
                   var isChecked = this.checked;
                   checkboxes.forEach(function(cb) {
                       cb.checked = isChecked;
                   });
                   updateBulkActionState();
                });
            }
        });

        function updateBulkActionState(e) {
            if(e) e.stopPropagation();
            var selectedCount = document.querySelectorAll('.select-item:checked').length;
            var btn = document.getElementById('bulkDeleteBtn');
            var countSpan = document.getElementById('selectedCount');
            
            if(selectedCount > 0) {
                btn.classList.remove('d-none');
                countSpan.innerText = selectedCount;
            } else {
                btn.classList.add('d-none');
            }
        }

        function bulkDelete() {
            var selectedIds = [];
            document.querySelectorAll('.select-item:checked').forEach(function(cb) {
                selectedIds.push(parseInt(cb.value));
            });

            if (selectedIds.length === 0) return;

            Swal.fire({
                title: 'Toplu Silme',
                text: selectedIds.length + " görev silinecek (pasife alınacak/silinecek). Emin misiniz?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, Sil!',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Gorevler/TopluSil',
                        type: 'POST',
                        data: JSON.stringify(selectedIds),
                        contentType: 'application/json; charset=utf-8',
                        success: function(response) {
                            if (response.success) {
                                Swal.fire('Başarılı', response.message, 'success')
                                .then(() => location.reload());
                            } else {
                                Swal.fire('Hata', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Hata', 'İşlem sırasında bir hata oluştu.', 'error');
                        }
                    });
                }
            });
        }

        // Toggle Container (Show More/Less)
        function toggleContainer(element) {
            if (event) event.stopPropagation();
            if (element.classList.contains('show-more-btn')) {
                var container = element.parentElement.nextElementSibling;
                if(container) {
                    element.classList.add('d-none');
                    container.classList.remove('d-none');
                }
            } else { // Close X
                var container = element.parentElement;
                var showBtnContainer = container.previousElementSibling;
                var showBtn = showBtnContainer.querySelector('.show-more-btn');
                
                container.classList.add('d-none');
                if(showBtn) showBtn.classList.remove('d-none');
            }
        }

        // Drawer Utils
        var offcanvasElement = document.getElementById('assignmentDrawer');
        var offcanvas = new bootstrap.Offcanvas(offcanvasElement);
        var currentTaskId = 0;
        var localAssignments = [];

        function openAssignmentDrawer(id, name) {
            currentTaskId = id;
            $('#drawerTaskId').val(id);
            $('#drawerTaskName').text(name);
            loadAssignments(id);
            offcanvas.show();
        }

        function loadAssignments(id) {
            $('#currentAssignmentsList').html('<li class="list-group-item text-center"><div class="spinner-border spinner-border-sm text-primary"></div></li>');
            localAssignments = []; // Reset

            $.get('/Gorevler/GetAssignmentData/' + id, function(data) {
                if(data) {
                     // Status Fields
                     $('#drawerStatusSelect').val(data.gorevDurumId);
                     $('#drawerStatusNote').val(data.durumAciklamasi);

                     // Flatten object to array
                     if(data.teskilatlar) data.teskilatlar.forEach(function(i) { localAssignments.push({ id: i.id, name: i.name, type: 'Teskilat' }); });
                     if(data.koordinatorlukler) data.koordinatorlukler.forEach(function(i) { localAssignments.push({ id: i.id, name: i.name, type: 'Koordinatorluk' }); });
                     if(data.komisyonlar) data.komisyonlar.forEach(function(i) { localAssignments.push({ id: i.id, name: i.name, type: 'Komisyon' }); });
                     if(data.personeller) data.personeller.forEach(function(i) { localAssignments.push({ id: i.id, name: i.name, type: 'Personel' }); });
                }
                renderAssignments();
            }).fail(function(jqXHR, textStatus, errorThrown) {
                var errorMsg = "Yüklenirken hata oluştu (" + jqXHR.status + " " + errorThrown + ").";
                if(jqXHR.responseJSON && jqXHR.responseJSON.error) {
                    errorMsg += "<br><small>" + jqXHR.responseJSON.error + "</small>";
                } else if (jqXHR.responseText) {
                     // Truncate long HTML responses (like full error pages)
                     var truncated = jqXHR.responseText.substring(0, 100);
                     errorMsg += "<br><small>Raw: " + truncated + "...</small>";
                }
                $('#currentAssignmentsList').html('<li class="list-group-item text-danger text-center">' + errorMsg + '</li>');
            });
        }

        function renderAssignments() {
            $('#currentAssignmentsList').empty();
            if(localAssignments.length === 0) {
                 $('#currentAssignmentsList').append('<li class="list-group-item text-muted small text-center">Henüz atama yapılmamış.</li>');
                 return;
            }

            localAssignments.forEach(function(item) {
                 var icon = 'bx-hash';
                 if(item.type === 'Teskilat') icon = 'bxs-building';
                 if(item.type === 'Koordinatorluk') icon = 'bxs-business';
                 if(item.type === 'Komisyon') icon = 'bxs-group';
                 if(item.type === 'Personel') icon = 'bxs-user';

                 var li = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class='bx ${icon} me-2 text-secondary'></i>
                            <span>${item.name}</span>
                            <br><small class="text-muted ms-4" style="font-size:0.75rem">${item.type}</small>
                        </div>
                        <button class="btn btn-xs btn-outline-danger" onclick="removeAssignment('${item.type}', ${item.id})"><i class="bx bx-trash"></i></button>
                    </li>
                 `;
                 $('#currentAssignmentsList').append(li);
            });
        }

        function addAssignment() {
            var type = $('#assignTypeSelector').val(); 
            var id = 0;
            var name = "";

            if(type === 'personel') { id = $('#drawerSelectPersonel').val(); name = $('#drawerSelectPersonel option:selected').text(); }
            if(type === 'teskilat') { id = $('#drawerSelectTeskilat').val(); name = $('#drawerSelectTeskilat option:selected').text(); }
            if(type === 'koordinatorluk') { id = $('#drawerSelectKoordinatorluk').val(); name = $('#drawerSelectKoordinatorluk option:selected').text(); }
            if(type === 'komisyon') { id = $('#drawerSelectKomisyon').val(); name = $('#drawerSelectKomisyon option:selected').text(); }

            if(!id) {
                Swal.fire({ icon: 'warning', title: 'Uyarı', text: 'Lütfen bir seçim yapınız.' });
                return;
            }

            // Normalize Type
            var typePascal = type.charAt(0).toUpperCase() + type.slice(1);
            if(type === 'koordinatorluk') typePascal = 'Koordinatorluk'; 
            
            var exists = localAssignments.some(function(x) { return x.type == typePascal && x.id == id; });
            if(exists) {
                 Swal.fire({ icon: 'info', title: 'Bilgi', text: 'Bu atama zaten mevcut.' });
                 return;
            }

            localAssignments.push({ id: parseInt(id), name: name, type: typePascal });
            renderAssignments();
            $('.select2-drawer').val(null).trigger('change');
        }

        function removeAssignment(type, id) {
            localAssignments = localAssignments.filter(function(x) { return !(x.type == type && x.id == id); });
            renderAssignments();
        }

        function saveAssignments() {
             var payload = {
                 GorevId: currentTaskId,
                 TeskilatIds: [],
                 KoordinatorlukIds: [],
                 KomisyonIds: [],
                 PersonelIds: []
             };
             
             localAssignments.forEach(function(i) {
                 if(i.type === 'Teskilat') payload.TeskilatIds.push(i.id);
                 if(i.type === 'Koordinatorluk') payload.KoordinatorlukIds.push(i.id);
                 if(i.type === 'Komisyon') payload.KomisyonIds.push(i.id);
                 if(i.type === 'Personel') payload.PersonelIds.push(i.id);
             });

             $.ajax({
                 url: '/Gorevler/SaveAssignments',
                 type: 'POST',
                 data: JSON.stringify(payload),
                 contentType: 'application/json; charset=utf-8',
                 success: function(resp) {
                     if(resp.success) {
                         Swal.fire({ icon: 'success', title: 'Başarılı', text: 'Atamalar kaydedildi.', timer: 1500, showConfirmButton: false });
                         // offcanvas.hide(); // Keep open or hide? User preferred saving.
                         setTimeout(function() { location.reload(); }, 1000); 
                     } else {
                         Swal.fire({ icon: 'error', title: 'Hata', text: 'Kaydedilirken bir hata oluştu.' });
                     }
                 },
                 error: function() {
                     Swal.fire({ icon: 'error', title: 'Hata', text: 'Bir sunucu hatası oluştu.' });
                 }
             });
        }

        function updateStatus() {
            var payload = {
                GorevId: currentTaskId,
                DurumId: $('#drawerStatusSelect').val(),
                Aciklama: $('#drawerStatusNote').val()
            };

            $.ajax({
                 url: '/Gorevler/UpdateStatus',
                 type: 'POST',
                 data: JSON.stringify(payload),
                 contentType: 'application/json; charset=utf-8',
                 success: function(resp) {
                     if(resp.success) {
                         Swal.fire({ icon: 'success', title: 'Başarılı', text: 'Durum güncellendi.', timer: 1500, showConfirmButton: false });
                         setTimeout(function() { location.reload(); }, 1000); 
                     } else {
                         Swal.fire({ icon: 'error', title: 'Hata', text: 'Güncellenirken bir hata oluştu.' });
                     }
                 },
                 error: function() {
                     Swal.fire({ icon: 'error', title: 'Hata', text: 'Bir sunucu hatası oluştu.' });
                 }
             });
        }

        function deleteTask(id) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu görev silinecek (pasife alınacak)!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, sil!',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Gorevler/Sil/' + id, function(resp) {
                         if(resp.success) {
                             Swal.fire('Silindi!', 'Görev başarıyla silindi.', 'success');
                             setTimeout(function() { location.reload(); }, 1000);
                         } else {
                             Swal.fire('Hata!', 'Silinirken bir sorun oluştu.', 'error');
                         }
                    }).fail(function() {
                        Swal.fire('Hata!', 'Sunucu hatası.', 'error');
                    });
                }
            })
        }
        
        // Refresh page on drawer close to show updates in table
        offcanvasElement.addEventListener('hidden.bs.offcanvas', function () {
            location.reload();
        });

// Status History Drawer Logic
        var statusDrawer = new bootstrap.Offcanvas(document.getElementById('statusHistoryDrawer'));

        function openStatusDrawer(id, currentStatusId) {
            $('#drawerStatusGorevId').val(id);
            $('#drawerStatusSelect').val(currentStatusId);
            $('#drawerStatusNote').val('');
            
            loadStatusHistory(id);
            statusDrawer.show();
        }

        function loadStatusHistory(id) {
            $('#statusHistoryList').html('<li class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></li>');
            
            $.get('/Gorevler/GetStatusHistory/' + id, function(data) {
                $('#statusHistoryList').empty();
                if(!data || data.length === 0) {
                    $('#statusHistoryList').html('<li class="text-muted text-center small">Kayıt bulunamadı.</li>');
                    return;
                }

                // If we have data, we can optionally update the main table row immediately (if user opened drawer without changing anything, but data exists)
                // But better to do it on update action.
                
                data.forEach(function(item) {
                    var html = `
                        <li class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">${item.durum}</span>
                                <small class="text-muted">${item.tarih}</small>
                            </div>
                            <div class="d-flex align-items-center mt-1">
                                <div class="avatar avatar-xs me-2" title="${item.personel}">
                                     <span class="avatar-initial rounded-circle bg-label-primary" style="font-size:0.6rem">
                                         ${item.personelAvatar}
                                     </span>
                                </div>
                                <small class="text-muted">${item.personel}</small>
                            </div>
                            ${item.aciklama ? `<div class="mt-2 p-2 bg-lighter rounded small">${item.aciklama}</div>` : ''}
                        </li>
                    `;
                    $('#statusHistoryList').append(html);
                });
            });
        }

        function submitStatusUpdateDrawer() {
            var id = $('#drawerStatusGorevId').val();
            var statusId = $('#drawerStatusSelect').val();
            var note = $('#drawerStatusNote').val();

            $.ajax({
                url: '/Gorevler/UpdateStatus',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ GorevId: id, DurumId: statusId, Aciklama: note }),
                success: function(res) {
                    if(res.success) {
                        // Reload History
                        loadStatusHistory(id);
                        // Reset Note
                        $('#drawerStatusNote').val('');
                        
                        // Update Main Table Row Badge Dynamically
                        // We need the status text and class. 
                        // Quickest way: Find option text in select
                        var statusText = $('#drawerStatusSelect option:selected').text();
                        // We don't have the class in select usually, but let's assume standard or fetch it.
                        // Actually, GetStatusHistory returns the latest color! 
                        // So loadStatusHistory will eventually get it. 
                        // But loadStatusHistory is async. 
                        // Let's rely on reload or just simple update.
                        
                        // Simple update:
                        // Find the row badge
                        var badge = $('#row-' + id).find('.badge');
                        if(badge.length > 0) {
                            badge.removeClass().addClass('badge bg-label-secondary'); // Default
                            // We define colors in View logic, not here generally. 
                            // But we can guess or leave it. 
                            badge.text(statusText);
                            // To get color, we'd need to map IDs to classes in JS.
                            // Or, we can reload page on drawer close.
                        }
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Güncellendi', 
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                        
                        // Mark row as needing refresh or just reload page when drawer closes?
                        // User said "görevleri listeliyosak...". 
                        // Let's just update text for now.
                        
                    } else {
                        Swal.fire('Hata', 'Güncelleme başarısız.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Hata', 'Sunucu hatası.', 'error');
                }
            });
        }
    </script>
}

@model PersonelTakipSistemi.ViewModels.PersonelEkleViewModel
@{
    ViewData["Title"] = "Personel Ekle";
}


@section Styles {
  <link rel="stylesheet" href="~/sevilay-tema/css/personel-ekle.css" />

  <style>
      /* Stepper Reset */
      .tabs { display: none; } /* Hide old tabs */
      
      .stepper-wrapper {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        background: #fff;
        padding: 1rem;
        border-radius: 50px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow-x: auto;
      }
      
      .step-item {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        cursor: pointer;
        min-width: 100px;
        transition: all 0.3s ease;
        opacity: 0.6;
      }
      
      .step-item.active { opacity: 1; }
      .step-item.completed { opacity: 1; }
      
      .step-counter {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f5f5f9;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #697a8d;
        font-size: 1.2rem;
        z-index: 2;
        transition: all 0.3s;
      }
      
      /* Active State (Blue) */
      .step-item.active .step-counter {
        background-color: #0d6efd; /* Bootstrap Primary */
        color: #fff;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.4);
      }
      
      /* Completed State (Green) */
      .step-item.completed .step-counter {
        background-color: #198754; /* Bootstrap Success */
        color: #fff;
      }

      .step-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #566a7f;
        text-align: center;
      }
      .step-sub {
        font-size: 0.7rem;
        color: #a1acb8;
        text-align: center;
        display: block;
      }

      /* Line Connector */
      .step-item::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background-color: #e7e7e8;
        z-index: 1;
      }
      .step-item:last-child::after { display: none; }
      
      /* Active Connector */
      .step-item.completed::after {
        background-color: #198754; 
      }
      
      /* Form Layout Fixes */
      .form-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 0.4rem; color: #566a7f; }
      .form-control, .form-select { border-radius: 0.375rem; padding: 0.5rem 0.875rem; }
      .select2-container .select2-selection--single { height: 38px; border-color: #d9dee3; }
      .select2-container--default .select2-selection--single .select2-selection__arrow { top: 6px; }
      
      /* Photo Upload Area */
      .photo-upload-area {
          display: flex;
          align-items: center;
          gap: 20px;
          padding: 1.5rem;
          background: #f8f9fa;
          border-radius: 0.5rem;
          margin-bottom: 2rem;
      }
      .photo-circle {
          width: 100px;
          height: 100px;
          border-radius: 50%;
          background: #e9ecef;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 2.5rem;
          color: #adb5bd;
          object-fit: cover;
          overflow: hidden;
      }
      .photo-circle img { width: 100%; height: 100%; object-fit: cover; }
      
      /* Custom Checkbox Grid */
      .checkbox-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 1rem;
      }
      .custom-checkbox-card {
          padding: 0.75rem;
          border: 1px solid #e7e7e8;
          border-radius: 0.375rem;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      .custom-checkbox-card:hover { background-color: #f8f9fa; border-color: #d9dee3; }
      
      /* Action Buttons */
      .action-bar {
          display: flex;
          justify-content: flex-end;
          gap: 10px;
          margin-top: 2rem;
          padding-top: 1rem;
          border-top: 1px solid #e7e7e8;
      }
  </style>
}



<div class="tabs-container">

  <!-- STEPPER -->
  <div class="stepper-wrapper">
    <!-- 1. Kişisel -->
    <div class="step-item active" data-step="tab1" onclick="handleStepClick('tab1')">
      <div class="step-counter"><i class='bx bx-user'></i></div>
      <div class="step-name">Kişisel</div>
    </div>
    
    <!-- NEW: Yetkiler -->
    <div class="step-item" data-step="tab_auth" onclick="handleStepClick('tab_auth')">
      <div class="step-counter"><i class='bx bx-shield-quarter'></i></div>
      <div class="step-name">Yetkiler</div>
    </div>
    
    <!-- 2. Beceriler -->
    <div class="step-item" data-step="tab2" onclick="handleStepClick('tab2')">
      <div class="step-counter"><i class='bx bx-grid-alt'></i></div>
      <div class="step-name">Beceriler</div>
      <span class="step-sub">Yazılımlar</span>
    </div>

    <!-- 3. Uzmanlık -->
    <div class="step-item" data-step="tab3" onclick="handleStepClick('tab3')">
      <div class="step-counter"><i class='bx bx-briefcase'></i></div>
      <div class="step-name">Uzmanlık</div>
    </div>

    <!-- 4. Görev Türü -->
    <div class="step-item" data-step="tab4" onclick="handleStepClick('tab4')">
      <div class="step-counter"><i class='bx bx-task'></i></div>
      <div class="step-name">Görev Türü</div>
    </div>

    <!-- 5. İş Niteliği -->
    <div class="step-item" data-step="tab5" onclick="handleStepClick('tab5')">
      <div class="step-counter"><i class='bx bx-file'></i></div>
      <div class="step-name">İş Niteliği</div>
    </div>

    @if(Model.IsEditMode)
    {
         <div class="step-item" data-step="tab_password" onclick="handleStepClick('tab_password')">
           <div class="step-counter"><i class='bx bx-key'></i></div>
           <div class="step-name">Şifre</div>
         </div>
    }

    <!-- 6. Kontrol -->
    <div class="step-item" data-step="tab6" onclick="handleStepClick('tab6')">
      <div class="step-counter"><i class='bx bx-search'></i></div>
      <div class="step-name">Kontrol</div>
    </div>
  </div>

  <form asp-controller="Personel" asp-action="Ekle" method="post" enctype="multipart/form-data">
  @Html.AntiForgeryToken()
   <input type="hidden" asp-for="PersonelId" />
   <input type="hidden" asp-for="AtananRollerJson" id="AtananRollerJson" />
   <input type="hidden" asp-for="IsEditMode" />
   <input type="hidden" asp-for="IsAuthSkipped" id="IsAuthSkipped" />


  <!-- TAB1 KİŞİSEL BİLGİLER -->
  <div id="tab1" class="tab-content active">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Kişisel Bilgiler</h5>
        <div class="text-muted small">* ile işaretli alanlar zorunludur.</div>
      </div>

      <!-- PHOTO AREA -->
      <div class="photo-upload-area">
          <div class="photo-circle" id="previewContainer">
              @{
                  var imgSrc = !string.IsNullOrEmpty(Model.FotografBase64) ? Model.FotografBase64 : Model.FotografYolu;
                  var hasPhoto = !string.IsNullOrEmpty(imgSrc);
              }
              
              @if(hasPhoto)
              {
                   <img id="photoPreview" src="@imgSrc" onerror="this.onerror=null;this.src='/sevilay-tema/assets/img/avatars/1.png';"/>
                   <i class='bx bx-user' style="display:none"></i>
              }
              else
              {
                   <img id="photoPreview" src="" style="display:none" onerror="this.onerror=null;this.src='/sevilay-tema/assets/img/avatars/1.png';"/>
                   <i class='bx bx-user'></i>
              }
          </div>
          <div class="flex-grow-1">
               <label class="form-label">Personel Fotoğrafı</label>
               <input type="file" id="personelFoto" name="personelFoto" accept="image/*" class="form-control" >
               <input type="hidden" id="FotografBase64" name="FotografBase64" asp-for="FotografBase64" />
               <input type="hidden" id="FotografYolu" name="FotografYolu" asp-for="FotografYolu" />
               <small class="text-muted d-block mt-1">JPG veya PNG formatında, maksimum 2MB.</small>
          </div>
      </div>

      <div class="row g-3">
          <!-- LEFT COL -->
          <div class="col-md-6">
               <div class="mb-3">
                   <label asp-for="Ad" class="form-label">Personel Adı *</label>
                   <input type="text" asp-for="Ad" class="form-control" placeholder="Ad" id="personelAdi">
                   <span asp-validation-for="Ad" class="text-danger"></span>
               </div>
               
               <div class="mb-3">
                   <label asp-for="Soyad" class="form-label">Personel Soyadı *</label>
                   <input type="text" asp-for="Soyad" class="form-control" placeholder="Soyad" id="personelSoyadi">
                   <span asp-validation-for="Soyad" class="text-danger"></span>
               </div>

               <div class="mb-3">
                   <label class="form-label">Cinsiyet *</label>
                   <div class="d-flex gap-3 mt-1">
                       <div class="form-check">
                           <input class="form-check-input" type="radio" asp-for="PersonelCinsiyet" id="cinsiyetKadin" value="1">
                           <label class="form-check-label" for="cinsiyetKadin">Kadın</label>
                       </div>
                       <div class="form-check">
                           <input class="form-check-input" type="radio" asp-for="PersonelCinsiyet" id="cinsiyetErkek" value="0">
                           <label class="form-check-label" for="cinsiyetErkek">Erkek</label>
                       </div>
                   </div>
               </div>

               <div class="mb-3">
                   <label asp-for="TcKimlikNo" class="form-label">TC Kimlik No *</label>
                   <input type="text" asp-for="TcKimlikNo" class="form-control" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '')" id="personelTcKimlik">
                   <span asp-validation-for="TcKimlikNo" class="text-danger"></span>
               </div>

               <div class="mb-3">
                   <label asp-for="DogumTarihi" class="form-label">Doğum Tarihi *</label>
                   <input type="date" asp-for="DogumTarihi" class="form-control" min="1900-01-01" max="@DateTime.Now.AddYears(-18).ToString("yyyy-MM-dd")">
                   <span asp-validation-for="DogumTarihi" class="text-danger"></span>
               </div>
               
                <!-- AktifMi Switch: Only Show in Edit Mode or Default Checked -->
                @if(Model.IsEditMode)
                {
                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" asp-for="AktifMi" id="gorevAktif">
                        <label class="form-check-label" for="gorevAktif">Personel Aktif</label>
                    </div>
                }
                else
                {
                    <input type="hidden" asp-for="AktifMi" value="true" />
                }
          </div>

          <!-- RIGHT COL -->
          <div class="col-md-6">
              <div class="mb-3">
                  <label asp-for="Telefon" class="form-label">Telefon *</label>
                  <input type="tel" asp-for="Telefon" class="form-control" id="personeltelefon" placeholder="0 (___) ___ __ __">
                  <span asp-validation-for="Telefon" class="text-danger"></span>
              </div>

              <div class="mb-3">
                  <label asp-for="Eposta" class="form-label">E-posta *</label>
                  <input type="email" asp-for="Eposta" class="form-control" id="personelemail" data-msg-email="Lütfen geçerli bir e-posta adresi giriniz.">
                  <span asp-validation-for="Eposta" class="text-danger"></span>
              </div>

               <div class="mb-3">
                  <label asp-for="GorevliIlId" class="form-label">Görevli İl *</label>
                  <select class="form-select select2" asp-for="GorevliIlId" id="personelgorevli_il">
                      <option value="">Seçiniz...</option>
                      @if(Model.Iller != null) { 
                          foreach(var item in Model.Iller) { <option value="@item.Id">@item.Ad</option> } 
                      }
                  </select>
                  <span asp-validation-for="GorevliIlId" class="text-danger"></span>
              </div>

              <div class="mb-3">
                  <label asp-for="BransId" class="form-label">Branş *</label>
                  <select class="form-select select2" asp-for="BransId" id="personelBrans">
                      <option value="">Seçiniz...</option>
                      @if(Model.Branslar != null) { 
                          foreach(var item in Model.Branslar) { <option value="@item.Id">@item.Ad</option> } 
                      }
                  </select>
                  <span asp-validation-for="BransId" class="text-danger"></span>
              </div>

              <div class="mb-3">
                  <label asp-for="KadroKurum" class="form-label">Kadro Kurum *</label>
                  <input type="text" asp-for="KadroKurum" class="form-control" id="personelKadroKurum">
                  <span asp-validation-for="KadroKurum" class="text-danger"></span>
              </div>
          </div>
      </div>

      <div class="action-bar">
          <button type="button" class="btn btn-outline-secondary" onclick="clearTab1()">Temizle</button>
          <button type="button" class="btn btn-primary px-4" id="next1">İlerle</button>
      </div>
  </div> <!-- /Tab1 -->



                            <!-- 5. Yetkiler Tabı (Auth) -->
                            <div id="tab_auth" class="tab-content">
                                <h4 class="mb-4 text-primary"><i class="fas fa-user-shield me-2"></i>Sistem & Kurumsal Yetkiler</h4>
                                
                                <input type="hidden" id="IsAuthSkipped" name="IsAuthSkipped" value="false" />
                                <input type="hidden" id="AtananRollerJson" name="AtananRollerJson" />

                                <div id="authContentArea">
                                    <div class="row g-4">
                                        <!-- Sol Kolon: Kurumsal Rol Atama -->
                                        <div class="col-md-6">
                                            <div class="card h-100 border-0 shadow-sm">
                                                <div class="card-body">
                                                    <h6 class="card-title text-secondary mb-3">Kurumsal Görevlendirmeler</h6>

                                                    <!-- Ekleme Formu -->
                                                    <div class="d-flex flex-column gap-2 mb-3">
                                                        <select class="form-select select2" id="newRoleTeskilat">
                                                            <option value="">Seçiniz...</option>
                                                            @foreach (var item in Model.Teskilatlar)
                                                            {
                                                                <option value="@item.Id">@item.Ad</option>
                                                            }
                                                        </select>
                                                        
                                                        <div class="d-flex gap-2">
                                                            <select class="form-select select2" id="newRoleKoord" disabled>
                                                                <option>Koordinatörlük</option>
                                                            </select>
                                                            <select class="form-select select2" id="newRoleKom" disabled>
                                                                <option>Komisyon</option>
                                                            </select>
                                                        </div>

                                                        <div class="d-flex gap-2">
                                                            <select class="form-select select2" id="newRoleType">
                                                                <option value="">Rol Seçiniz...</option>
                                                                @foreach (var item in Model.KurumsalRoller)
                                                                {
                                                                    <option value="@item.Id">@item.Ad</option>
                                                                }
                                                            </select>
                                                            <button type="button" class="btn btn-primary text-nowrap" id="btnAddRole">
                                                                <i class="fas fa-plus"></i> Ekle
                                                            </button>
                                                            <button type="button" class="btn btn-secondary text-nowrap d-none" id="btnCancelEditRole" onclick="cancelEditRole()">
                                                                <i class="fas fa-times"></i> Vazgeç
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Liste -->
                                                    <div class="table-responsive" style="max-height: 250px; overflow-y:auto;">
                                                        <table class="table table-hover align-middle mb-0" id="rolesTable">
                                                            <thead class="table-light sticky-top">
                                                                <tr>
                                                                    <th>Rol</th>
                                                                    <th>Birim/Kapsam</th>
                                                                    <th style="width:50px"></th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="assignedRolesBody">
                                                                <tr><td colspan="3" class="text-center text-muted py-3">Henüz rol eklenmedi.</td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sağ Kolon: Sistem Rolü -->
                                        <div class="col-md-6">
                                            <div class="card h-100 border-0 shadow-sm">
                                                <div class="card-body">
                                                    <h6 class="card-title text-secondary mb-3">Sistem Erişimi</h6>
                                                    
                                                    <div class="mb-4">
                                                        <label asp-for="SistemRolId" class="form-label fw-bold">Sistem Rolü</label>
                                                        <select asp-for="SistemRolId" class="form-select select2" id="sistemRolSelect">
                                                            <option value="">Seçiniz...</option>
                                                            @foreach (var item in Model.SistemRolleri)
                                                            {
                                                                <option value="@item.Id">@item.Ad</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="SistemRolId" class="text-danger"></span>
                                                    </div>
                                                    <!-- Yetki Kapsamı Removed -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4 align-items-center">
                                    <div class="d-flex justify-content-start">
                                        @if (!Model.IsEditMode)
                                        {
                                            <button type="button" class="btn btn-outline-warning" id="btnSkipAuth">
                                                <i class="fas fa-fast-forward me-2"></i>Yetkilendirme İşlemini Atla
                                            </button>
                                        }
                                    </div>
                                    <div class="d-flex justify-content-end gap-2">
                                         <button type="button" class="btn btn-outline-secondary" onclick="clearTabAuth()">Temizle</button>
                                         <button type="button" class="btn btn-primary px-4" id="next_auth">İlerle <i class="fas fa-arrow-right ms-2"></i></button>
                                    </div>
                                </div>
                            </div>


  <!-- TAB2 BECERİLER -->
  <div id="tab2" class="tab-content">
    <div class="checkbox-grid">
        @if(Model.Yazilimlar != null)
        {
            @foreach(var item in Model.Yazilimlar)
            {
                <label class="custom-checkbox-card" for="yazilim_@item.Id">
                    <input class="form-check-input m-0" type="checkbox" id="yazilim_@item.Id" value="@item.Id" name="SeciliYazilimIdleri" @(Model.SeciliYazilimIdleri != null && Model.SeciliYazilimIdleri.Contains(item.Id) ? "checked" : "")>
                    <span>@item.Ad</span>
                </label>
            }
        }
    </div>
    <div class="action-bar">
        <button type="button" class="btn btn-outline-secondary" onclick="clearCheckboxes('tab2')">Temizle</button>
        <button type="button" class="btn btn-primary px-4" id="next2">İlerle</button>
    </div>
  </div>

  <!-- TAB3 UZMANLIK -->
  <div id="tab3" class="tab-content">
    <div class="checkbox-grid">
         @if(Model.Uzmanliklar != null)
        {
            @foreach(var item in Model.Uzmanliklar)
            {
                <label class="custom-checkbox-card" for="uzmanlik_@item.Id">
                    <input class="form-check-input m-0" type="checkbox" id="uzmanlik_@item.Id" value="@item.Id" name="SeciliUzmanlikIdleri" @(Model.SeciliUzmanlikIdleri != null && Model.SeciliUzmanlikIdleri.Contains(item.Id) ? "checked" : "")>
                    <span>@item.Ad</span>
                </label>
            }
        }
    </div>
    <div class="action-bar">
        <button type="button" class="btn btn-outline-secondary" onclick="clearCheckboxes('tab3')">Temizle</button>
        <button type="button" class="btn btn-primary px-4" id="next3">İlerle</button>
    </div>
  </div>

<!-- TAB4 GÖREVİ-->
  <div id="tab4" class="tab-content">
    <div class="checkbox-grid">
         @if(Model.GorevTurleri != null)
        {
            @foreach(var item in Model.GorevTurleri)
            {
                <label class="custom-checkbox-card" for="gorev_@item.Id">
                    <input class="form-check-input m-0" type="checkbox" id="gorev_@item.Id" value="@item.Id" name="SeciliGorevTuruIdleri" @(Model.SeciliGorevTuruIdleri != null && Model.SeciliGorevTuruIdleri.Contains(item.Id) ? "checked" : "")>
                    <span>@item.Ad</span>
                </label>
            }
        }
    </div>
    <div class="action-bar">
        <button type="button" class="btn btn-outline-secondary" onclick="clearCheckboxes('tab4')">Temizle</button>
        <button type="button" class="btn btn-primary px-4" id="next4">İlerle</button>
    </div>
  </div>

  <!-- TAB5 Yapılan İş Niteliği -->
  <div id="tab5" class="tab-content">
    <div class="checkbox-grid">
         @if(Model.IsNitelikleri != null)
        {
            @foreach(var item in Model.IsNitelikleri)
            {
                <label class="custom-checkbox-card" for="is_@item.Id">
                     <input class="form-check-input m-0" type="checkbox" id="is_@item.Id" value="@item.Id" name="SeciliIsNiteligiIdleri" @(Model.SeciliIsNiteligiIdleri != null && Model.SeciliIsNiteligiIdleri.Contains(item.Id) ? "checked" : "")>
                     <span>@item.Ad</span>
                </label>
            }
        }
    </div>
    <div class="action-bar">
        <button type="button" class="btn btn-outline-secondary" onclick="clearCheckboxes('tab5')">Temizle</button>
        <button type="button" class="btn btn-primary px-4" id="next5">İlerle</button>
    </div>
  </div>

  <!-- TAB6 Şifre Değiştir (Sadece Edit Modunda) -->
  @if(Model.IsEditMode)
  {
      <div id="tab_password" class="tab-content">
        <h2>Şifre Değiştir</h2>
        <div class="alert alert-warning">
            <i class="bx bx-info-circle"></i> Şifreyi değiştirmek istemiyorsanız bu alanı <strong>boş bırakın</strong>.
        </div>
        
        @if(!User.IsInRole("Admin") && !User.IsInRole("Yönetici"))
        {
            <div class="mb-4">
                <label asp-for="EskiSifre" class="form-label">Eski Şifre</label>
                <input type="password" asp-for="EskiSifre" class="form-control" placeholder="Mevcut şifrenizi girin">
                <span asp-validation-for="EskiSifre" class="text-danger"></span>
                <small class="text-muted">Kendi şifrenizi değiştirirken eski şifrenizi girmeniz gerekmektedir.</small>
            </div>
        }
        <div class="mb-4">
            <label asp-for="NewPassword" class="form-label">Yeni Şifre</label>
            <input type="password" asp-for="NewPassword" class="form-control" placeholder="Yeni şifrenizi girin (min 6 karakter)">
            <span asp-validation-for="NewPassword" class="text-danger"></span>
        </div>
        <div class="mb-4">
            <label asp-for="NewPasswordConfirm" class="form-label">Yeni Şifre (Tekrar)</label>
            <input type="password" asp-for="NewPasswordConfirm" class="form-control" placeholder="Yeni şifreyi tekrar girin">
            <span asp-validation-for="NewPasswordConfirm" class="text-danger"></span>
        </div>
         <button type="button" class="btn btn-primary mt-3" id="next_pass">İlerle</button>
      </div>
  }

  <div id="tab6" class="tab-content">

    <!-- Control Tab Photo Section: Simplified to single image source -->
    <div class="text-center mb-4">
        <div class="photo-preview-container mx-auto" id="controlContainer">
            <i class='bx bx-user' id="controlIcon"></i>
            <img id="kontrolFoto" src="" alt="Personel Fotoğrafı" style="display:none;" onerror="this.onerror=null;this.src='/sevilay-tema/assets/img/avatars/1.png';"/>
        </div>
        <p class="mt-2 fw-bold">Personel Fotoğrafı</p>
    </div>

    <div class="row">
        <div class="col-md-6">
             <h6 class="text-muted border-bottom pb-2 mb-3">Kişisel Bilgiler</h6>
             <table class="table table-bordered table-sm">
                <tbody id="kontrolTableBodyLeft"></tbody>
             </table>
        </div>
        <div class="col-md-6">
             <h6 class="text-muted border-bottom pb-2 mb-3">Yetkinlikler & Görev</h6>
             <table class="table table-bordered table-sm">
                <tbody id="kontrolTableBodyRight"></tbody>
             </table>
        </div>
    </div>

    <!-- ROLES SECTION (Full Width) -->
    <div class="row mt-4">
        <div class="col-12">
             <h6 class="text-muted border-bottom pb-2 mb-3">Sistem & Kurumsal Roller</h6>
             <table class="table table-bordered table-sm">
                <tbody id="kontrolTableBodyRoles"></tbody>
             </table>
        </div>
    </div>

  <div class="d-grid gap-2 mt-4">
    <button type="submit" class="btn btn-success btn-lg">@(Model.IsEditMode ? "Bilgileri Güncelle" : "Bilgileri Kaydet")</button>
  </div>

  </div>

  </form>
  <!-- Modal: Duplicate Error (TC & Email) -->
  <div class="modal fade" id="tcDuplicateModal" tabindex="-1" aria-labelledby="tcDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="tcDuplicateModalLabel">
              @if(TempData["ModalTitle"] != null) { @TempData["ModalTitle"] } 
              else { <text>Kayıt Hatası</text> }
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            @if(TempData["ModalItems"] != null)
            {
                <ul>
                    @foreach(var item in TempData["ModalItems"].ToString().Split('|'))
                    {
                        <li>@item</li>
                    }
                </ul>
            }
            else if(TempData["TcDuplicateError"] != null)
            {
                 <p>@TempData["TcDuplicateError"]</p>
            }
            else
            {
                 <p>Benzer bir kayıt sistemde zaten mevcut.</p>
            }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnFixTc">Tamam (Düzelt)</button>
        </div>
      </div>
    </div>
  </div>

</div> <!-- /tabs-container -->

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <script>
        // --- 1. GLOBAL STATE & CONFIGURATION (CRITICAL: Must run first) ---
        
        // Robust Edit Mode Detection
        // We check the hidden input strictly, fallback to Model value.
        var isEditMode = false;
        try {
            var hiddenVal = document.querySelector('input[name="IsEditMode"]')?.value;
            if(hiddenVal === "True" || hiddenVal === "true") isEditMode = true;
            else if (@(Model.IsEditMode.ToString().ToLowerInvariant())) isEditMode = true;
        } catch(e) { console.error("EditMode detect error", e); }
        
        console.log("Wizard Initialized. Mode:", isEditMode ? "EDIT" : "CREATE");

        // State Container
        window.wizardState = {
            unlockedTabs: new Set(["tab1"]),
            // Standard Tab Order
            tabOrder: ["tab1", "tab_auth", "tab2", "tab3", "tab4", "tab5", "tab6"],
            assignedRoles: @Html.Raw(Model.AtananRollerJson ?? "[]")
        };

        // Edit Mode: Unlock All Tabs Immediately
        if (isEditMode) {
             // Add password tab if needed
             if (!window.wizardState.tabOrder.includes("tab_password")) {
                 const idx = window.wizardState.tabOrder.indexOf("tab6");
                 if(idx > -1) window.wizardState.tabOrder.splice(idx, 0, "tab_password");
             }
             // Unlock all
             window.wizardState.tabOrder.forEach(t => window.wizardState.unlockedTabs.add(t));
        }

        // --- 2. GLOBAL NAVIGATION HANDLERS (Must be available for onclick) ---
        
        window.handleStepClick = function (tabId) {
            // Safety check
            if(!window.wizardState) { console.error("Wizard State not ready"); return; }
            activateTab(tabId);
        };

        window.activateTab = function(tabId) {
            // Permission Check
            if (!window.wizardState.unlockedTabs.has(tabId) && !isEditMode) {
                // Double check isEditMode in case strictly unlocked
                console.warn("Tab locked:", tabId);
                return;
            }

            // 1. Toggle Content
            const contents = document.querySelectorAll(".tab-content");
            contents.forEach(c => {
                 // Use direct style/class manipulation for speed
                 const isActive = c.id === tabId;
                 c.classList.toggle("active", isActive);
                 // c.style.display = isActive ? 'block' : 'none'; // Optional: Use CSS class for cleaner handling
            });

            // 2. Update Stepper UI
            updateStepperUI(tabId);

            // 3. Tab Specific Logic
            if (tabId === "tab6") {
                if(typeof fillKontrolOzet === 'function') fillKontrolOzet();
                if(typeof updateControlPhoto === 'function') updateControlPhoto();
            }
        };


        window.updateStepperUI = function(activeTabId) {
            const buttons = document.querySelectorAll(".step-item");
            buttons.forEach(btn => {
                const stepId = btn.getAttribute("data-step");
                
                // Reset basic state
                btn.classList.remove("active", "completed");
                btn.style.opacity = "0.6"; 

                // Determine Highlighting
                const isUnlocked = window.wizardState.unlockedTabs.has(stepId);
                const isActive = stepId === activeTabId;

                if (isEditMode) {
                    // Edit Mode: All unlocked/visible are technically 'completed'/'accessible'
                    // Just highlight active one specifically
                    btn.classList.add("completed"); 
                    btn.style.opacity = "1";
                    
                    if (isActive) {
                         btn.classList.add("active");
                    }
                } else {
                    // Create Mode
                    if (isActive) {
                        btn.classList.add("active");
                        btn.style.opacity = "1";
                    } else if (isUnlocked) {
                        btn.classList.add("completed");
                        btn.style.opacity = "1";
                    }
                }
            });
        };


        function fillKontrolOzet() {
             const leftBody = document.getElementById("kontrolTableBodyLeft");
             const rightBody = document.getElementById("kontrolTableBodyRight");
             if (!leftBody || !rightBody) return;
             
             leftBody.innerHTML = ""; 
             rightBody.innerHTML = "";

             const addRow = (targetBody, label, value) => {
                 const tr = document.createElement("tr");
                 tr.innerHTML = `<td style="width:40%; font-weight:600;">${label}</td><td>${value && value.trim() !== "" ? value : "-"}</td>`;
                 targetBody.appendChild(tr);
             };

             // --- SOL ---
             const ad = document.getElementById("personelAdi")?.value || "";
             const soyad = document.getElementById("personelSoyadi")?.value || "";
             addRow(leftBody, "Ad Soyad", `${ad} ${soyad}`);
             addRow(leftBody, "TC Kimlik No", document.getElementById("personelTcKimlik")?.value);
             addRow(leftBody, "Telefon", document.getElementById("personeltelefon")?.value);
             addRow(leftBody, "E-posta", document.getElementById("personelemail")?.value);
             
             let cinsiyet = "-";
             if (document.getElementById("cinsiyetKadin")?.checked) cinsiyet = "Kadın";
             else if (document.getElementById("cinsiyetErkek")?.checked) cinsiyet = "Erkek";
             addRow(leftBody, "Cinsiyet", cinsiyet);

             const aktifMi = document.getElementById("gorevAktif")?.checked ? "Aktif" : "Pasif";
             addRow(leftBody, "Durum", aktifMi);

             // --- SAĞ ---
             addRow(rightBody, "Kadro Kurum", document.getElementById("personelKadroKurum")?.value);

             const gorevliIl = document.getElementById("personelgorevli_il");
             if (gorevliIl && gorevliIl.selectedIndex > 0) {
                  addRow(rightBody, "Görevli İl", gorevliIl.options[gorevliIl.selectedIndex].text);
             } else {
                  addRow(rightBody, "Görevli İl", "-");
             }

             const brans = document.getElementById("personelBrans");
             if (brans && brans.selectedIndex > 0) {
                 addRow(rightBody, "Branş", brans.options[brans.selectedIndex].text);
             } else {
                  addRow(rightBody, "Branş", "-");
             }

             const getLabels_ = (name) => {
                const checkedInputs = document.querySelectorAll(`input[name="${name}"]:checked`);
                if (checkedInputs.length === 0) return "-";
                const labels = [];
                checkedInputs.forEach(input => {
                     // Check parent label or custom card
                     const parent = input.closest('.custom-checkbox-card');
                     if(parent) {
                         labels.push(parent.querySelector('span').innerText);
                     } else {
                         // Fallback
                         const labelEl = document.querySelector(`label[for="${input.id}"]`);
                         if(labelEl) labels.push(labelEl.textContent.trim());
                     }
                });
                return labels.join(", ");
             };

             addRow(rightBody, "Beceriler", getLabels_("SeciliYazilimIdleri"));
             addRow(rightBody, "Uzmanlıklar", getLabels_("SeciliUzmanlikIdleri"));
             addRow(rightBody, "Görev Türü", getLabels_("SeciliGorevTuruIdleri"));
             addRow(rightBody, "İş Niteliği", getLabels_("SeciliIsNiteligiIdleri"));

             // --- ROLES (NEW SECTION) ---
             const rolesBody = document.getElementById("kontrolTableBodyRoles");
             if(rolesBody) {
                 rolesBody.innerHTML = "";
                 
                 // 1. Sistem Rolü
                 let sistemRolText = $("#sistemRolSelect option:selected").text();
                 const sysVal = $("#sistemRolSelect").val();
                 if(!sysVal || sysVal === "") {
                     const isSkipped = $('#IsAuthSkipped').val() === 'true';
                     sistemRolText = isSkipped ? "Standart Kullanıcı (Atlandı)" : "-";
                 }
                 // Add Row to Roles Table
                 const trSys = document.createElement("tr");
                 trSys.innerHTML = `<td style="width:20%; font-weight:600;">Sistem Rolü</td><td>${sistemRolText}</td>`;
                 rolesBody.appendChild(trSys);

                 // 2. Kurumsal Roller
                 let kRollerHtml = "-";
                 if(wizardState.assignedRoles && wizardState.assignedRoles.length > 0) {
                     kRollerHtml = wizardState.assignedRoles.map(r => {
                          let loc = r.teskilatAd || "";
                          if(r.koordinatorlukAd) loc += ` > ${r.koordinatorlukAd}`;
                          if(r.komisyonAd) loc += ` > ${r.komisyonAd}`;
                          
                          let roleDisplay = r.rolAd;
                          let styleClass = "";
                          if(r.isImplicit === true || r.rolAd === "") {
                              roleDisplay = "<span class='text-danger'>(Rolü Yok)</span>";
                              styleClass = "border-start border-3 border-danger ps-2";
                          }
                          
                          return `<div class='mb-2 ${styleClass}'><strong>${roleDisplay}</strong> <br><small class='text-muted'>${loc}</small></div>`;
                     }).join("");
                 }
                 
                 const trCorp = document.createElement("tr");
                 trCorp.innerHTML = `<td style="width:20%; font-weight:600;">Kurumsal Roller</td><td>${kRollerHtml}</td>`;
                 rolesBody.appendChild(trCorp);
             }
        }

        // --- Role Management State ---
        let editingRoleIndex = null;

        // --- Role Render Logic ---
        function renderRoles() {
            const container = document.getElementById('assignedRolesBody');
            if(!container) return; 
            
            container.innerHTML = '';
            
            if(wizardState.assignedRoles.length === 0) {
                 container.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Henüz rol eklenmedi.</td></tr>';
                 // Explicitly set empty array for backend deletion logic
                 const jsonInput = document.getElementById('AtananRollerJson');
                 if(jsonInput) jsonInput.value = '[]'; 
                 // Also update control summary if needed
                 if(typeof fillKontrolOzet === 'function') fillKontrolOzet();
                 return;
            }

            wizardState.assignedRoles.forEach((role, idx) => {
                const tr = document.createElement('tr');
                
                let ctx = role.teskilatAd || "";
                if(role.koordinatorlukAd) ctx += ` > ${role.koordinatorlukAd}`;
                if(role.komisyonAd) ctx += ` > ${role.komisyonAd}`;

                const isImplicit = role.isImplicit === true || role.rolAd === "";
                let roleNameDisplay = role.rolAd;
                let roleStyle = "fw-bold text-dark small";

                if (isImplicit) {
                    roleNameDisplay = "<span class='text-danger'>(Rolü Yok)</span>";
                    tr.classList.add("border", "border-danger");
                }



                let isLegacy = !role.teskilatAd && !role.koordinatorlukAd && !role.komisyonAd;
                if(isLegacy) {
                     ctx = "<i class='bx bx-error-circle'></i> <em>Kapsam Belirtilmemiş (Eski Kayıt)</em>";
                }
                
                // Highlight row being edited
                if(editingRoleIndex === idx) {
                    tr.classList.add("table-primary");
                }

                tr.innerHTML = `
                    <td>
                        <div class="${roleStyle}">${roleNameDisplay}</div>
                    </td>
                    <td>
                        <div class="text-muted" style="font-size:0.75rem">${ctx}</div>
                    </td>
                    <td class="text-end">
                        <button type="button" class="btn btn-icon btn-sm text-primary me-1" onclick="editRole(${idx})" title="Düzenle" style="transform: scale(1.1);">
                            <i class='bx bx-edit-alt'></i>
                        </button>
                        <button type="button" class="btn btn-icon btn-sm text-danger" onclick="removeRole(${idx})" title="Sil" style="transform: scale(1.1);">
                            <i class='bx bx-trash'></i>
                        </button>
                    </td>`;
                container.appendChild(tr);
            });
            
            // Sync Hidden Input
            const jsonInput = document.getElementById('AtananRollerJson');
            if(jsonInput) jsonInput.value = JSON.stringify(wizardState.assignedRoles);
            
            // Re-render Control Tab Summary if needed
            if(typeof fillKontrolOzet === 'function') fillKontrolOzet();
        }

        window.removeRole = function(index) {
            if(confirm("Bu rolü silmek istediğinize emin misiniz?")) {
                if(editingRoleIndex === index) cancelEditRole();
                wizardState.assignedRoles.splice(index, 1);
                renderRoles();
            }
        };

        window.editRole = async function(index) {
            const role = wizardState.assignedRoles[index];
            editingRoleIndex = index;
            
            console.group("Edit Role Debug");
            console.log("Editing Role Object:", role);

            // Re-render (highlighting)
            renderRoles();
            
            // Set Flag to suppress default change handlers
            window.isEditingCascade = true;

            try {
                // 1. Teskilat
                if(role.teskilatId) {
                    const $tes = $('#newRoleTeskilat');
                    
                    // Verify Option Exists
                    const tesVal = String(role.teskilatId);
                    if($tes.find(`option[value="${tesVal}"]`).length === 0) {
                        console.warn(`Teskilat ID ${tesVal} not found in options!`, $tes.html());
                        alert(`Hata: Teşkilat ID (${tesVal}) listede bulunamadı!`);
                    } else {
                        console.log(`Setting Teskilat to ${tesVal}`);
                        $tes.val(tesVal).trigger('change.select2');
                    }
                    
                    // Filter Roles based on Teskilat immediately
                    if(window.updateRoleOptions) window.updateRoleOptions(role.teskilatId);

                    // 2. Load Koordinatorluk
                    if(window.loadKoordinatorlukler) {
                        try {
                            await window.loadKoordinatorlukler(role.teskilatId, role.koordinatorlukId);
                            console.log("Loaded Koordinatorluk for:", role.teskilatId);
                            
                            // Check if value was set (it should be set inside loadKoordinatorlukler)
                            const currentKoord = $('#newRoleKoord').val();
                            if(role.koordinatorlukId && String(currentKoord) !== String(role.koordinatorlukId)) {
                                console.warn(`Failed to set Koordinatorluk ID ${role.koordinatorlukId}. Current val: ${currentKoord}`);
                                // Retry manual set just in case? Or alert?
                                // alert(`Uyarı: Koordinatörlük ID (${role.koordinatorlukId}) listede yok!`);
                            }
                        } catch(err) { console.error("Error loading Koord", err); }
                    }

                    // 3. Load Komisyon
                    if(role.koordinatorlukId && window.loadKomisyonlar) {
                        try {
                            await window.loadKomisyonlar(role.koordinatorlukId, role.komisyonId);
                            console.log("Loaded Komisyon for:", role.koordinatorlukId);
                            
                            const currentKom = $('#newRoleKom').val();
                            if(role.komisyonId && String(currentKom) !== String(role.komisyonId)) {
                                console.warn(`Failed to set Komisyon ID ${role.komisyonId}. Current val: ${currentKom}`);
                            }
                        } catch(err) { console.error("Error loading Kom", err); }
                    }
                }
            } catch(e) {
                console.error("Edit cascade failed", e);
            } finally {
                window.isEditingCascade = false;
                console.groupEnd();
            }

            // Role Select
            const $roleType = $('#newRoleType');
            if(role.rolId && role.rolId !== "0" && role.rolId !== "") {
                const rVal = String(role.rolId);
                if($roleType.find(`option[value="${rVal}"]`).length > 0) {
                    $roleType.val(rVal).trigger('change.select2');
                } else {
                    console.warn(`Role ID ${rVal} not found in options!`);
                }
            } else {
                $roleType.val(null).trigger('change.select2');
            }
            
            // Update Buttons
            $('#btnAddRole').html('<i class="bx bx-save me-1"></i>Güncelle').removeClass('btn-primary').addClass('btn-warning');
            $('#btnCancelEditRole').removeClass('d-none');

            // Scroll to Form
            document.querySelector('#newRoleTeskilat').scrollIntoView({behavior: 'smooth'});
        };
        
        window.cancelEditRole = function() {
            editingRoleIndex = null;
            
            // Reset Form (Clear values)
            $('#newRoleTeskilat').val('').trigger('change.select2'); // Ensure select2 trigger
            $('#newRoleKoord').val('').empty().append('<option>Koordinatörlük</option>').prop('disabled', true).trigger('change.select2');
            $('#newRoleKom').val('').empty().append('<option>Komisyon</option>').prop('disabled', true).trigger('change.select2');
            $('#newRoleType').val('').trigger('change.select2');
            
            // Reset Buttons
            $('#btnAddRole').html('<i class="bx bx-plus-circle me-1"></i>Ekle').removeClass('btn-warning').addClass('btn-primary');
            $('#btnCancelEditRole').addClass('d-none');
            
            renderRoles();
        };

        // --- Add/Update Role ---
        $('#btnAddRole').on('click', function() {
             const tesSelect = document.getElementById('newRoleTeskilat');
             const koordSelect = document.getElementById('newRoleKoord');
             const komSelect = document.getElementById('newRoleKom');
             const rolSelect = document.getElementById('newRoleType');
             
             // Validation Logic
             if(!rolSelect.value || !tesSelect.value) {
                 Swal.fire('Uyarı', 'Teşkilat ve Rol seçimi zorunludur.', 'warning');
                 return;
             }
             
             const data = {
                   rolId: rolSelect.value,
                   rolAd: rolSelect.options[rolSelect.selectedIndex].text,
                   teskilatId: tesSelect.value,
                   teskilatAd: tesSelect.options[tesSelect.selectedIndex].text,
                   koordinatorlukId: koordSelect.value || null,
                   koordinatorlukAd: koordSelect.selectedIndex > 0 ? koordSelect.options[koordSelect.selectedIndex].text : null,
                   komisyonId: komSelect.value || null,
                   komisyonAd: komSelect.selectedIndex > 0 ? komSelect.options[komSelect.selectedIndex].text : null
             };
             
             // Add or Update logic
             if(editingRoleIndex !== null) {
                 wizardState.assignedRoles[editingRoleIndex] = data;
                 Swal.fire({ position: 'top-end', icon: 'success', title: 'Rol güncellendi', showConfirmButton: false, timer: 1500 });
                 
                 // Reset UI (Cancel Mode)
                 cancelEditRole();
             } else {
                 wizardState.assignedRoles.push(data);
                 
                 // Just Clear Inputs (Reuse cancelEditRole logic as it clears everything and resets state)
                 cancelEditRole(); 
             }
        });


        // --- Photo Logic ---
        function updateControlPhoto() {
            const previewImg = document.getElementById("photoPreview");
            const controlImg = document.getElementById("kontrolFoto");
            const controlIcon = document.getElementById("controlIcon");

            if (!controlImg) return;
            
            // Sync logic
            if (previewImg && previewImg.src && previewImg.style.display !== "none" && previewImg.src !== "" && previewImg.src !== window.location.href) {
                 controlImg.src = previewImg.src;
                 controlImg.style.display = "block";
                 if(controlIcon) controlIcon.style.display = "none";
            } 
            else {
                 controlImg.style.display = "none";
                 if(controlIcon) controlIcon.style.display = "block";
            }
        }

        function restorePhotoFromHidden() {
            const hiddenBase64 = document.getElementById("FotografBase64");
            const hiddenYolu = document.getElementById("FotografYolu");
            const previewImg = document.getElementById("photoPreview");
            
            // Priority: Base64 (New Upload) > Yolu (Existing)
            let src = "";
            if(hiddenBase64 && hiddenBase64.value) src = hiddenBase64.value;
            else if(hiddenYolu && hiddenYolu.value) src = hiddenYolu.value;

            if(src && previewImg) {
                previewImg.src = src;
                
                // Show it
                const container = previewImg.parentElement;
                const icon = container.querySelector("i");
                if(icon) icon.style.display = "none";
                previewImg.style.display = "block";
            }
        }


        // --- Clear Handlers ---
        // --- Clear Handlers ---
        window.clearTab1 = function() {
            const inputs = document.querySelectorAll('#tab1 input:not([type="hidden"]):not([type="radio"])');
            inputs.forEach(i => i.value = "");
            $('#personelgorevli_il').val(null).trigger('change');
            $('#personelBrans').val(null).trigger('change');
            
            // Explicitly Reset ID and EditMode for "New Record" Intent
            $('input[name="PersonelId"]').val(0);
            $('input[name="IsEditMode"]').val('False');
            
            // Reset Photo
            const preview = document.getElementById("photoPreview");
            const icon = document.querySelector("#previewContainer i");
            if(preview) { preview.src = ""; preview.style.display = 'none'; }
            if(icon) icon.style.display = 'block';
            document.getElementById("personelFoto").value = "";
        };

        window.clearCheckboxes = function(tabId) {
             const container = document.getElementById(tabId);
             if(!container) return;
             const checkboxes = container.querySelectorAll('input[type="checkbox"]');
             checkboxes.forEach(cb => cb.checked = false);
        };

        window.clearTabAuth = function() {
             $('#sistemRolSelect').val('').trigger('change.select2');
             $('input[name="YetkiKapsami"][value="Self"]').prop('checked', true);
             
             wizardState.assignedRoles = [];
             renderRoles();
             
             $('#newRoleTeskilat').val('').trigger('change.select2');
             $('#newRoleType').val('').trigger('change.select2');
        };


        // --- 3. DOM READY INITIALIZATION ---
        $(document).ready(function() {
             // A. Init UI Components
             updateStepperUI("tab1"); // Default active
             renderRoles();
             restorePhotoFromHidden();

             // B. Input Masks & Plugins
             $('.select2').select2({
                 width: '100%', allowClear:true, placeholder: 'Seçiniz...',
                 language: { noResults: () => "Sonuç bulunamadı" }
             });
             
             $('#personeltelefon').inputmask({
                 mask: "0 (999) 999 99 99", showMaskOnHover: false, clearIncomplete: false
             });

             // Validate on Change
             $('.select2').on('change', function() { $(this).valid(); });

             // C. Validation Override (Password UX)
             var form = $('form');
             var validator = form.data('validator');
             if(validator) {
                  var defaultOnFocusOut = validator.settings.onfocusout;
                  var defaultOnKeyUp = validator.settings.onkeyup;
                  validator.settings.onfocusout = function(element) {
                      if (element.type === "password" || element.id === "personeltelefon") return;
                      if (defaultOnFocusOut) defaultOnFocusOut.call(this, element);
                  };
                  validator.settings.onkeyup = function(element, event) {
                       if (element.type === "password") {
                            // Check mismatch manually
                            var p1 = $('#NewPassword').val();
                            var p2 = $('#NewPasswordConfirm').val();
                            if(element.id === "NewPasswordConfirm" && p1 && p2 && p1 !== p2) {
                                 var span = $('span[data-valmsg-for="NewPasswordConfirm"]');
                                 span.removeClass('field-validation-valid').addClass('field-validation-error').text('Şifreler eşleşmiyor.');
                            } else if (element.id === "NewPasswordConfirm") {
                                 $('span[data-valmsg-for="NewPasswordConfirm"]').text('');
                            }
                            return;
                       }
                       if (defaultOnKeyUp) defaultOnKeyUp.call(this, element, event);
                  };
             }


             // D. Button Setup Helper
             const setupNextBtn = (btnId, currentTabId, checkBoxName) => {
                  const btn = document.getElementById(btnId);
                  if(!btn) return;
                  
                  btn.addEventListener("click", () => {
                      const $tabInputs = $('#' + currentTabId).find(':input');
                      if (!$tabInputs.valid()) {
                           console.warn("Validation Failed on tab:", currentTabId);
                           console.log("Invalid Elements:", $('#' + currentTabId).find('.input-validation-error'));
                           Swal.fire({ title: 'Eksik Bilgi', text: 'Zorunlu alanları doldurunuz.', icon: 'warning', timer: 2000, showConfirmButton: false });
                           return;
                      }
                      if (checkBoxName) {
                          if (document.querySelectorAll(`input[name="${checkBoxName}"]:checked`).length === 0) {
                              Swal.fire({ title: 'Seçim Yapılmadı', text: "En az bir seçenek seçiniz.", icon: 'warning', confirmButtonText: 'Tamam' });
                              return;
                          }
                      }
                      // Go Next
                      const idx = wizardState.tabOrder.indexOf(currentTabId);
                      if(idx > -1 && idx < wizardState.tabOrder.length - 1) {
                          const nextId = wizardState.tabOrder[idx + 1];
                          wizardState.unlockedTabs.add(nextId);
                          activateTab(nextId);
                      }
                  });
             };

             // setupNextBtn("next_auth", "tab_auth"); // Custom handler used below
             setupNextBtn("next2", "tab2", "SeciliYazilimIdleri");
             
             // --- CUSTOM: Auth Next Logic with Skip Support ---
             const btnNextAuth = document.getElementById("next_auth");
             if (btnNextAuth) {
                  btnNextAuth.addEventListener("click", () => {
                      const isSkipped = $('#IsAuthSkipped').val() === 'true';

                      if (!isSkipped) {
                          // Standard Validation
                          // 1. System Role Check
                          const sysRole = $('#sistemRolSelect').val();
                          if (!sysRole) {
                               Swal.fire({ title: 'Eksik Bilgi', text: 'Sistem Rolü seçimi zorunludur.', icon: 'warning' });
                               return;
                          }
                          // 2. Institutional Role Check
                          // Edit Mode: Allow 0 roles if user wants to clear them (or re-assign later)
                          if (!isEditMode && wizardState.assignedRoles.length === 0) {
                               Swal.fire({ title: 'Rol Eksik', text: 'En az bir kurumsal rol ekleyiniz veya işlemlerden vazgeçmek için "Yetkilendirme İşlemini Atla" butonunu kullanınız.', icon: 'warning' });
                               return;
                          }
                      }

                      // Unlock Next
                      wizardState.unlockedTabs.add("tab2");
                      activateTab("tab2");
                  });
             }

             // --- Skip Button Logic ---
             $('#btnSkipAuth').click(function() {
                  const $btn = $(this);
                  const $content = $('#authContentArea');
                  const $input = $('#IsAuthSkipped');
                  
                  // Toggle State
                  const isCurrentlySkipped = $input.val() === 'true';
                  
                  if (!isCurrentlySkipped) {
                       // Activate Skip Mode
                       $input.val('true');
                       $content.addClass('disabled-div'); // Ensure CSS class exists or use inline
                       $content.css({ 'opacity': '0.5', 'pointer-events': 'none' });
                       $btn.removeClass('btn-outline-warning').addClass('btn-warning').html('<i class="fas fa-undo me-2"></i>İşlemi Etkinleştir');
                  } else {
                       // Deactivate Skip Mode
                       $input.val('false');
                       $content.css({ 'opacity': '1', 'pointer-events': 'auto' });
                       $btn.removeClass('btn-warning').addClass('btn-outline-warning').html('<i class="fas fa-fast-forward me-2"></i>Yetkilendirme İşlemini Atla');
                  }
             });
             setupNextBtn("next3", "tab3", "SeciliUzmanlikIdleri");
             setupNextBtn("next4", "tab4", "SeciliGorevTuruIdleri");
             setupNextBtn("next5", "tab5", "SeciliIsNiteligiIdleri");

             // E. Custom Handlers (Tab 1 & Password & Roles)
             
             // --- Next 1 (AJAX Check) ---
             const btnNext1 = document.getElementById("next1");
             if(btnNext1) {
                 btnNext1.addEventListener("click", () => {
                      // Bypass masked TC validation
                      const $tc = $('#personelTcKimlik');
                      if($tc.val().indexOf('*') !== -1) {
                          $tc.rules("remove");
                          $tc.removeClass("input-validation-error");
                          $tc.next("span").text(""); // clear error
                      }
                      
                      const $inputs = $('#tab1').find(':input');
                      if(!$inputs.valid()) {
                           Swal.fire({ title: 'Eksik Bilgi', text: 'Zorunlu alanları doldurunuz.', icon: 'warning', timer: 2000, showConfirmButton: false });
                           return;
                      }

                      // Check Duplicates
                      const tc = $tc.val();
                      const email = $('#personelemail').val();
                      const pid = '@Model.PersonelId';
                      
                      btnNext1.disabled = true;
                      $.get('@Url.Action("CheckDuplicates", "Personel")', { id: pid, tc: tc, email: email })
                       .done(function(res) {
                            btnNext1.disabled = false;
                            if(res.tcExists || res.emailExists) {
                                let msg = res.tcExists ? "Bu TC Kimlik No kayıtlı. " : "";
                                msg += res.emailExists ? "Bu E-posta kayıtlı." : "";
                                Swal.fire('Kayıt Mevcut', msg, 'error');
                            } else {
                                // Success - Move to Auth
                                wizardState.unlockedTabs.add("tab_auth");
                                activateTab("tab_auth");
                            }
                       })
                       .fail(function() {
                            btnNext1.disabled = false;
                            Swal.fire('Hata', 'Sunucu hatası oluştu. Lütfen tekrar deneyin.', 'error');
                       });
                 });
             }

             // --- Next Password ---
             const btnPass = document.getElementById("next_pass");
             if(btnPass) {
                 btnPass.addEventListener("click", () => {
                      const $inputs = $('#tab_password').find(':input');
                      // Custom check for Old Password
                      const oldPass = $('#EskiSifre').val();
                      const newPass = $('#NewPassword').val();
                      
                      if(!newPass) { // No change
                          wizardState.unlockedTabs.add("tab6");
                          activateTab("tab6");
                          return;
                      }
                      
                      if(!oldPass && $('#EskiSifre').length > 0) {
                           // If hidden validation didn't catch it
                           if(!$inputs.valid()) return; 
                      }
                      
                      if($('#EskiSifre').length > 0) {
                          btnPass.disabled = true;
                          $.get('@Url.Action("CheckPassword", "Personel")', { id: '@Model.PersonelId', password: oldPass })
                           .done(function(res) {
                                btnPass.disabled = false;
                                if(!res.success) {
                                     Swal.fire('Hata', 'Eski şifre hatalı.', 'error');
                                } else {
                                     wizardState.unlockedTabs.add("tab6");
                                     activateTab("tab6");
                                }
                           })
                           .fail(function() {
                                btnPass.disabled = false;
                                Swal.fire('Hata', 'Şifre kontrol hatası.', 'error');
                           });
                      } else {
                          // Admin mode
                          wizardState.unlockedTabs.add("tab6");
                          activateTab("tab6");
                      }
                 });
             }


             // --- Preloaded Data for Stability (Client-Side Cascading) ---
             // Move to WINDOW scope so editRole can see them
             window.allKoords = @Json.Serialize(ViewData["AllKoordinatorlukler"] ?? new List<object>());
             window.allKomis = @Json.Serialize(ViewData["AllKomisyonlar"] ?? new List<object>()); 
             
             console.log("Loaded Hierarchies:", window.allKoords, window.allKomis);

             // --- Cascading Roles Helpers (GLOBAL SCOPE for editRole) ---
             window.loadKoordinatorlukler = (teskilatId, selectedId = null) => {
                 return new Promise((resolve, reject) => {
                     const $koord = $('#newRoleKoord');
                     const $kom = $('#newRoleKom');
                     
                     // Reset structure with placeholder
                     let html = '<option value="">Koordinatörlük</option>';
                     
                     // Reset dependent
                     $kom.empty().append('<option value="">Komisyon</option>').prop('disabled', true);
                     
                     if(!teskilatId) { 
                         $koord.html(html).prop('disabled', true);
                         resolve(); return; 
                     }

                     // Filter
                     const filtered = window.allKoords.filter(x => String(x.parentId) === String(teskilatId));
                     
                     if(filtered.length > 0) {
                         // Build Options String
                         filtered.forEach(x => {
                             const isSelected = selectedId && String(x.id) === String(selectedId);
                             html += `<option value="${x.id}" ${isSelected ? 'selected' : ''}>${x.ad}</option>`;
                         });
                         
                         $koord.html(html).prop('disabled', false);
                         
                         // Trigger Change to update Select2
                         // Using generic 'change' ensures both Select2 and other listeners fire
                         $koord.trigger('change');
                     } else {
                         $koord.html(html).prop('disabled', true);
                     }
                     resolve();
                 });
             };

             window.loadKomisyonlar = (koordinatorlukId, selectedId = null) => {
                 return new Promise((resolve, reject) => {
                     const $kom = $('#newRoleKom');
                     
                     // Reset structure with placeholder
                     let html = '<option value="">Komisyon</option>';
                     
                     if(!koordinatorlukId) { 
                         $kom.html(html).prop('disabled', true);
                         resolve(); return; 
                     }

                     // Filter
                     const filtered = window.allKomis.filter(x => String(x.parentId) === String(koordinatorlukId));

                     if(filtered.length > 0) {
                         // Build Options String
                         filtered.forEach(x => {
                             const isSelected = selectedId && String(x.id) === String(selectedId);
                             html += `<option value="${x.id}" ${isSelected ? 'selected' : ''}>${x.ad}</option>`;
                         });
                         
                         $kom.html(html).prop('disabled', false);
                         $kom.trigger('change');
                     } else {
                         $kom.html(html).prop('disabled', true);
                     }
                     resolve();
                 });
             };

             // --- Cascading Events (Restored) ---
             // REMOVED .off('change') to avoid killing validation/select2 listeners
             $('#newRoleTeskilat').on('change', function() {
                  const id = $(this).val();
                  if(window.isEditingCascade) return; 
                  window.loadKoordinatorlukler(id);
                  window.updateRoleOptions(id); 
             });

             $('#newRoleKoord').on('change', function() {
                  const id = $(this).val();
                  if(window.isEditingCascade) return;
                  window.loadKomisyonlar(id);
             });

             // --- Role Filtering Logic (Global) ---
             // Capture Original Options immediate (assuming populated on server render)
             window.originalRoleOptions = [];
             $('#newRoleType option').each(function() {
                 const val = $(this).val();
                 const text = $(this).text();
                 if(val) window.originalRoleOptions.push({ val, text });
             });

             window.updateRoleOptions = function(teskilatId) {
                 const $role = $('#newRoleType');
                 const currentVal = $role.val();
                 
                 // Clean Id Comparison
                 // Merkez ID usually 1 or defined in data.
                 // Better: Check the text of the selected OPTION in the DOM?
                 // But we have the ID. Let's find the option by ID to be safe.
                 const isMerkez = $('#newRoleTeskilat').find(`option[value="${teskilatId}"]`).text().includes('Merkez');

                 // Clear current options (keep placeholder)
                 $role.empty().append('<option value="">Rol Seçiniz...</option>');

                 // Rebuild Options
                 window.originalRoleOptions.forEach(opt => {
                     let allowed = true;
                     // Rule: "Genel Koordinatör" (ID 4) only for "Merkez"
                     if (opt.val == '4' && !isMerkez) allowed = false;
                     // Rule: "Merkez Birim Koordinatörlüğü" (ID 5) only for "Merkez"
                     if (opt.val == '5' && !isMerkez) allowed = false;
                     // Rule: "İl Koordinatörü" (ID 3) only for "Taşra"
                     if (opt.val == '3' && isMerkez) allowed = false;

                     if (allowed) {
                         const newOpt = new Option(opt.text, opt.val);
                         if(currentVal == opt.val) newOpt.selected = true;
                         $role.append(newOpt);
                     }
                 });
                 
                 // Restore or Clear
                 if(currentVal && !$role.find(`option[value="${currentVal}"]`).length) {
                     $role.val(null).trigger('change');
                 } else {
                     $role.trigger('change.select2'); 
                 }
             };


             // F. Restore State Logic (Legacy/Restart) & Modal Open
             // (Logic simplified: if Edit Mode, we already unlocked everything. 
             // If Create Mode, check fields to auto-advance?)
             if (!isEditMode) {
                  // Auto-advance logic for Create Mode only
                  if($('#personelAdi').val() && $('#personelTcKimlik').val()) {
                       // wizardState.unlockedTabs.add("tab_auth"); // Optional: Don't auto-unlock too aggressively
                  }
             }

             // Open specific tab if requested by Server
             const openTab = '@TempData["OpenTab"]';
             const showModal = '@TempData["ShowUserExistsModal"]' === '1';
             
             if(showModal) {
                 try {
                     var m = new bootstrap.Modal(document.getElementById('tcDuplicateModal'), {backdrop:'static'});
                     m.show();
                     $('#btnFixTc').click(() => { m.hide(); setTimeout(() => activateTab('tab1'), 300); });
                 } catch(e) { alert("Hata: Kayıt zaten mevcut."); }
             }
             else if(openTab) {
                 activateTab(openTab);
             }

             // Photo Upload Change
             $('#personelFoto').change(function(e) {
                  const file = e.target.files[0];
                  if(file) {
                      if(file.size > 2*1024*1024) { alert("Max 2MB"); this.value=""; return; }
                      const r = new FileReader();
                      r.onload = function(evt) {
                           $('#FotografBase64').val(evt.target.result);
                           const img = document.getElementById("photoPreview");
                           if(img) {
                               img.src = evt.target.result;
                               // Show Logic
                               img.style.display = 'block';
                               $(img).siblings('i').hide();
                               
                               if($('#tab6').hasClass('active')) updateControlPhoto();
                           }
                      };
                      r.readAsDataURL(file);
                  }
             });

             // Final Submit Guard
             $('form').submit(function(e) {
                 const groups = [
                     { name: "SeciliYazilimIdleri", label: "Beceriler" },
                     { name: "SeciliUzmanlikIdleri", label: "Uzmanlık" },
                     { name: "SeciliGorevTuruIdleri", label: "Görev Türü" },
                     { name: "SeciliIsNiteligiIdleri", label: "İş Niteliği" }
                 ];
                 let hasError = false;
                 groups.forEach(g => {
                     // Check if at least one checkbox is checked for each group
                     // Note: You might want to skip this check if the tab is skipped or not visible?
                     // For now, restoring per user request.
                     if($(`input[name="${g.name}"]:checked`).length === 0) hasError = true;
                 });
                 if(hasError) {
                      e.preventDefault();
                      Swal.fire({
                          title: 'Eksik Seçim',
                          text: "Lütfen Beceriler, Uzmanlık, Görev Türü ve İş Niteliği sekmelerinden en az birer seçim yapınız.",
                          icon: 'warning',
                          confirmButtonText: 'Tamam'
                      });
                 }
             });

        }); // End Ready
    </script>
}
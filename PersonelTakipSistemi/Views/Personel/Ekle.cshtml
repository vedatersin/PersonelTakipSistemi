@model PersonelTakipSistemi.ViewModels.PersonelEkleViewModel
@{
    ViewData["Title"] = "Personel Ekle";
}

@section Styles {
  <link rel="stylesheet" href="~/sevilay-tema/css/personel-ekle.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
      .select2-container .select2-selection--single {
          height: 38px;
          border: 1px solid #ced4da;
          display: flex;
          align-items: center;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
          top: 6px;
      }
  </style>
}

<div class="tabs-container">

  @if (TempData["Success"] != null)
  {
      <div class="alert alert-success" role="alert">
          <i class='bx bx-check-circle'></i> @TempData["Success"]
      </div>
  }
  @if (TempData["Error"] != null)
  {
      <div class="alert alert-danger" role="alert">
          <i class='bx bx-error'></i> @TempData["Error"]
      </div>
  }

  <!-- TAB BUTONLARI -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tab1">Kişisel Bilgiler</button>
    <button class="tab-btn" data-tab="tab2">Personelin Becerileri (Kullandığı Yazılımlar)</button>
    <button class="tab-btn" data-tab="tab3">Uzmanlık</button>
    <button class="tab-btn" data-tab="tab4">Görev Türü</button>
    <button class="tab-btn" data-tab="tab5">Yapılan İş Niteliği</button>
    @if(Model.IsEditMode)
    {
         <button class="tab-btn" data-tab="tab_password">Şifre Değiştir</button>
    }
    <button class="tab-btn" data-tab="tab6">Kontrol</button>
  </div>

  <form asp-controller="Personel" asp-action="Ekle" method="post" enctype="multipart/form-data">
  @Html.AntiForgeryToken()
  <input type="hidden" asp-for="PersonelId" />
  <input type="hidden" asp-for="IsEditMode" />

  <!-- TAB1 KİŞİSEL BİLGİLER -->
  <div id="tab1" class="tab-content active">
  <h2>Kişisel Bilgiler</h2>
  <div class="alert alert-info py-2 mb-3">
    <i class='bx bx-info-circle'></i> * ile işaretli alanlar zorunludur.
  </div>

    <!-- Personel Fotoğrafı: Row'un üstünde veya sol kolonda kalabilir. Burada en üste (row dışına) alıyoruz. -->
    <div class="mb-4 d-flex align-items-center gap-4">
      <!-- Fotoğraf Önizleme -->
      <div>
        <div class="photo-preview-container" id="previewContainer">
            <i class='bx bx-user'></i>
            <img id="photoPreview" src="" alt="Personel Fotoğrafı" />
        </div>
      </div>

      <!-- Fotoğraf Yükleme -->
      <div>
        <label class="form-label d-block">Personel Fotoğrafı</label>
        <input type="file" id="personelFoto" name="personelFoto" accept="image/*" class="form-control" >
        <input type="hidden" id="FotografBase64" name="FotografBase64" asp-for="FotografBase64" />
        <small class="text-muted">JPG, PNG yükleyebilirsiniz.</small>
      </div>
    </div>

    <div class="row">
        <!-- SOL KOLON -->
        <div class="col-md-6">
            <div class="mb-3">
              <label asp-for="Ad" class="form-label">Personel Adı: <span class="text-danger">*</span></label>
              <input type="text" id="personelAdi" asp-for="Ad" class="form-control" placeholder="Personel adını girin" >
              <span asp-validation-for="Ad" class="text-danger"></span>
            </div>

            <div class="mb-3">
              <label asp-for="Soyad" class="form-label">Personel Soyadı: <span class="text-danger">*</span></label>
              <input  type="text"  id="personelSoyadi" asp-for="Soyad" class="form-control" placeholder="Personel soyadını girin" >
              <span asp-validation-for="Soyad" class="text-danger"></span>
            </div>

            <!-- Cinsiyet (RADIO) -->
            <div class="mb-3">
              <label class="form-label d-block">Personel Cinsiyet: <span class="text-danger">*</span></label>

              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="PersonelCinsiyet" id="cinsiyetKadin" value="1" >
                <label class="form-check-label" for="cinsiyetKadin">Kadın</label>
              </div>

              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="PersonelCinsiyet" id="cinsiyetErkek" value="0"         >
                <label class="form-check-label" for="cinsiyetErkek">Erkek</label>
              </div>
            </div>

            <div class="mb-3">
              <label asp-for="TcKimlikNo" class="form-label">Personel TC KİMLİK NO: <span class="text-danger">*</span></label>
              <input type="text" id="personelTcKimlik" asp-for="TcKimlikNo" class="form-control" placeholder="Personel TC Kimlik Numarasını girin" maxlength="11" inputmode="numeric" pattern="\d{11}" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
              <span asp-validation-for="TcKimlikNo" class="text-danger"></span>
            </div>
            
             <div class="mb-3">
              <label asp-for="DogumTarihi" class="form-label">Doğum Tarihi: <span class="text-danger">*</span></label>
              <input type="date" asp-for="DogumTarihi" class="form-control" >
              <span asp-validation-for="DogumTarihi" class="text-danger"></span>
            </div>
        </div>

        <!-- SAĞ KOLON -->
        <div class="col-md-6">
             <div class="mb-3">
              <label asp-for="Telefon" class="form-label">Telefon <span class="text-danger">*</span></label>
              <input  type="tel" class="form-control" id="personeltelefon" asp-for="Telefon" placeholder="0555 555 55 55" maxlength="11" >
            </div>

            <div class="mb-3">
              <label asp-for="Eposta" class="form-label">E-posta <span class="text-danger">*</span></label>
              <input type="email" class="form-control"  id="personelemail"  asp-for="Eposta" placeholder="ornek@mail.com" >
              <span asp-validation-for="Eposta" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
              <label asp-for="GorevliIlId" class="form-label">Görevli İl <span class="text-danger">*</span></label>
              <select class="form-select select2" id="personelgorevli_il" asp-for="GorevliIlId">
                <option value="">İl Seçiniz...</option>
                @if(Model.Iller != null) {
                    foreach(var item in Model.Iller) {
                        <option value="@item.Id">@item.Ad</option>
                    }
                }
              </select>
              <span asp-validation-for="GorevliIlId" class="text-danger"></span>
            </div>
            
             <!-- ✅ BRANŞ ALANI (Select2) -->
            <div class="mb-3">
            <label asp-for="BransId" class="form-label">Branş <span class="text-danger">*</span></label>
            <select id="personelBrans" asp-for="BransId" class="form-select select2">
              <option value="">Branş Seçiniz...</option>
              @if(Model.Branslar != null) {
                  foreach(var item in Model.Branslar) {
                      <option value="@item.Id">@item.Ad</option>
                  }
              }
            </select>
            <span asp-validation-for="BransId" class="text-danger"></span>
            </div>
            
            <div class="mb-3">
              <label asp-for="KadroKurum" class="form-label">Kadro Kurum <span class="text-danger">*</span></label>
              <input  type="text" id="personelKadroKurum" asp-for="KadroKurum" class="form-control"  placeholder="Personelin Kadrosunun Bulunduğu Kurumu Giriniz"  >
              <span asp-validation-for="KadroKurum" class="text-danger"></span>
            </div>

            <div class="form-check mb-3">
              <input  type="checkbox" id="gorevAktif" asp-for="AktifMi" class="form-check-input"  >
              <label for="gorevAktif" class="form-check-label">Görev Aktiflik <span class="text-danger">*</span></label>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary" id="next1">İlerle</button>
  </div> <!-- /Tab1 -->

  <!-- TAB2 BECERİLER -->
  <div id="tab2" class="tab-content">
    <h2>Personelin Becerileri (Kullandığı Yazılımlar)</h2>
    <div class="mb-4">
        <div class="row">
        @if(Model.Yazilimlar != null)
        {
            @foreach(var item in Model.Yazilimlar)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="yazilim_@item.Id" value="@item.Id" name="SeciliYazilimIdleri" @(Model.SeciliYazilimIdleri != null && Model.SeciliYazilimIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="yazilim_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
        else
        {
            <p>Kayıtlı yazılım bulunamadı.</p>
        }
        </div>
        <button type="button" class="btn btn-primary mt-3" id="next2">İlerle</button>
    </div>
  </div>

  <!-- TAB3 UZMANLIK -->
  <div id="tab3" class="tab-content">
    <h2>Personelin Uzmanlığı</h2>
    <div class="mb-4">
        <div class="row">
         @if(Model.Uzmanliklar != null)
        {
            @foreach(var item in Model.Uzmanliklar)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="uzmanlik_@item.Id" value="@item.Id" name="SeciliUzmanlikIdleri" @(Model.SeciliUzmanlikIdleri != null && Model.SeciliUzmanlikIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="uzmanlik_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
        </div>
        <button type="button" class="btn btn-primary mt-3" id="next3">İlerle</button>
    </div>
  </div>

<!-- TAB4 GÖREVİ-->
  <div id="tab4" class="tab-content">
    <h2>Personelin Görev Türü</h2>
    <div class="mb-4">
      <div class="row">
         @if(Model.GorevTurleri != null)
        {
            @foreach(var item in Model.GorevTurleri)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="gorev_@item.Id" value="@item.Id" name="SeciliGorevTuruIdleri" @(Model.SeciliGorevTuruIdleri != null && Model.SeciliGorevTuruIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="gorev_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
      </div>
      <button type="button" class="btn btn-primary mt-3" id="next4">İlerle</button>
    </div>
  </div>

  <!-- TAB5 Yapılan İş Niteliği -->
  <div id="tab5" class="tab-content">
    <h2>Yapılan İş Niteliği</h2>
    <div class="mb-4">
        <div class="row">
         @if(Model.IsNitelikleri != null)
        {
            @foreach(var item in Model.IsNitelikleri)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_@item.Id" value="@item.Id" name="SeciliIsNiteligiIdleri" @(Model.SeciliIsNiteligiIdleri != null && Model.SeciliIsNiteligiIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="is_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
        </div>
      <button type="button" class="btn btn-primary mt-3" id="next5">İlerle</button>
    </div>
  </div>

  <!-- TAB6 Şifre Değiştir (Sadece Edit Modunda) -->
  @if(Model.IsEditMode)
  {
      <div id="tab_password" class="tab-content">
        <h2>Şifre Değiştir</h2>
        <div class="alert alert-warning">
            <i class="bx bx-info-circle"></i> Şifreyi değiştirmek istemiyorsanız bu alanı <strong>boş bırakın</strong>.
        </div>
        <div class="mb-4">
            <label asp-for="NewPassword" class="form-label">Yeni Şifre</label>
            <input type="password" asp-for="NewPassword" class="form-control" placeholder="Yeni şifrenizi girin (min 6 karakter)">
            <span asp-validation-for="NewPassword" class="text-danger"></span>
        </div>
        <div class="mb-4">
            <label asp-for="NewPasswordConfirm" class="form-label">Yeni Şifre (Tekrar)</label>
            <input type="password" asp-for="NewPasswordConfirm" class="form-control" placeholder="Yeni şifreyi tekrar girin">
            <span asp-validation-for="NewPasswordConfirm" class="text-danger"></span>
        </div>
         <button type="button" class="btn btn-primary mt-3" id="next_pass">İlerle</button>
      </div>
  }

  <div id="tab6" class="tab-content">
  <p class="text-muted">
    Diğer sekmelerde kaydedilen bilgiler aşağıdaki tabloda özetlenir.
  </p>
    <!-- Control Tab Photo Section: Simplified to single image source -->
    <div class="text-center mb-4">
        <div class="photo-preview-container mx-auto" id="controlContainer">
            <i class='bx bx-user' id="controlIcon"></i>
            <img id="kontrolFoto" src="" alt="Personel Fotoğrafı" style="display:none;" />
        </div>
        <p class="mt-2 fw-bold">Personel Fotoğrafı</p>
    </div>

  <table class="table table-bordered table-sm">
    <thead>
      <tr>
        <th>ALANLAR</th>
        <th>DEĞERLER</th>
      </tr>
    </thead>
    <tbody id="kontrolTableBody">
      <!-- JS ile doldurulacak -->
    </tbody>
  </table>

  <div class="d-grid gap-2 mt-4">
    <button type="submit" class="btn btn-success btn-lg">@(Model.IsEditMode ? "Bilgileri Güncelle" : "Bilgileri Kaydet")</button>
  </div>

  </div>

  </form>
  <!-- Modal: Duplicate Error (TC & Email) -->
  <div class="modal fade" id="tcDuplicateModal" tabindex="-1" aria-labelledby="tcDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="tcDuplicateModalLabel">
              @if(TempData["ModalTitle"] != null) { @TempData["ModalTitle"] } 
              else { <text>Kayıt Hatası</text> }
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            @if(TempData["ModalItems"] != null)
            {
                <ul>
                    @foreach(var item in TempData["ModalItems"].ToString().Split('|'))
                    {
                        <li>@item</li>
                    }
                </ul>
            }
            else if(TempData["TcDuplicateError"] != null)
            {
                 <p>@TempData["TcDuplicateError"]</p>
            }
            else
            {
                 <p>Benzer bir kayıt sistemde zaten mevcut.</p>
            }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnFixTc">Tamam (Düzelt)</button>
        </div>
      </div>
    </div>
  </div>

</div> <!-- /tabs-container -->

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      $(document).ready(function() {
          $('.select2').select2({
              width: '100%',
              placeholder: 'Seçiniz...',
              allowClear: true,
              language: {
                    noResults: function () {
                        return "Sonuç bulunamadı";
                    }
                }
          });

          // Unobtrusive validation entegrasyonu: Select2 değişince validasyonu tetikle
          $('.select2').on('change', function() {
              $(this).valid(); 
          });
      });
      
      // ... existing code ...

      document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll(".tab-btn");
        const contents = document.querySelectorAll(".tab-content");

        // --- YENİ EKLENEN FONKSİYON: Özet Tablosunu Doldur ---
        function fillKontrolOzet() {
            const tbody = document.getElementById("kontrolTableBody");
            if (!tbody) return;
            tbody.innerHTML = ""; // Temizle

            const addRow = (label, value) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${label}</td><td>${value && value.trim() !== "" ? value : "-"}</td>`;
                tbody.appendChild(tr);
            };

            // 1. Text Değerler
            const ad = document.getElementById("personelAdi")?.value || "";
            const soyad = document.getElementById("personelSoyadi")?.value || "";
            addRow("Ad Soyad", `${ad} ${soyad}`);

            addRow("TcKimlikNo", document.getElementById("personelTcKimlik")?.value);
            addRow("Telefon", document.getElementById("personeltelefon")?.value);
            addRow("Eposta", document.getElementById("personelemail")?.value);
            addRow("KadroKurum", document.getElementById("personelKadroKurum")?.value);

            // 2. Select Değerler
            const gorevliIl = document.getElementById("personelgorevli_il");
            if (gorevliIl && gorevliIl.selectedIndex > 0) {
                 addRow("GorevliIl", gorevliIl.options[gorevliIl.selectedIndex].text);
            } else {
                 addRow("GorevliIl", "-");
            }

            const brans = document.getElementById("personelBrans");
            if (brans && brans.selectedIndex > 0) {
                addRow("Brans", brans.options[brans.selectedIndex].text);
            } else {
                 addRow("Brans", "-");
            }

            // 3. Checkbox / Radio
            const aktifMi = document.getElementById("gorevAktif")?.checked ? "Aktif" : "Pasif";
            addRow("Görev Aktiflik", aktifMi);

            let cinsiyet = "-";
            if (document.getElementById("cinsiyetKadin")?.checked) cinsiyet = "Kadın";
            else if (document.getElementById("cinsiyetErkek")?.checked) cinsiyet = "Erkek";
            addRow("PersonelCinsiyet", cinsiyet);

            // 4. Çoklu Checkbox Listeleri (Label okuma)
            const getLabels_ = (name) => {
                const checkedInputs = document.querySelectorAll(`input[name="${name}"]:checked`);
                if (checkedInputs.length === 0) return "-";
                
                const labels = [];
                checkedInputs.forEach(input => {
                    const id = input.id;
                    // Label'ı bul (for attr ile)
                    const labelEl = document.querySelector(`label[for="${id}"]`);
                    if (labelEl) {
                        labels.push(labelEl.textContent.trim());
                    }
                });
                return labels.join(", ");
            };

            addRow("Seçili Yazılımlar", getLabels_("SeciliYazilimIdleri"));
            addRow("Seçili Uzmanlıklar", getLabels_("SeciliUzmanlikIdleri"));
            addRow("Seçili Görev Türleri", getLabels_("SeciliGorevTuruIdleri"));
            addRow("Seçili İş Nitelikleri", getLabels_("SeciliIsNiteligiIdleri"));
        }

        // TAB LOCKING & NAVIGATION LOGIC
        const tabOrder = ["tab1", "tab2", "tab3", "tab4", "tab5"];
        // Edit modunda araya şifre tabı girer
        const isEditMode = '@Model.IsEditMode' === 'True'; 
        if(isEditMode) {
            tabOrder.push("tab_password");
        }
        tabOrder.push("tab6"); // Control tab (always last)

        // Hangi tablar açıldı (unlocked)
        // Edit modunda tüm tablar baştan açık olsun
        const unlockedTabs = new Set(["tab1"]); 
        if(isEditMode) {
            tabOrder.forEach(t => unlockedTabs.add(t));
        }

        function activateTab(tabId) {
          // Kilit kontrolü: Eğer tab unlocked değilse geçiş yapma 
          // (Edit modunda hepsi unlocked olduğu için serbest geçiş olur)
          if (!unlockedTabs.has(tabId)) return;

          buttons.forEach((b) => {
            const isActive = b.getAttribute("data-tab") === tabId;
            b.classList.toggle("active", isActive);
            // Disabled görsel yönetimi
            if(unlockedTabs.has(b.getAttribute("data-tab"))) {
                b.classList.remove("disabled-tab"); 
                b.style.opacity = "1";
                b.style.cursor = "pointer";
            } else {
                b.classList.add("disabled-tab");
                b.style.opacity = "0.5";
                b.style.cursor = "not-allowed";
            }
          });
          
          contents.forEach((c) => {
            c.classList.toggle("active", c.id === tabId);
          });

          // Eğer kontrol sekmesine geçildiyse tabloyu doldur
          if (tabId === "tab6") {
              fillKontrolOzet();
              if (typeof updateControlPhoto === "function") {
                  updateControlPhoto();
              }
          }
        }

        buttons.forEach((btn) => {
          // Başlangıç stili
          const tId = btn.getAttribute("data-tab");
          if(!unlockedTabs.has(tId)) {
               btn.style.opacity = "0.5";
               btn.style.cursor = "not-allowed";
          } else {
               // Edit modunda baştan hepsi aktif görünsün
               btn.style.opacity = "1";
               btn.style.cursor = "pointer";
          }
          
          btn.addEventListener("click", () => {
            const tabId = btn.getAttribute("data-tab");
            activateTab(tabId);
          });
        });

        // "İlerle" Butonları
        // next1 -> tab2, next2 -> tab3 ...
        // Mantık: nextX butonu bir sonraki tabı unlock eder ve oraya geçer.
        const setupNextBtn = (btnId, currentTabId) => {
            const btn = document.getElementById(btnId);
            if(!btn) return;
            
            btn.addEventListener("click", () => {
                // Validation kontrolü (HTML5 veya ASP.NET Unobtrusive)
                const $currentTabInputs = $('#' + currentTabId).find(':input');
                let isValid = true;
                
                $currentTabInputs.each(function() {
                    if (!$(this).valid()) {
                        isValid = false;
                    }
                });

                if (!isValid) return;

                const currentIndex = tabOrder.indexOf(currentTabId);
                if(currentIndex >= 0 && currentIndex < tabOrder.length - 1) {
                    const nextTabId = tabOrder[currentIndex + 1];
                    unlockedTabs.add(nextTabId);
                    activateTab(nextTabId);
                }
            });
        };

        setupNextBtn("next1", "tab1");
        setupNextBtn("next2", "tab2");
        setupNextBtn("next3", "tab3");
        setupNextBtn("next4", "tab4");
        setupNextBtn("next5", "tab5");
        
        if(isEditMode) {
            setupNextBtn("next_pass", "tab_password");
        } else {
            // Edit modu değilse tab5'ten sonra direkt tab6(kontrol) gelir, 
            // ama yukarıdaki dinamik tabOrder bunu zaten çözdü.
            // Sadece tab5 butonu bir sonrakine (tab6) gidecek.
            // Ancak tab5 butonunu manuel setup yaparken index mantığı kullandık, sorun yok.
        }

        // Fotoğraf Önizleme
        const photoInput = document.getElementById("personelFoto");
        const previewImg = document.getElementById("photoPreview");
        
        // Control tab elements
        const controlImg = document.getElementById("kontrolFoto");
        const controlIcon = document.getElementById("controlIcon");

        // Hidden input for Base64 Persistence
        const hiddenBase64 = document.getElementById("FotografBase64");
        
        function updateContainer(imgElement, isControl = false) {
            if(!imgElement) return;
            
            if (isControl) {
                // Control tab logic: only show img if src is valid, otherwise show icon
                if (imgElement.src && imgElement.src !== window.location.href && imgElement.src !== "") {
                    imgElement.style.display = "block";
                    if(controlIcon) controlIcon.style.display = "none";
                } else {
                    imgElement.style.display = "none";
                     if(controlIcon) controlIcon.style.display = "block";
                }
            } else {
                // Regular preview logic
                const container = imgElement.parentElement;
                const icon = container.querySelector("i");
                if(icon) icon.style.display = "none";
                imgElement.style.display = "block";
            }
        }

        // Logic to determine which photo to show in Control Tab
        function updateControlPhoto() {
            if (!controlImg) return;
            
            // Priority 1: New File Selected (File Reader Result)
            // Priority 2: Existing Photo (Hidden Input)
            // Priority 3: None (Show Icon)
            
            // Check if we have a file reader result stored (could be in previewImg.src if set)
            if (previewImg && previewImg.src && previewImg.src.startsWith("data:image")) {
                 controlImg.src = previewImg.src;
                 updateContainer(controlImg, true);
            } 
            else if (hiddenBase64 && hiddenBase64.value) {
                 controlImg.src = hiddenBase64.value;
                 updateContainer(controlImg, true);
            } 
            else {
                 controlImg.style.display = "none";
                 if(controlIcon) controlIcon.style.display = "block";
            }
        }

        // Fotoğraf Restore Fonksiyonu (Base64 veya URL'den)
        function restorePhotoFromHidden() {
            if(hiddenBase64 && hiddenBase64.value) {
                const src = hiddenBase64.value;
                if(previewImg) {
                    previewImg.src = src;
                    updateContainer(previewImg);
                }
                // Control photo update handled by updateControlPhoto call or tab switch
            }
        }
        
        // Sayfa yüklendiğinde (örn validation hatası sonrası) fotoyu geri yükle
        restorePhotoFromHidden();

        if(photoInput) {
            photoInput.addEventListener("change", function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const result = e.target.result;

                        // Base64'ü hidden input'a kaydet (Persistence için)
                        if(hiddenBase64) {
                            hiddenBase64.value = result; // Note: For new uploads, we might not want to submit this as text, but for preview persistence logic matches
                        }
                        
                        if(previewImg) {
                            previewImg.src = result;
                            updateContainer(previewImg);
                        }
                        
                        // Update control immediately if active
                         if(document.getElementById("tab6").classList.contains("active")) {
                             updateControlPhoto();
                         }
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Tab Activation Hook Update
        // Override activateTab inside listener scope or modify existing if possible.
        // Since we cannot easily modify inside DOMContentLoaded scope without replacing everything, 
        // we rely on the existing click listeners calling the *original* activateTab if it wasn't exposed.
        // Wait, I am replacing the script block. I need tomake sure I hook into tab switching.
        
        // Re-attaching tab listeners or injecting logic into fillKontrolOzet which is called by tab switch
        // The original `fillKontrolOzet` is called when tab6 is activated. Let's add photo update there.


        // --- DUPLICATE TC / MODAL LOGIC ---
        // Backend'den gelen ShowErrorModal bayrağı kontrol ediliyor
        const showErrorModal = '@TempData["ShowUserExistsModal"]'; // Updated key
        // Backward compatibility for basic check
        const oldShowModal = '@TempData["ShowErrorModal"]';
        
        const openTab = '@TempData["OpenTab"]';
        const focusId = '@TempData["FocusId"]';

        if (showErrorModal === '1' || oldShowModal === '1') {
            const modalEl = document.getElementById('tcDuplicateModal');
            if (modalEl) {
                // Bootstrap modal varsa kullan
                // Projede bootstrap.js yüklü kabul ediyoruz
                try {
                    const modal = new bootstrap.Modal(modalEl, {
                        backdrop: 'static',
                        keyboard: false
                    });
                    modal.show();

                    // "Tamam (Düzelt)" butonu
                    const btnFix = document.getElementById('btnFixTc');
                    if(btnFix){
                        btnFix.addEventListener('click', () => {
                            modal.hide();
                            
                            // Modal animasyonu bitince odaklan
                            setTimeout(() => {
                                handleTabAndFocus();
                            }, 500); 
                        });
                    }
                    
                    // Modal manuel kapanırsa da aynı işlemi yap
                    modalEl.addEventListener('hidden.bs.modal', function () {
                        handleTabAndFocus();
                    });

                } catch (e) {
                    // Fallback: Bootstrap JS yoksa veya hata olursa manuel göster (Overlay)
                    console.warn("Bootstrap modal yüklenemedi, fallback kullanılıyor.", e);
                    alert("Kayıt Hatası: Bu kullanıcı sistemde zaten mevcut.");
                    handleTabAndFocus();
                }
            } else {
                handleTabAndFocus();
            }
        } 
        else if (openTab) {
            // Modal yok ama tab set edilmişse
            activateTab(openTab);
        }

        function handleTabAndFocus() {
            if (openTab) {
                activateTab(openTab);
            }
            if (focusId) {
                const el = document.getElementById(focusId);
                if (el) {
                    el.focus();
                    if(el.select) el.select(); // Değeri seç
                }
            }
            // Fotoğrafı tekrar çiz (önlem olarak, tab geçişi bazen bozabilir)
            restorePhotoFromHidden();
        }

      });
    </script>
}
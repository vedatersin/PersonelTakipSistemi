@model PersonelTakipSistemi.ViewModels.PersonelEkleViewModel
@{
    ViewData["Title"] = "Personel Ekle";
}

@section Styles {
  <link rel="stylesheet" href="~/sevilay-tema/css/personel-ekle.css" />
}

<div class="tabs-container">

  <!-- TAB BUTONLARI -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tab1">Kişisel Bilgiler</button>
    <button class="tab-btn" data-tab="tab2">Beceriler</button>
    <button class="tab-btn" data-tab="tab3">Uzmanlık</button>
    <button class="tab-btn" data-tab="tab4">Görev Türü</button>
    <button class="tab-btn" data-tab="tab5">Yapılan İş Niteliği</button>
    <button class="tab-btn" data-tab="tab6">Kontrol</button>
  </div>

  <form asp-controller="Personel" asp-action="Ekle" method="post" enctype="multipart/form-data">
  @Html.AntiForgeryToken()

  <!-- TAB1 KİŞİSEL BİLGİLER -->
  <div id="tab1" class="tab-content active">
  <h2>Kişisel Bilgiler</h2>

    <!-- Personel Fotoğrafı -->
    <div class="mb-4 d-flex align-items-center gap-4">
      <!-- Fotoğraf Önizleme -->
      <div>
        <div class="photo-preview-container" id="previewContainer">
            <i class='bx bx-user'></i>
            <img id="photoPreview" src="" alt="Personel Fotoğrafı" />
        </div>
      </div>

      <!-- Fotoğraf Yükleme -->
      <div>
        <label class="form-label d-block">Personel Fotoğrafı</label>
        <input type="file" id="personelFoto" name="personelFoto" accept="image/*" class="form-control" >
        <input type="hidden" id="FotografBase64" name="FotografBase64" asp-for="FotografBase64" />
        <small class="text-muted">JPG, PNG yükleyebilirsiniz.</small>
      </div>
    </div>

    <div class="mb-4">
      <label asp-for="Ad" class="form-label">Personel Adı:</label>
      <input type="text" id="personelAdi" asp-for="Ad" class="form-control" placeholder="Personel adını girin" >
      <span asp-validation-for="Ad" class="text-danger"></span>
    </div>

    <div class="mb-4">
      <label asp-for="Soyad" class="form-label">Personel Soyadı:</label>
      <input  type="text"  id="personelSoyadi" asp-for="Soyad" class="form-control" placeholder="Personel soyadını girin" >
      <span asp-validation-for="Soyad" class="text-danger"></span>
    </div>

    <!-- Cinsiyet (RADIO) -->
    <div class="mb-4">
      <label class="form-label d-block">Personel Cinsiyet:</label>

      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" asp-for="PersonelCinsiyet" id="cinsiyetKadin" value="1" >
        <label class="form-check-label" for="cinsiyetKadin">Kadın</label>
      </div>

      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" asp-for="PersonelCinsiyet" id="cinsiyetErkek" value="0"         >
        <label class="form-check-label" for="cinsiyetErkek">Erkek</label>
      </div>
    </div>

    <div class="mb-4">
      <label asp-for="TcKimlikNo" class="form-label">Personel TC KİMLİK NO:</label>
      <input type="text" id="personelTcKimlik" asp-for="TcKimlikNo" class="form-control" placeholder="Personel TC Kimlik Numarasını girin" maxlength="11" >
      <span asp-validation-for="TcKimlikNo" class="text-danger"></span>
    </div>

    <div class="mb-4">
      <label asp-for="Sifre" class="form-label">Şifre</label>
      <input type="password" class="form-control" id="sifre" asp-for="Sifre" maxlength="6" title="Şifre en az 6 karakter olmalıdır." >
      <span asp-validation-for="Sifre" class="text-danger"></span>
    </div>

    <div class="mb-4">
      <label asp-for="Telefon" class="form-label">Telefon</label>
      <input  type="tel" class="form-control" id="personeltelefon" asp-for="Telefon" placeholder="0555 555 55 55" maxlength="11" >
    </div>

    <div class="mb-4">
      <label asp-for="Eposta" class="form-label">E-posta</label>
      <input type="email" class="form-control"  id="personelemail"  asp-for="Eposta" placeholder="ornek@mail.com" >
      <span asp-validation-for="Eposta" class="text-danger"></span>
    </div>

    <div class="mb-4">
      <label asp-for="GorevliIl" class="form-label">Görevli İl</label>
      <select class="form-select"  id="personelgorevli_il"  asp-for="GorevliIl" >
        <option value="">İl Seçiniz...</option>
        <option value="Adana">Adana</option>
        <option value="Adıyaman">Adıyaman</option>
        <option value="Afyonkarahisar">Afyonkarahisar</option>
        <option value="Ağrı">Ağrı</option>
        <option value="Amasya">Amasya</option>
        <!-- Diğer iller eklenebilir -->
      </select>
    </div>

    <!-- ✅ BRANŞ ALANI -->
    <div class="mb-4">
    <label asp-for="Brans" class="form-label">Branş</label>
    <select id="personelBrans" asp-for="Brans" class="form-select">
      <option value="">Branş Seçiniz...</option>
      <option value="Bilişim Teknolojileri">Bilişim Teknolojileri</option>
      <option value="Türkçe">Türkçe</option>
      <option value="Matematik">Matematik</option>
      <option value="Fen Bilimleri">Fen Bilimleri</option>
      <option value="Sosyal Bilgiler">Sosyal Bilgiler</option>
      <option value="İngilizce">İngilizce</option>
      <option value="Sınıf Öğretmeni">Sınıf Öğretmeni</option>
      <option value="Rehberlik">Rehberlik</option>
      <option value="Diğer">Diğer</option>
    </select>
    </div>

    <div class="mb-4">
      <label asp-for="KadroKurum" class="form-label">Kadro Kurum</label>
      <input  type="text" id="personelKadroKurum" asp-for="KadroKurum" class="form-control"  placeholder="Personelin Kadrosunun Bulunduğu Kurumu Giriniz"  >
    </div>

    <div class="form-check mb-4">
      <input  type="checkbox" id="gorevAktif" asp-for="AktifMi" class="form-check-input"  >
      <label for="gorevAktif" class="form-check-label">Görev Aktiflik</label>
    </div>

    <button type="button" class="btn btn-primary" id="next1">İlerle</button>
  </div> <!-- /Tab1 -->

  <!-- TAB2 BECERİLER -->
  <div id="tab2" class="tab-content">
    <h2>Personelin Becerileri</h2>
    <div class="mb-4">
        <div class="row">
        @if(Model.Yazilimlar != null)
        {
            @foreach(var item in Model.Yazilimlar)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="yazilim_@item.Id" value="@item.Id" name="SeciliYazilimIdleri" @(Model.SeciliYazilimIdleri != null && Model.SeciliYazilimIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="yazilim_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
        else
        {
            <p>Kayıtlı yazılım bulunamadı.</p>
        }
        </div>
        <button type="button" class="btn btn-primary mt-3" id="next2">İlerle</button>
    </div>
  </div>

  <!-- TAB3 UZMANLIK -->
  <div id="tab3" class="tab-content">
    <h2>Personelin Uzmanlığı</h2>
    <div class="mb-4">
        <div class="row">
         @if(Model.Uzmanliklar != null)
        {
            @foreach(var item in Model.Uzmanliklar)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="uzmanlik_@item.Id" value="@item.Id" name="SeciliUzmanlikIdleri" @(Model.SeciliUzmanlikIdleri != null && Model.SeciliUzmanlikIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="uzmanlik_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
        </div>
        <button type="button" class="btn btn-primary mt-3" id="next3">İlerle</button>
    </div>
  </div>

<!-- TAB4 GÖREVİ-->
  <div id="tab4" class="tab-content">
    <h2>Personelin Görev Türü</h2>
    <div class="mb-4">
      <div class="row">
         @if(Model.GorevTurleri != null)
        {
            @foreach(var item in Model.GorevTurleri)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="gorev_@item.Id" value="@item.Id" name="SeciliGorevTuruIdleri" @(Model.SeciliGorevTuruIdleri != null && Model.SeciliGorevTuruIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="gorev_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
      </div>
      <button type="button" class="btn btn-primary mt-3" id="next4">İlerle</button>
    </div>
  </div>

  <!-- TAB5 Yapılan İş Niteliği -->
  <div id="tab5" class="tab-content">
    <h2>Yapılan İş Niteliği</h2>
    <div class="mb-4">
        <div class="row">
         @if(Model.IsNitelikleri != null)
        {
            @foreach(var item in Model.IsNitelikleri)
            {
                <div class="col-md-3 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_@item.Id" value="@item.Id" name="SeciliIsNiteligiIdleri" @(Model.SeciliIsNiteligiIdleri != null && Model.SeciliIsNiteligiIdleri.Contains(item.Id) ? "checked" : "")>
                        <label class="form-check-label" for="is_@item.Id">@item.Ad</label>
                    </div>
                </div>
            }
        }
        </div>
      <button type="button" class="btn btn-primary mt-3" id="next5">İlerle</button>
    </div>
  </div>

  <div id="tab6" class="tab-content">
  <p class="text-muted">
    Diğer sekmelerde kaydedilen bilgiler aşağıdaki tabloda özetlenir.
  </p>
  <div class="text-center mb-4">
  <div class="photo-preview-container mx-auto" id="controlContainer">
      <i class='bx bx-user'></i>
      <img id="kontrolFoto" src="" alt="Personel Fotoğrafı" />
  </div>
  <p class="mt-2 fw-bold">Personel Fotoğrafı</p>
</div>

  <table class="table table-bordered table-sm">
    <thead>
      <tr>
        <th>ALANLAR</th>
        <th>DEĞERLER</th>
      </tr>
    </thead>
    <tbody id="kontrolTableBody">
      <!-- JS ile doldurulacak -->
    </tbody>
  </table>

  <div class="d-grid gap-2 mt-4">
    <button type="submit" class="btn btn-success btn-lg">Kaydet</button>
  </div>

  </div>

  </form>
  <!-- Modal: Duplicate Error (TC & Email) -->
  <div class="modal fade" id="tcDuplicateModal" tabindex="-1" aria-labelledby="tcDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="tcDuplicateModalLabel">
              @if(TempData["ModalTitle"] != null) { @TempData["ModalTitle"] } 
              else { <text>Kayıt Hatası</text> }
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            @if(TempData["ModalItems"] != null)
            {
                <ul>
                    @foreach(var item in TempData["ModalItems"].ToString().Split('|'))
                    {
                        <li>@item</li>
                    }
                </ul>
            }
            else if(TempData["TcDuplicateError"] != null)
            {
                 <p>@TempData["TcDuplicateError"]</p>
            }
            else
            {
                 <p>Benzer bir kayıt sistemde zaten mevcut.</p>
            }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnFixTc">Tamam (Düzelt)</button>
        </div>
      </div>
    </div>
  </div>

</div> <!-- /tabs-container -->

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll(".tab-btn");
        const contents = document.querySelectorAll(".tab-content");

        // --- YENİ EKLENEN FONKSİYON: Özet Tablosunu Doldur ---
        function fillKontrolOzet() {
            const tbody = document.getElementById("kontrolTableBody");
            if (!tbody) return;
            tbody.innerHTML = ""; // Temizle

            const addRow = (label, value) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${label}</td><td>${value && value.trim() !== "" ? value : "-"}</td>`;
                tbody.appendChild(tr);
            };

            // 1. Text Değerler
            const ad = document.getElementById("personelAdi")?.value || "";
            const soyad = document.getElementById("personelSoyadi")?.value || "";
            addRow("Ad Soyad", `${ad} ${soyad}`);

            addRow("TcKimlikNo", document.getElementById("personelTcKimlik")?.value);
            addRow("Telefon", document.getElementById("personeltelefon")?.value);
            addRow("Eposta", document.getElementById("personelemail")?.value);
            addRow("KadroKurum", document.getElementById("personelKadroKurum")?.value);

            // 2. Select Değerler
            const gorevliIl = document.getElementById("personelgorevli_il");
            if (gorevliIl && gorevliIl.selectedIndex > 0) {
                 addRow("GorevliIl", gorevliIl.options[gorevliIl.selectedIndex].text);
            } else {
                 addRow("GorevliIl", "-");
            }

            const brans = document.getElementById("personelBrans");
            if (brans && brans.selectedIndex > 0) {
                addRow("Brans", brans.options[brans.selectedIndex].text);
            } else {
                 addRow("Brans", "-");
            }

            // 3. Checkbox / Radio
            const aktifMi = document.getElementById("gorevAktif")?.checked ? "Aktif" : "Pasif";
            addRow("Görev Aktiflik", aktifMi);

            let cinsiyet = "-";
            if (document.getElementById("cinsiyetKadin")?.checked) cinsiyet = "Kadın";
            else if (document.getElementById("cinsiyetErkek")?.checked) cinsiyet = "Erkek";
            addRow("PersonelCinsiyet", cinsiyet);

            // 4. Çoklu Checkbox Listeleri (Label okuma)
            const getLabels_ = (name) => {
                const checkedInputs = document.querySelectorAll(`input[name="${name}"]:checked`);
                if (checkedInputs.length === 0) return "-";
                
                const labels = [];
                checkedInputs.forEach(input => {
                    const id = input.id;
                    // Label'ı bul (for attr ile)
                    const labelEl = document.querySelector(`label[for="${id}"]`);
                    if (labelEl) {
                        labels.push(labelEl.textContent.trim());
                    }
                });
                return labels.join(", ");
            };

            addRow("Seçili Yazılımlar", getLabels_("SeciliYazilimIdleri"));
            addRow("Seçili Uzmanlıklar", getLabels_("SeciliUzmanlikIdleri"));
            addRow("Seçili Görev Türleri", getLabels_("SeciliGorevTuruIdleri"));
            addRow("Seçili İş Nitelikleri", getLabels_("SeciliIsNiteligiIdleri"));
        }

        function activateTab(tabId) {
          buttons.forEach((b) => {
            const isActive = b.getAttribute("data-tab") === tabId;
            b.classList.toggle("active", isActive);
          });
          contents.forEach((c) => {
            c.classList.toggle("active", c.id === tabId);
          });

          // Eğer kontrol sekmesine geçildiyse tabloyu doldur
          if (tabId === "tab6") {
              fillKontrolOzet();
          }
        }

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const tabId = btn.getAttribute("data-tab");
            activateTab(tabId);
          });
        });

        // Form elemanlarında değişiklik olduğunda eğer tab6 aktifse anında güncelle
        const formElements = document.querySelectorAll("input, select, textarea");
        formElements.forEach(el => {
            // Hem input (yazarken) hem change (değişince) dinleyelim
            el.addEventListener("input", () => {
                if(document.getElementById("tab6").classList.contains("active")) {
                    fillKontrolOzet();
                }
            });
            el.addEventListener("change", () => {
                if(document.getElementById("tab6").classList.contains("active")) {
                    fillKontrolOzet();
                }
            });
        });


        const nextBtns = [1, 2, 3, 4, 5];
        nextBtns.forEach(i => {
            const btn = document.getElementById("next" + i);
            if(btn) {
                btn.addEventListener("click", () => {
                    activateTab("tab" + (i+1));
                });
            }
        });

        // Fotoğraf Önizleme
        const photoInput = document.getElementById("personelFoto");
        const previewImg = document.getElementById("photoPreview");
        
        // Control tab elements
        const controlImg = document.getElementById("kontrolFoto");

        // Hidden input for Base64 Persistence
        const hiddenBase64 = document.getElementById("FotografBase64");
        
        function updateContainer(imgElement) {
            if(!imgElement) return;
            // Kardeş icon elementini bul ve gizle
            const container = imgElement.parentElement;
            const icon = container.querySelector("i");
            if(icon) icon.style.display = "none";
            
            // Resmi göster
            imgElement.style.display = "block";
        }

        // Fotoğraf Restore Fonksiyonu (Base64'ten)
        function restorePhotoFromHidden() {
            if(hiddenBase64 && hiddenBase64.value) {
                const base64 = hiddenBase64.value;
                if(previewImg) {
                    previewImg.src = base64;
                    updateContainer(previewImg);
                }
                if(controlImg) {
                    controlImg.src = base64;
                    updateContainer(controlImg);
                }
            }
        }
        
        // Sayfa yüklendiğinde (örn validation hatası sonrası) fotoyu geri yükle
        restorePhotoFromHidden();

        if(photoInput) {
            photoInput.addEventListener("change", function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const result = e.target.result;

                        // Base64'ü hidden input'a kaydet (Persistence için)
                        if(hiddenBase64) {
                            hiddenBase64.value = result;
                        }
                        
                        if(previewImg) {
                            previewImg.src = result;
                            updateContainer(previewImg);
                        }
                        
                        if(controlImg) {
                            controlImg.src = result;
                            updateContainer(controlImg);
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // --- DUPLICATE TC / MODAL LOGIC ---
        // Backend'den gelen ShowErrorModal bayrağı kontrol ediliyor
        const showErrorModal = '@TempData["ShowUserExistsModal"]'; // Updated key
        // Backward compatibility for basic check
        const oldShowModal = '@TempData["ShowErrorModal"]';
        
        const openTab = '@TempData["OpenTab"]';
        const focusId = '@TempData["FocusId"]';

        if (showErrorModal === '1' || oldShowModal === '1') {
            const modalEl = document.getElementById('tcDuplicateModal');
            if (modalEl) {
                // Bootstrap modal varsa kullan
                // Projede bootstrap.js yüklü kabul ediyoruz
                try {
                    const modal = new bootstrap.Modal(modalEl, {
                        backdrop: 'static',
                        keyboard: false
                    });
                    modal.show();

                    // "Tamam (Düzelt)" butonu
                    const btnFix = document.getElementById('btnFixTc');
                    if(btnFix){
                        btnFix.addEventListener('click', () => {
                            modal.hide();
                            
                            // Modal animasyonu bitince odaklan
                            setTimeout(() => {
                                handleTabAndFocus();
                            }, 500); 
                        });
                    }
                    
                    // Modal manuel kapanırsa da aynı işlemi yap
                    modalEl.addEventListener('hidden.bs.modal', function () {
                        handleTabAndFocus();
                    });

                } catch (e) {
                    // Fallback: Bootstrap JS yoksa veya hata olursa manuel göster (Overlay)
                    console.warn("Bootstrap modal yüklenemedi, fallback kullanılıyor.", e);
                    alert("Kayıt Hatası: Bu kullanıcı sistemde zaten mevcut.");
                    handleTabAndFocus();
                }
            } else {
                handleTabAndFocus();
            }
        } 
        else if (openTab) {
            // Modal yok ama tab set edilmişse
            activateTab(openTab);
        }

        function handleTabAndFocus() {
            if (openTab) {
                activateTab(openTab);
            }
            if (focusId) {
                const el = document.getElementById(focusId);
                if (el) {
                    el.focus();
                    if(el.select) el.select(); // Değeri seç
                }
            }
            // Fotoğrafı tekrar çiz (önlem olarak, tab geçişi bazen bozabilir)
            restorePhotoFromHidden();
        }

      });
    </script>
}
@model PersonelTakipSistemi.ViewModels.PersonelIndexViewModel
@{
    ViewData["Title"] = "Personel Listesi";
}

@section Styles {

  <style>
      .select2-container .select2-selection--single {
          height: 38px;
          border: 1px solid #ced4da;
          display: flex;
          align-items: center;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
          top: 6px;
      }
  </style>
}

<div class="card mb-4">
    <div class="card-body">
        <form asp-action="Index" method="get" id="filterForm">
            
            <!-- SATIR 1: Ad/Soyad, T.C., İl -->
            <div class="row g-3">
                 <div class="col-12 col-lg-4">
                    <label class="form-label">Ad / Soyad</label>
                    <input type="text" class="form-control" asp-for="Filter.SearchName" placeholder="Ad veya Soyad ara..." />
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">TC Kimlik No</label>
                     <input type="text" class="form-control" asp-for="Filter.TcKimlikNo" placeholder="TC Kimlik No..." />
                </div>
                 <div class="col-12 col-lg-2">
                    <label class="form-label">Görevli İl</label>
                    <select class="form-select select2" asp-for="Filter.GorevliIlId">
                        <option value="">İl Seçiniz...</option>
                        @foreach (var x in Model.Lookups.Iller) { <option value="@x.Id">@x.Ad</option> }
                    </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">Branş</label>
                    <select class="form-select select2" asp-for="Filter.BransId">
                        <option value="">Branş Seçiniz...</option>
                        @foreach (var x in Model.Lookups.Branslar) { <option value="@x.Id">@x.Ad</option> }
                    </select>
                </div>
            </div>

            <!-- SATIR 2: Teşkilat > Koordinatörlük > Komisyon (Cascading) -->
             <div class="row g-3 mt-1">
                 <div class="col-12 col-lg-4">
                    <label class="form-label">Teşkilat</label>
                    <select class="form-select select2" asp-for="Filter.TeskilatId" id="filterTeskilatId">
                        <option value="">Teşkilat Seçiniz...</option>
                        @foreach (var x in Model.Lookups.Teskilatlar) { <option value="@x.Id">@x.Ad</option> }
                    </select>
                </div>
                <div class="col-12 col-lg-4">
                    <label class="form-label">Koordinatörlük</label>
                    <select class="form-select select2" asp-for="Filter.KoordinatorlukId" id="filterKoordinatorlukId">
                        <option value="">Koordinatörlük Seçiniz...</option>
                        @if(Model.Lookups.Koordinatorlukler != null)
                        {
                            foreach(var k in Model.Lookups.Koordinatorlukler)
                            {
                                <!-- Only show if matched or all? For cascading, JS handles mostly, 
                                     but on persistent reload we need to keep selected option valid. -->
                                <option value="@k.Id">@k.Ad</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-12 col-lg-4">
                    <label class="form-label">Komisyon</label>
                    <select class="form-select select2" asp-for="Filter.KomisyonId" id="filterKomisyonId">
                        <option value="">Komisyon Seçiniz...</option>
                        @if(Model.Lookups.Komisyonlar != null)
                        {
                            foreach(var k in Model.Lookups.Komisyonlar)
                            {
                                <option value="@k.Id">@k.Ad</option>
                            }
                        }
                    </select>
                </div>
             </div>

            <!-- SATIR 2: Yazılımlar, Uzmanlıklar, Görev Türü, İş Niteliği -->
            <div class="row g-3 mt-1">
                <div class="col-12 col-lg-3">
                     <label class="form-label">Kullanılan Yazılımlar</label>
                     <select class="form-select select2" name="Filter.SeciliYazilimIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.Yazilimlar)
                        {
                            if (Model.Filter.SeciliYazilimIdleri != null && Model.Filter.SeciliYazilimIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">Uzmanlık</label>
                     <select class="form-select select2" name="Filter.SeciliUzmanlikIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.Uzmanliklar)
                        {
                            if (Model.Filter.SeciliUzmanlikIdleri != null && Model.Filter.SeciliUzmanlikIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">Görev Türü</label>
                     <select class="form-select select2" name="Filter.SeciliGorevTuruIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.GorevTurleri)
                        {
                            if (Model.Filter.SeciliGorevTuruIdleri != null && Model.Filter.SeciliGorevTuruIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">İş Niteliği</label>
                     <select class="form-select select2" name="Filter.SeciliIsNiteligiIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.IsNitelikleri)
                        {
                            if (Model.Filter.SeciliIsNiteligiIdleri != null && Model.Filter.SeciliIsNiteligiIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
            </div>

            <!-- SATIR 3: Doğum Tarihi + Butonlar -->
            <div class="row g-3 mt-1 align-items-end">
                <div class="col-12 col-lg-3">
                     <label class="form-label">Doğum Tarihi (Başlangıç)</label>
                     <input type="date" class="form-control" asp-for="Filter.DogumBaslangic" />
                </div>
                <div class="col-12 col-lg-auto ms-auto d-flex gap-2">
                    <div>
                        <label class="form-label d-block">&nbsp;</label>
                        <button type="button" class="btn btn-danger d-none" id="bulkDeleteBtn" onclick="bulkDelete()">
                            <i class="bx bx-trash"></i> Seçilenleri Sil (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
                <div class="col-12 col-lg-auto d-flex gap-2">
                    <div>
                        <label class="form-label d-block">&nbsp;</label>
                        <a href="/Personel/Index" class="btn btn-outline-secondary w-100">Temizle</a>
                    </div>
                    <div>
                        <label class="form-label d-block">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">Filtrele</button>
                    </div>
                </div>
            </div>

            <input type="hidden" name="Filter.Page" value="1" id="pageInput" />
            <input type="hidden" name="Filter.PageSize" value="@Model.Filter.PageSize" />
        </form>
    </div>
</div>

<div class="card">
    <div class="table-responsive text-nowrap">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th>Foto</th>
                    <th>Ad Soyad</th>
                    <th>Kullanılan Yazılımlar</th>
                    <th>Uzmanlık</th>
                    <th>Görev Türü</th>
                    <th>İş Niteliği</th> 
                    <th>Görevli İl</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody class="table-border-bottom-0">
                @foreach (var item in Model.Results)
                {
                    <tr style="cursor: pointer; @(!item.AktifMi ? "opacity: 0.6; background-color: #f8f9fa;" : "")" onclick="if(!event.target.classList.contains('form-check-input')) window.location.href='/Personel/Detay/@item.PersonelId'">
                         <td>
                            <input type="checkbox" class="form-check-input select-item" value="@item.PersonelId" onchange="updateBulkActionState(event)">
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.FotografYolu))
                            {
                                <img src="@item.FotografYolu" alt="Avatar" class="rounded-circle" width="32" height="32" />
                            }
                            else
                            {
                                <div class="avatar avatar-xs">
                                     <span class="avatar-initial rounded-circle bg-label-primary">@item.AdSoyad.Substring(0,1)</span>
                                </div>
                            }
                        </td>
                        <td><strong>@item.AdSoyad</strong></td>
                        <td>
                            @if(item.Yazilimlar != null && item.Yazilimlar.Any())
                            {
                                var visibleCount = 1;
                                var all = item.Yazilimlar;
                                
                                if (all.Count <= visibleCount)
                                {
                                    foreach(var y in all)
                                    {
                                        <span class="badge bg-label-primary me-1">@y</span>
                                    }
                                }
                                else
                                {
                                    // İlk 3 kayıt
                                    for(int i = 0; i < visibleCount; i++)
                                    {
                                        <span class="badge bg-label-primary me-1">@all[i]</span>
                                    }
                                    
                                    // AÇMA BUTONU (...) - Başlangıçta görünür
                                    <span class="badge bg-label-primary cursor-pointer show-more-btn" 
                                          style="cursor:pointer;" 
                                          onclick="toggleContainer(this)">...</span>
                                          
                                    // GİZLİ KISIM
                                    <div class="d-none mt-1 extended-container" style="line-height: 2;">
                                        @for(int i = visibleCount; i < all.Count; i++)
                                        {
                                            <span class="badge bg-label-primary me-1">@all[i]</span>
                                        }
                                        
                                        <span class="badge bg-secondary cursor-pointer" 
                                              style="cursor:pointer;" 
                                              onclick="toggleContainer(this)">X</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(item.Uzmanliklar != null && item.Uzmanliklar.Any())
                            {
                                var visibleCount = 1;
                                var all = item.Uzmanliklar;
                                if (all.Count <= visibleCount)
                                {
                                    foreach(var u in all)
                                    {
                                        <span class="badge bg-label-info me-1">@u</span>
                                    }
                                }
                                else
                                {
                                    for(int i = 0; i < visibleCount; i++)
                                    {
                                        <span class="badge bg-label-info me-1">@all[i]</span>
                                    }
                                    
                                    <span class="badge bg-label-info cursor-pointer show-more-btn" 
                                          style="cursor:pointer;" 
                                          onclick="toggleContainer(this)">...</span>
                                          
                                    <div class="d-none mt-1 extended-container" style="line-height: 2;">
                                        @for(int i = visibleCount; i < all.Count; i++)
                                        {
                                            <span class="badge bg-label-info me-1">@all[i]</span>
                                        }
                                        <span class="badge bg-secondary cursor-pointer" 
                                              style="cursor:pointer;" 
                                              onclick="toggleContainer(this)">X</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(item.GorevTurleri != null && item.GorevTurleri.Any())
                            {
                                var visibleCount = 1;
                                var all = item.GorevTurleri;
                                if (all.Count <= visibleCount)
                                {
                                    foreach(var g in all)
                                    {
                                        <span class="badge bg-label-secondary me-1">@g</span>
                                    }
                                }
                                else
                                {
                                    for(int i = 0; i < visibleCount; i++)
                                    {
                                        <span class="badge bg-label-secondary me-1">@all[i]</span>
                                    }
                                    
                                    <span class="badge bg-label-secondary cursor-pointer show-more-btn" 
                                          style="cursor:pointer;" 
                                          onclick="toggleContainer(this)">...</span>
                                          
                                    <div class="d-none mt-1 extended-container" style="line-height: 2;">
                                        @for(int i = visibleCount; i < all.Count; i++)
                                        {
                                            <span class="badge bg-label-secondary me-1">@all[i]</span>
                                        }
                                        <span class="badge bg-secondary cursor-pointer" 
                                              style="cursor:pointer;" 
                                              onclick="toggleContainer(this)">X</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(item.IsNitelikleri != null && item.IsNitelikleri.Any())
                            {
                                var visibleCount = 1;
                                var all = item.IsNitelikleri;
                                if (all.Count <= visibleCount)
                                {
                                    foreach(var n in all)
                                    {
                                        <span class="badge bg-label-warning me-1">@n</span>
                                    }
                                }
                                else
                                {
                                    for(int i = 0; i < visibleCount; i++)
                                    {
                                        <span class="badge bg-label-warning me-1">@all[i]</span>
                                    }
                                    
                                    <span class="badge bg-label-warning cursor-pointer show-more-btn" 
                                          style="cursor:pointer;" 
                                          onclick="toggleContainer(this)">...</span>
                                          
                                    <div class="d-none mt-1 extended-container" style="line-height: 2;">
                                        @for(int i = visibleCount; i < all.Count; i++)
                                        {
                                            <span class="badge bg-label-warning me-1">@all[i]</span>
                                        }
                                        <span class="badge bg-secondary cursor-pointer" 
                                              style="cursor:pointer;" 
                                              onclick="toggleContainer(this)">X</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>@item.GorevliIl</td>
                        <td>
                            @if (item.AktifMi)
                            {
                                <span class="badge bg-label-success me-1">Aktif</span>
                            }
                            else
                            {
                                <span class="badge status-passive me-1">Pasif</span>
                            }
                        </td>
                    </tr>
                }
                @if (!Model.Results.Any())
                {
                    <tr>
                        <td colspan="9" class="text-center py-4">Kayıt bulunamadı.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <!-- Smart Pagination -->
    @if (Model.Pagination.TotalPages > 1)
    {
        var currentPage = Model.Pagination.CurrentPage;
        var totalPages = Model.Pagination.TotalPages;
        var startPage = Math.Max(1, currentPage - 2);
        var endPage = Math.Min(totalPages, currentPage + 2);

        <div class="card-footer d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <!-- Previous -->
                    <li class="page-item @(Model.Pagination.HasPreviousPage ? "" : "disabled")">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(@(currentPage - 1))">«</a>
                    </li>

                    <!-- First Page -->
                    @if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);" onclick="changePage(1)">1</a>
                        </li>
                        @if (startPage > 2)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                    }

                    <!-- Page Numbers -->
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" href="javascript:void(0);" onclick="changePage(@i)">@i</a>
                        </li>
                    }

                    <!-- Last Page -->
                    @if (endPage < totalPages)
                    {
                        @if (endPage < totalPages - 1)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);" onclick="changePage(@totalPages)">@totalPages</a>
                        </li>
                    }

                    <!-- Next -->
                    <li class="page-item @(Model.Pagination.HasNextPage ? "" : "disabled")">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(@(currentPage + 1))">»</a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

<script>
    function changePage(page) {
        document.getElementById('pageInput').value = page;
        document.getElementById('filterForm').submit();
    }
    
    function toggleContainer(element) {
        if (event) event.stopPropagation();
        
        // Eğer tıklanan element "..." (show-more-btn) ise:
        if (element.classList.contains('show-more-btn')) {
            var container = element.nextElementSibling; // div.extended-container
            if(container) {
                element.classList.add('d-none'); // "..." gizle
                container.classList.remove('d-none'); // Listeyi aç
            }
        } 
        // Eğer tıklanan element "X" ise (kapatma butonu):
        else {
            var container = element.parentElement; // div.extended-container
            var showBtn = container.previousElementSibling; // span.show-more-btn
            
            container.classList.add('d-none'); // Listeyi gizle
            if(showBtn) {
                showBtn.classList.remove('d-none'); // "..." göster
            }
        }
    }
    
    // Dropdown checkbox'larına tıklandığında dropdown kapanmasın
    document.querySelectorAll('.dropdown-menu').forEach(function(element){
        element.addEventListener('click', function (e) {
          e.stopPropagation();
        });
    });

    // --- BULK ACTION SCRIPTS ---
    
    document.addEventListener('DOMContentLoaded', function() {
        // Select All handler
        document.getElementById('selectAll').addEventListener('change', function() {
           var checkboxes = document.querySelectorAll('.select-item');
           var isChecked = this.checked;
           checkboxes.forEach(function(cb) {
               cb.checked = isChecked;
           });
           updateBulkActionState();
        });
    });

    function updateBulkActionState(e) {
        if(e) e.stopPropagation();
        var selectedCount = document.querySelectorAll('.select-item:checked').length;
        var btn = document.getElementById('bulkDeleteBtn');
        var countSpan = document.getElementById('selectedCount');
        
        if(selectedCount > 0) {
            btn.classList.remove('d-none');
            countSpan.innerText = selectedCount;
        } else {
            btn.classList.add('d-none');
        }
    }

    function bulkDelete() {
        var selectedIds = [];
        document.querySelectorAll('.select-item:checked').forEach(function(cb) {
            selectedIds.push(parseInt(cb.value));
        });

        if (selectedIds.length === 0) return;

        Swal.fire({
            title: 'Toplu Silme',
            text: selectedIds.length + " personel silinecek (pasife alınacak). Emin misiniz?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, Sil!',
            cancelButtonText: 'İptal'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Personel/TopluSil',
                    type: 'POST',
                    data: JSON.stringify(selectedIds),
                    contentType: 'application/json; charset=utf-8',
                    success: function(response) {
                        if (response.success) {
                            Swal.fire('Başarılı', response.message, 'success')
                            .then(() => location.reload());
                        } else {
                            Swal.fire('Hata', response.message, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        var errMsg = "İşlem sırasında bir hata oluştu.";
                        if(xhr.responseJSON && xhr.responseJSON.message) {
                            errMsg = xhr.responseJSON.message;
                        } else if(xhr.responseText) {
                             // Try to parse if it's not JSON (e.g. IIS error page)
                             try {
                                 var json = JSON.parse(xhr.responseText);
                                 if(json.message) errMsg = json.message;
                             } catch(e) {
                                 // Use status text if available
                                 errMsg += " (" + (error || status) + ")";
                                 console.error("Server Error:", xhr.responseText);
                             }
                        }
                        Swal.fire('Hata', errMsg, 'error');
                    }
                });
            }
        });
    }
</script>

@section Scripts {

    <script>
      $(document).ready(function() {
          $('.select2').select2({
              width: '100%',
              placeholder: 'Seçiniz...',
              allowClear: false,
              language: {
                    noResults: function () {
                        return "Sonuç bulunamadı";
                    }
                }
          });

          // --- Cascading Filter Logic ---
          
          // 1. Teşkilat -> Koordinatörlük
          $('#filterTeskilatId').on('change', function() {
              var teskilatId = $(this).val();
              var $koordSelect = $('#filterKoordinatorlukId');
              var $komSelect = $('#filterKomisyonId');
              
              $koordSelect.empty().append('<option value="">Yükleniyor...</option>');
              $komSelect.empty().append('<option value="">Önce Koordinatörlük Seçiniz...</option>');
              
              if(teskilatId) {
                  $.getJSON('/Personel/GetKoordinatorluklerByTeskilat', { teskilatId: teskilatId }, function(data) {
                      $koordSelect.empty().append('<option value="">Koordinatörlük Seçiniz...</option>');
                      $.each(data, function(i, item) {
                          $koordSelect.append($('<option>', { 
                              value: item.id,
                              text: item.text 
                          }));
                      });
                      $koordSelect.trigger('change.select2'); 
                      // Need to trigger select2 update manually or rebuild? 
                      // Logic usually: Just updating DOM <option> then triggering change is enough for standard selects,
                      // but Select2 needs to simply read the new DOM options. Usually re-init is NOT needed, just change event.
                      // Note: trigger('change') might trigger the NEXT cascade (Koordinatorluk->Komisyon).
                      // If we cleared it, that's fine.
                  });
              } else {
                  $koordSelect.empty().append('<option value="">Önce Teşkilat Seçiniz...</option>');
                  $komSelect.empty().append('<option value="">Önce Koordinatörlük Seçiniz...</option>');
              }
          });

          // 2. Koordinatörlük -> Komisyon
          $('#filterKoordinatorlukId').on('change', function() {
              var koordId = $(this).val();
              var $komSelect = $('#filterKomisyonId');
              
              if(koordId) {
                  $komSelect.empty().append('<option value="">Yükleniyor...</option>');
                   $.getJSON('/Personel/GetKomisyonlarByKoordinatorluk', { koordinatorlukId: koordId }, function(data) {
                      $komSelect.empty().append('<option value="">Komisyon Seçiniz...</option>');
                      $.each(data, function(i, item) {
                          $komSelect.append($('<option>', { 
                              value: item.id,
                              text: item.text 
                          }));
                      });
                  });
              } else {
                  // If cleared, clear children?
                  // Maybe check if Teşkilat is still selected? 
                  // If Koord cleared but Teskilat selected, Komisyon should be effectively cleared or maybe "All" depending on rule.
                  // Usually: Clear Komisyon.
                  $komSelect.empty().append('<option value="">Önce Koordinatörlük Seçiniz...</option>');
              }
          });

      });
    </script>
}

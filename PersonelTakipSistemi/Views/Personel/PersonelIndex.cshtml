@model PersonelTakipSistemi.ViewModels.PersonelIndexViewModel
@{
    ViewData["Title"] = "Personel Listesi";
}

@section Styles {
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
      .select2-container .select2-selection--single {
          height: 38px;
          border: 1px solid #ced4da;
          display: flex;
          align-items: center;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
          top: 6px;
      }
  </style>
}

<div class="card mb-4">
    <div class="card-body">
        <form asp-action="Index" method="get" id="filterForm">
            
            <!-- SATIR 1: Ad/Soyad, TC, İl, Branş -->
            <div class="row g-3">
                <div class="col-12 col-lg-3">
                    <label class="form-label">Ad / Soyad</label>
                    <input type="text" class="form-control" asp-for="Filter.SearchName" placeholder="Ad veya Soyad ara..." />
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">TC Kimlik No</label>
                     <input type="text" class="form-control" asp-for="Filter.TcKimlikNo" placeholder="TC Kimlik No..." />
                </div>
                <div class="col-12 col-lg-3">
                    <label class="form-label">Görevli İl</label>
                    <select class="form-select select2" asp-for="Filter.GorevliIlId">
                        <option value="">İl Seçiniz...</option>
                        @foreach (var x in Model.Lookups.Iller) { <option value="@x.Id">@x.Ad</option> }
                    </select>
                </div>
                <div class="col-12 col-lg-3">
                    <label class="form-label">Branş</label>
                    <select class="form-select select2" asp-for="Filter.BransId">
                        <option value="">Branş Seçiniz...</option>
                        @foreach (var x in Model.Lookups.Branslar) { <option value="@x.Id">@x.Ad</option> }
                    </select>
                </div>
            </div>

            <!-- SATIR 2: Yazılımlar, Uzmanlıklar, Görev Türü, İş Niteliği -->
            <div class="row g-3 mt-1">
                <div class="col-12 col-lg-3">
                     <label class="form-label">Kullanılan Yazılımlar</label>
                     <select class="form-select select2" name="Filter.SeciliYazilimIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.Yazilimlar)
                        {
                            if (Model.Filter.SeciliYazilimIdleri != null && Model.Filter.SeciliYazilimIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">Uzmanlık</label>
                     <select class="form-select select2" name="Filter.SeciliUzmanlikIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.Uzmanliklar)
                        {
                            if (Model.Filter.SeciliUzmanlikIdleri != null && Model.Filter.SeciliUzmanlikIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">Görev Türü</label>
                     <select class="form-select select2" name="Filter.SeciliGorevTuruIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.GorevTurleri)
                        {
                            if (Model.Filter.SeciliGorevTuruIdleri != null && Model.Filter.SeciliGorevTuruIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
                <div class="col-12 col-lg-3">
                     <label class="form-label">İş Niteliği</label>
                     <select class="form-select select2" name="Filter.SeciliIsNiteligiIdleri" multiple="multiple">
                        @foreach (var item in Model.Lookups.IsNitelikleri)
                        {
                            if (Model.Filter.SeciliIsNiteligiIdleri != null && Model.Filter.SeciliIsNiteligiIdleri.Contains(item.Id))
                            {
                                <option value="@item.Id" selected="selected">@item.Ad</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Ad</option>
                            }
                        }
                     </select>
                </div>
            </div>

            <!-- SATIR 3: Doğum Tarihi + Butonlar -->
            <div class="row g-3 mt-1 align-items-end">
                <div class="col-12 col-lg-3">
                     <label class="form-label">Doğum Tarihi (Başlangıç)</label>
                     <input type="date" class="form-control" asp-for="Filter.DogumBaslangic" />
                </div>
                <div class="col-12 col-lg-auto">
                    <label class="form-label d-block">&nbsp;</label>
                    <a href="/Personel/Index" class="btn btn-outline-secondary w-100">Temizle</a>
                </div>
                <div class="col-12 col-lg-auto">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">Filtrele</button>
                </div>
            </div>

            <input type="hidden" name="Filter.Page" value="1" id="pageInput" />
            <input type="hidden" name="Filter.PageSize" value="@Model.Filter.PageSize" />
        </form>
    </div>
</div>

<div class="card">
    <div class="table-responsive text-nowrap">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Foto</th>
                    <th>Ad Soyad</th>
                    <th>Kullanılan Yazılımlar</th>
                    <th>Uzmanlık</th>
                    <th>Görev Türü</th>
                    <th>İş Niteliği</th> 
                    <th>Görevli İl</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody class="table-border-bottom-0">
                @foreach (var item in Model.Results)
                {
                    <tr style="cursor: pointer;" onclick="window.location.href='/Personel/Detay/@item.PersonelId'">
                        <td>
                            @if (!string.IsNullOrEmpty(item.FotografYolu))
                            {
                                <img src="@item.FotografYolu" alt="Avatar" class="rounded-circle" width="32" height="32" />
                            }
                            else
                            {
                                <div class="avatar avatar-xs">
                                     <span class="avatar-initial rounded-circle bg-label-primary">@item.AdSoyad.Substring(0,1)</span>
                                </div>
                            }
                        </td>
                        <td><strong>@item.AdSoyad</strong></td>
                        <td>
                            @if(item.Yazilimlar != null && item.Yazilimlar.Any())
                            {
                                var visibleCount = 3;
                                var all = item.Yazilimlar;
                                
                                if (all.Count <= visibleCount)
                                {
                                    foreach(var y in all)
                                    {
                                        <span class="badge bg-label-primary me-1">@y</span>
                                    }
                                }
                                else
                                {
                                    // İlk 3 kayıt
                                    for(int i = 0; i < visibleCount; i++)
                                    {
                                        <span class="badge bg-label-primary me-1">@all[i]</span>
                                    }
                                    
                                    // AÇMA BUTONU (...) - Başlangıçta görünür
                                    <span class="badge bg-label-primary cursor-pointer show-more-btn" 
                                          style="cursor:pointer;" 
                                          onclick="toggleSoftwareContainer(this)">...</span>
                                          
                                    // GİZLİ KISIM
                                    <div class="d-none mt-1 software-extended-container" style="line-height: 2;">
                                        @for(int i = visibleCount; i < all.Count; i++)
                                        {
                                            <span class="badge bg-label-primary me-1">@all[i]</span>
                                        }
                                        
                                        <span class="badge bg-secondary cursor-pointer" 
                                              style="cursor:pointer;" 
                                              onclick="toggleSoftwareContainer(this)">X</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(item.Uzmanliklar != null && item.Uzmanliklar.Any())
                            {
                                foreach(var u in item.Uzmanliklar)
                                {
                                    <span class="badge bg-label-info me-1">@u</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(item.GorevTurleri != null && item.GorevTurleri.Any())
                            {
                                foreach(var g in item.GorevTurleri)
                                {
                                    <span class="badge bg-label-secondary me-1">@g</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(item.IsNitelikleri != null && item.IsNitelikleri.Any())
                            {
                                foreach(var n in item.IsNitelikleri)
                                {
                                    <span class="badge bg-label-warning me-1">@n</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>@item.GorevliIl</td>
                        <td>
                            @if (item.AktifMi)
                            {
                                <span class="badge bg-label-success me-1">Aktif</span>
                            }
                            else
                            {
                                <span class="badge bg-label-secondary me-1">Pasif</span>
                            }
                        </td>
                    </tr>
                }
                @if (!Model.Results.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center py-4">Kayıt bulunamadı.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    @if (Model.Pagination.TotalPages > 1)
    {
        <div class="card-footer d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li class="page-item @(Model.Pagination.HasPreviousPage ? "" : "disabled")">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(@(Model.Pagination.CurrentPage - 1))">Önceki</a>
                    </li>
                    
                    @for (int i = 1; i <= Model.Pagination.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.Pagination.CurrentPage ? "active" : "")">
                            <a class="page-link" href="javascript:void(0);" onclick="changePage(@i)">@i</a>
                        </li>
                    }
                    
                    <li class="page-item @(Model.Pagination.HasNextPage ? "" : "disabled")">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(@(Model.Pagination.CurrentPage + 1))">Sonraki</a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

<script>
    function changePage(page) {
        document.getElementById('pageInput').value = page;
        document.getElementById('filterForm').submit();
    }
    
    function toggleSoftwareContainer(element) {
        if (event) event.stopPropagation();
        
        // Eğer tıklanan element "..." (show-more-btn) ise:
        if (element.classList.contains('show-more-btn')) {
            var container = element.nextElementSibling; // div.software-extended-container
            if(container) {
                element.classList.add('d-none'); // "..." gizle
                container.classList.remove('d-none'); // Listeyi aç
            }
        } 
        // Eğer tıklanan element "X" ise (kapatma butonu):
        else {
            var container = element.parentElement; // div.software-extended-container
            var showBtn = container.previousElementSibling; // span.show-more-btn
            
            container.classList.add('d-none'); // Listeyi gizle
            if(showBtn) {
                showBtn.classList.remove('d-none'); // "..." göster
            }
        }
    }
    
    // Dropdown checkbox'larına tıklandığında dropdown kapanmasın
    document.querySelectorAll('.dropdown-menu').forEach(function(element){
        element.addEventListener('click', function (e) {
          e.stopPropagation();
        });
    });
</script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      $(document).ready(function() {
          $('.select2').select2({
              width: '100%',
              placeholder: 'Seçiniz...',
              allowClear: true,
              language: {
                    noResults: function () {
                        return "Sonuç bulunamadı";
                    }
                }
          });
      });
    </script>
}

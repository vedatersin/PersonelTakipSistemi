@model PersonelTakipSistemi.Models.ViewModels.YetkilendirmeIndexViewModel
@{
    ViewData["Title"] = "Personel Yetkilendirme";
}

<!-- Custom CSS for cleaner look -->
    <!-- Custom CSS for cleaner look -->


    <style>
        .filter-bar {
            background: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(161, 172, 184, 0.4);
            margin-bottom: 1.5rem;
        }
        .user-avatar { width: 38px; height: 38px; object-fit: cover; }
        .avatar-initial { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
        .table th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }
        .table td { vertical-align: middle; }
        .drawer-header-img { width: 64px; height: 64px; object-fit: cover; }
        .nav-tabs .nav-link.active { border-bottom: 2px solid #696cff; color: #696cff; }
        
        /* Select2 Tweaks */
        .select2-container--bootstrap-5 .select2-selection--single {
            font-size: 0.9rem;
            padding-top: 0.3rem; 
            padding-bottom: 0.3rem;
            height: 38px;
        }
    </style>

    <style>
        /* Highlight for newly added personnel rows */
        @@keyframes newRowGlow {
            0% { background-color: #cce5ff; }
            70% { background-color: #cce5ff; }
            100% { background-color: transparent; }
        }
        .highlight-new-row {
            animation: newRowGlow 5s ease-out;
            border-left: 4px solid #696cff;
        }
    </style>

<div class="row h-100">
    <div class="col-md-12">
        
        <!-- Filter Bar -->
        <!-- Filter Bar (Grid Layout) -->
        <div class="filter-bar row row-cols-1 row-cols-md-3 row-cols-xl-6 g-2 align-items-center">
            <!-- 1. Search -->
            <div class="col">
                <input type="text" id="filterSearch" class="form-control w-100" placeholder="Ad Soyad Ara...">
            </div>
            
            <!-- 2. Teskilat -->
            <div class="col">
                <select id="filterTeskilat" class="form-select w-100">
                    <option value="">Teşkilat: Tümü</option>
                    @foreach (var item in Model.TeskilatList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 3. Koordinatorluk -->
            <div class="col">
                <select id="filterKoordinatorluk" class="form-select w-100" disabled>
                    <option value="">Önce Teşkilat Seçiniz</option>
                </select>
            </div>

            <!-- 4. Komisyon -->
            <div class="col">
                <select id="filterKomisyon" class="form-select w-100" disabled>
                    <option value="">Önce Koordinatörlük Seçiniz</option>
                </select>
            </div>

            <!-- 5. Branş -->
            <div class="col">
                <select id="filterBrans" class="form-select w-100">
                    <option value="">Branş: Tümü</option>
                    @foreach (var item in Model.BransList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 6. Kurumsal Rol -->
            <div class="col">
                <select id="filterKurumsalRol" class="form-select w-100">
                    <option value="">Kurumsal Rol: Tümü</option>
                    @foreach (var item in Model.KurumsalRolList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 7. Sistem Rolü (Starts Row 2) -->
            <div class="col">
                <select id="filterSistemRol" class="form-select w-100">
                    <option value="">Sistem Rolü: Tümü</option>
                    @foreach (var item in Model.SistemRolList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 8. Yazılım -->
            <div class="col">
                <select id="filterYazilim" class="form-select w-100">
                    <option value="">Yazılım: Tümü</option>
                    @foreach (var item in Model.YazilimList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 9. Uzmanlık -->
            <div class="col">
                <select id="filterUzmanlik" class="form-select w-100">
                    <option value="">Uzmanlık: Tümü</option>
                    @foreach (var item in Model.UzmanlikList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 10. Görev Türü -->
            <div class="col">
                <select id="filterGorevTuru" class="form-select w-100">
                    <option value="">Görev Türü: Tümü</option>
                    @foreach (var item in Model.GorevTuruList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 11. İş Niteliği -->
            <div class="col">
                <select id="filterIsNiteligi" class="form-select w-100">
                    <option value="">İş Niteliği: Tümü</option>
                    @foreach (var item in Model.IsNiteligiList) { <option value="@item.Text">@item.Text</option> }
                </select>
            </div>

            <!-- 12. Temizle Button (Aligns under Kurumsal Rol) -->
            <div class="col">
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="Filtreleri Temizle">
                    <i class="bx bx-filter-alt"></i> Temizle
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="card h-100">
            <div class="table-responsive text-nowrap" style="min-height: 500px;">
                <table class="table table-hover" id="personelTable">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Foto</th>
                            <th>Ad Soyad</th>
                            <th>Teşkilat</th>
                            <th>Koordinatörlük</th>
                            <th>Komisyonlar</th>
                            <th>Sistem Rolü</th>
                            <th>Kurumsal Rol</th>
                        </tr>
                    </thead>
                    <tbody class="table-border-bottom-0">
                        @foreach (var p in Model.Personeller)
                        {
                            var teskilatStr = string.Join(",", p.TeskilatAdlari);
                            var koordinatorlukStr = string.Join(",", p.KoordinatorlukAdlari);
                            var kurumsalStr = string.Join(",", p.KurumsalRolAdlari);
                            var komisyonStr = string.Join(",", p.KomisyonAdlari);
                            var yazilimStr = string.Join(",", p.Yazilimlar);
                            var uzmanlikStr = string.Join(",", p.Uzmanliklar);
                            var gorevStr = string.Join(",", p.GorevTurleri);
                            var isStr = string.Join(",", p.IsNitelikleri);
                            
                            <tr class="cursor-pointer" onclick="openDrawer(@p.PersonelId)"
                                data-personel-id="@p.PersonelId"
                                data-search="@p.AdSoyad.ToLower()"
                                data-teskilat="@teskilatStr"
                                data-koordinatorluk="@koordinatorlukStr"
                                data-sistem="@p.SistemRol"
                                data-kurumsal="@kurumsalStr"
                                data-komisyon="@komisyonStr"
                                data-brans="@p.Brans"
                                data-yazilim="@yazilimStr"
                                data-uzmanlik="@uzmanlikStr"
                                data-gorevturu="@gorevStr"
                                data-isniteligi="@isStr"
                                style="@(!p.AktifMi ? "opacity: 0.5; pointer-events: none;" : "")">
                                
                                <td class="ps-4">
                                     <div class="avatar avatar-sm">
                                        @if (!string.IsNullOrEmpty(p.FotografYolu))
                                        {
                                            <img src="@p.FotografYolu" alt="Avatar" class="rounded-circle user-avatar">
                                        }
                                        else
                                        {
                                            <span class="avatar-initial rounded-circle bg-label-primary">@GetInitials(p.AdSoyad)</span>
                                        }
                                     </div>
                                </td>
                                <td>
                                    <span class="fw-semibold">@p.AdSoyad</span>
                                </td>
                                <td>@Html.Raw(RenderChips(p.TeskilatAdlari, "primary"))</td>
                                <td>@Html.Raw(RenderChips(p.KoordinatorlukAdlari, "secondary"))</td>
                                <td>@Html.Raw(RenderChips(p.KomisyonAdlari, "info"))</td>
                                <td>
                                    <span class="badge bg-label-@(p.SistemRol == "Admin" ? "warning" : "primary")">@p.SistemRol</span>
                                </td>
                                <td>@Html.Raw(RenderChips(p.KurumsalRolAdlari, "dark"))</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div id="noResults" class="text-center p-5 d-none">
                    <h5 class="text-muted">Kayıt bulunamadı.</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel: Drawer (Offcanvas) -->
    <div class="offcanvas offcanvas-end shadow-lg" tabindex="-1" id="offcanvasEnd" aria-labelledby="offcanvasEndLabel" style="width: 500px;">
        <div class="offcanvas-header border-bottom">
            <h5 id="offcanvasEndLabel" class="offcanvas-title ms-2">Personel Yetkilendirme</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body mx-0 flex-grow-0 p-4">
            <div id="drawerLoader" class="text-center d-none mt-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
            </div>
            
            <div id="drawerContent">
                <!-- Content will be loaded via JS -->
            </div>
        </div>
    </div>
</div>

@functions {
    public string RenderChips(List<string> items, string color)
    {
        if (items == null || !items.Any()) return "";
        
        var visibleCount = 1;
        var html = "";
        
        if (items.Count <= visibleCount)
        {
            foreach(var item in items)
            {
                html += $"<span class='badge bg-label-{color} me-1'>{item}</span>";
            }
        }
        else
        {
            // Visible items
            for(int i = 0; i < visibleCount; i++)
            {
                html += $"<span class='badge bg-label-{color} me-1'>{items[i]}</span>";
            }
            
            // Expand Button (...)
            html += $"<span class='badge bg-label-{color} cursor-pointer show-more-btn' style='cursor:pointer; opacity:0.8' onclick='toggleContainer(this)'>...</span>";
            
            // Hidden Container
            html += $"<div class='d-none mt-1 extended-container' style='line-height: 2;'>";
            
            // Remaining items
            for(int i = visibleCount; i < items.Count; i++)
            {
                html += $"<span class='badge bg-label-{color} me-1'>{items[i]}</span>";
            }
            
            // Collapse Button (X)
            html += $"<span class='badge bg-secondary cursor-pointer' style='cursor:pointer' onclick='toggleContainer(this)'>X</span>";
            
            html += "</div>";
        }
        return html;
    }

    public string GetInitials(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return "";
        var parts = fullName.Trim().Split(' ');
        if (parts.Length == 1) return parts[0].Length > 0 ? parts[0].Substring(0, 1).ToUpper() : "";
        return (parts[0].Substring(0, 1) + parts[parts.Length - 1].Substring(0, 1)).ToUpper();
    }
}

@section Scripts {

    <script>
        var allTeskilatOptions = @Json.Serialize(Model.TeskilatList);
        var allKurumsalRolOptions = @Json.Serialize(Model.KurumsalRolList);
        var allSistemRolOptions = @Json.Serialize(Model.SistemRolList);
        
        // Initialize Select2
        $(document).ready(function() {
             $('#filterKoordinatorluk').select2({
                 theme: 'bootstrap-5',
                 allowClear: false,
                 placeholder: 'Koordinatörlük: Tümü',
                 width: '100%'
             });
             
             $('#filterBrans').select2({
                 theme: 'bootstrap-5',
                 allowClear: false,
                 placeholder: 'Branş: Tümü',
                 width: '100%'
             });

             // Re-trigger change for filter logic when Select2 changes
             $('#filterKoordinatorluk, #filterBrans').on('select2:select select2:unselect', function (e) {
                 filterTable();
             });
        });

        // --- Expandable Chips Logic ---
        function toggleContainer(element) {
            if (event) event.stopPropagation(); // Stop row click
            
            if (element.classList.contains('show-more-btn')) {
                // Expanding
                var container = element.nextElementSibling;
                if(container) {
                    element.classList.add('d-none');
                    container.classList.remove('d-none');
                }
            } else {
                // Collapsing (The 'X' button)
                var container = element.parentElement;
                var showBtn = container.previousElementSibling;
                
                container.classList.add('d-none');
                if(showBtn) {
                    showBtn.classList.remove('d-none');
                }
            }
        }

        // --- Filtering Logic ---
        $(document).ready(function() {
            const inputs = [
                '#filterSearch', '#filterTeskilat', '#filterKoordinatorluk', '#filterSistemRol', '#filterKurumsalRol', '#filterKomisyon',
                '#filterBrans', '#filterYazilim', '#filterUzmanlik', '#filterGorevTuru', '#filterIsNiteligi'
            ];
            
            // General filtering
            inputs.forEach(id => $(id).on('input change', filterTable));

            // Cascading Logic
            $('#filterTeskilat').on('change', function() {
                var val = $(this).val();
                loadKoordinatorlukler(val);
                updateKurumsalRolFilter(val);
            });

            $('#filterKoordinatorluk').on('change', function() {
                var val = $(this).val();
                loadKomisyonlar(val);
            });
        });

        function loadKoordinatorlukler(teskilatAd) {
            var $dropdown = $('#filterKoordinatorluk');
            var $childDropdown = $('#filterKomisyon');

            if (!teskilatAd) {
                // Disable and Reset
                $dropdown.empty().append('<option value="">Önce Teşkilat Seçiniz</option>').prop('disabled', true);
                $childDropdown.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true);
                
                // Notify Select2 if initialized
                $dropdown.trigger('change.select2'); 
                return;
            }

            $.ajax({
                url: '/Personel/GetKoordinatorlukNames',
                data: { teskilatAd: teskilatAd },
                success: function(data) {
                    $dropdown.empty().append('<option value="">Koordinatörlük: Tümü</option>');
                    
                    $.each(data, function(i, item) {
                        $dropdown.append($('<option>', { value: item, text: item }));
                    });
                    
                    $dropdown.prop('disabled', false);
                    $dropdown.trigger('change.select2'); // Notify Select2
                }
            });
        }

        function loadKomisyonlar(koordinatorlukAd) {
            var $dropdown = $('#filterKomisyon');

            if (!koordinatorlukAd) {
                // Disable and Reset
                $dropdown.empty().append('<option value="">Önce Koordinatörlük Seçiniz</option>').prop('disabled', true);
                return;
            }

            $.ajax({
                url: '/Personel/GetKomisyonNames',
                data: { koordinatorlukAd: koordinatorlukAd },
                success: function(data) {
                    $dropdown.empty().append('<option value="">Komisyon: Tümü</option>');
                    
                    $.each(data, function(i, item) {
                        $dropdown.append($('<option>', { value: item, text: item }));
                    });
                    
                    $dropdown.prop('disabled', false);
                }
            });
        }

        // Store original Kurumsal Rol options (lazy init)
        var allKurumsalRolFilterOptions = null;

        function getKurumsalRolFilterOptions() {
            if (allKurumsalRolFilterOptions === null) {
                allKurumsalRolFilterOptions = [];
                $('#filterKurumsalRol option').each(function() {
                    allKurumsalRolFilterOptions.push({ value: $(this).val(), text: $(this).text() });
                });
            }
            return allKurumsalRolFilterOptions;
        }

        function updateKurumsalRolFilter(teskilatAd) {
            var opts = getKurumsalRolFilterOptions();
            var $dropdown = $('#filterKurumsalRol');
            var currentVal = $dropdown.val();
            var isMerkez = teskilatAd && teskilatAd.indexOf('Merkez') > -1;

            // Clear and rebuild
            $dropdown.empty();

            opts.forEach(function(opt) {
                var allowed = true;
                var txt = opt.text;

                if (teskilatAd) {
                    if (isMerkez) {
                        // Merkez: hide İl Koordinatörü
                        if (txt.indexOf('İl Koordinat') > -1) allowed = false;
                    } else {
                        // Taşra: hide Merkez Birim Koordinatörlüğü + Genel Koordinatör
                        if (txt.indexOf('Merkez Birim') > -1) allowed = false;
                        if (txt.indexOf('Genel Koordinat') > -1) allowed = false;
                    }
                }

                if (allowed) {
                    $dropdown.append($('<option>', { value: opt.value, text: opt.text }));
                }
            });

            // Restore or reset selection
            if (currentVal && $dropdown.find('option[value="' + currentVal + '"]').length > 0) {
                $dropdown.val(currentVal);
            } else {
                $dropdown.val('');
            }
        }

        function filterTable() {
            const search = $('#filterSearch').val().toLowerCase();
            const teskilat = $('#filterTeskilat').val();
            const koordinatorluk = $('#filterKoordinatorluk').val();
            const sistem = $('#filterSistemRol').val();
            const kurumsal = $('#filterKurumsalRol').val();
            const komisyon = $('#filterKomisyon').val();
            
            const brans = $('#filterBrans').val();
            const yazilim = $('#filterYazilim').val();
            const uzmanlik = $('#filterUzmanlik').val();
            const gorevTuru = $('#filterGorevTuru').val();
            const isNiteligi = $('#filterIsNiteligi').val();

            let visibleCount = 0;

            $('#personelTable tbody tr').each(function() {
                const $row = $(this);
                const rSearch = $row.data('search');
                const rTeskilat = $row.data('teskilat');
                const rKoordinatorluk = $row.data('koordinatorluk');
                const rSistem = $row.data('sistem');
                const rKurumsal = $row.data('kurumsal');
                const rKomisyon = $row.data('komisyon');
                
                const rBrans = $row.data('brans') || '';
                const rYazilim = $row.data('yazilim') || '';
                const rUzmanlik = $row.data('uzmanlik') || '';
                const rGorevTuru = $row.data('gorevturu') || '';
                const rIsNiteligi = $row.data('isniteligi') || '';

                const mSearch = !search || rSearch.includes(search);
                const mTeskilat = !teskilat || rTeskilat.includes(teskilat);
                const mKoordinatorluk = !koordinatorluk || rKoordinatorluk.includes(koordinatorluk);
                const mSistem = !sistem || rSistem === sistem;
                const mKurumsal = !kurumsal || rKurumsal.includes(kurumsal);
                const mKomisyon = !komisyon || rKomisyon.includes(komisyon);
                
                const mBrans = !brans || rBrans === brans;
                const mYazilim = !yazilim || rYazilim.includes(yazilim);
                const mUzmanlik = !uzmanlik || rUzmanlik.includes(uzmanlik);
                const mGorevTuru = !gorevTuru || rGorevTuru.includes(gorevTuru);
                const mIsNiteligi = !isNiteligi || rIsNiteligi.includes(isNiteligi);

                if(mSearch && mTeskilat && mKoordinatorluk && mSistem && mKurumsal && mKomisyon && mBrans && mYazilim && mUzmanlik && mGorevTuru && mIsNiteligi) {
                    $row.show();
                    visibleCount++;
                } else {
                    $row.hide();
                }
            });

            if(visibleCount === 0) $('#noResults').removeClass('d-none');
            else $('#noResults').addClass('d-none');
        }

        function clearFilters() {
            $('#filterSearch').val('');
            
            // Clear parents triggers cascading clear
            $('#filterTeskilat').val('').trigger('change'); 
            
            // filterKoordinatorluk is cleared by cascading logic above, but we ensure it
            // Reset others
            $('#filterSistemRol').val('');
            $('#filterKurumsalRol').val('');
            
            // Note: filterKomisyon is cleared by cascading logic
            
            $('#filterBrans').val('').trigger('change'); // Reset Select2
            $('#filterYazilim').val('');
            $('#filterUzmanlik').val('');
            $('#filterGorevTuru').val('');
            $('#filterIsNiteligi').val('');
            
            filterTable();
        }
        // Toplu Atama'dan gelen highlight parametresini işle
        function highlightFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const highlightStr = params.get('highlight');
            if (!highlightStr) return;

            const highlightIds = highlightStr.split(',').map(Number);
            if (!highlightIds.length) return;

            const $tbody = $('#personelTable tbody');
            const rowsToMove = [];

            // Highlight edilen satırları bul ve topla
            highlightIds.forEach(function(pid) {
                const $row = $tbody.find('tr[data-personel-id="' + pid + '"]');
                if ($row.length) {
                    $row.addClass('highlight-new-row');
                    rowsToMove.push($row);
                }
            });

            // Satırları tablonun en üstüne taşı (ters sıra ile prepend)
            for (let i = rowsToMove.length - 1; i >= 0; i--) {
                $tbody.prepend(rowsToMove[i]);
            }

            // Sayfanın en üstüne scroll yap
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Sayfa yüklendiğinde highlight kontrolü yap
        $(function() {
            highlightFromUrl();
        });
    </script>
    <script src="~/js/personel-yetkilendirme-draft.js" asp-append-version="true"></script>
}

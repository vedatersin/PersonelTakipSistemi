
@using System.Security.Claims

<aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
  <div class="app-brand demo pb-6">
      <a href="/" class="app-brand-link">
        <span class="app-brand-logo demo me-2">
            <img src="~/sevilay-tema/assets/img/meb_logo.png" alt="MEB Logo" style="width: 70px; height: auto;" />
        </span>
        <div class="app-brand-text demo menu-text fw-bold ms-2" style="display: flex; flex-direction: column; justify-content: center; text-align: left;">
            <span style="font-size: 0.95rem; color: #fff; font-weight: 700; letter-spacing: 0.5px; line-height: 1.2;">Temel Eğitim</span>
            <span style="font-size: 0.95rem; color: #fff; font-weight: 700; letter-spacing: 0.5px; line-height: 1.2;">Genel Müdürlüğü</span>
            <span style="font-size: 0.75rem; color: #b1b9c2; margin-top: 4px; letter-spacing: 0.3px;">Personel Takip Sistemi</span>
        </div>
      </a>


  </div>



  <div class="menu-inner-shadow"></div>

  <ul class="menu-inner py-1">


    @{
        var userRole = User.FindFirstValue(ClaimTypes.Role);
        var currentUserIdStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
        
        string currentAction = ViewContext.RouteData.Values["Action"]?.ToString();
        string currentController = ViewContext.RouteData.Values["Controller"]?.ToString();
        bool isIdPresent = ViewContext.RouteData.Values.ContainsKey("id") || Context.Request.Query.ContainsKey("id");

         // Personel Modülü Logic (Controller Check Added)
        bool isPersonelController = string.Equals(currentController, "Personel", StringComparison.OrdinalIgnoreCase);

        bool isYeniActive = isPersonelController && (string.Equals(currentAction, "Yeni", StringComparison.OrdinalIgnoreCase) || 
                           (string.Equals(currentAction, "Ekle", StringComparison.OrdinalIgnoreCase) && !isIdPresent));
        bool isIndexActive = isPersonelController && string.Equals(currentAction, "Index", StringComparison.OrdinalIgnoreCase);
        bool isYetkilendirmeActive = isPersonelController && string.Equals(currentAction, "Yetkilendirme", StringComparison.OrdinalIgnoreCase);
        bool isPersonelAyarlarActive = string.Equals(currentController, "PersonelAyarlar", StringComparison.OrdinalIgnoreCase);
        
        bool isPersonelModuleOpen = isYeniActive || isIndexActive || isYetkilendirmeActive || isPersonelAyarlarActive;

        // Profilim Logic
        bool isProfileActive = (isPersonelController && (
                                    string.Equals(currentAction, "BenimDetay", StringComparison.OrdinalIgnoreCase) || 
                                    (string.Equals(currentAction, "Detay", StringComparison.OrdinalIgnoreCase) && ViewContext.RouteData.Values["id"]?.ToString() == currentUserIdStr) ||
                                    (string.Equals(currentAction, "Ekle", StringComparison.OrdinalIgnoreCase) && ViewContext.RouteData.Values["id"]?.ToString() == currentUserIdStr)
                                ))
                                || (string.Equals(currentController, "Bildirimler", StringComparison.OrdinalIgnoreCase));
        
        string openClass = isProfileActive ? "open" : ""; 
    }

    @if (userRole == "Admin" || userRole == "Yönetici" || userRole == "Editör")
    {
        <!-- Personel Modülü (Admin, Yönetici, Editör) -->
        <li class="menu-item @(isPersonelModuleOpen ? "active open" : "")">
          <a href="javascript:void(0);" class="menu-link menu-toggle">
            <i class="menu-icon tf-icons bx bx-id-card"></i>
            <div class="text-truncate" data-i18n="Personel Modülü">Personel Modülü</div>
          </a>
          <ul class="menu-sub">
            <li class="menu-item @(isYeniActive ? "active" : "")">
              <a asp-controller="Personel" asp-action="Yeni" class="menu-link">
                <div class="text-truncate" data-i18n="Yeni Personel Ekle">Yeni Personel Ekle</div>
              </a>
            </li>
            <li class="menu-item @(isIndexActive ? "active" : "")">
              <a asp-controller="Personel" asp-action="Index" class="menu-link">
                <div class="text-truncate" data-i18n="Personel Listesi">Personel Listesi</div>
              </a>
            </li>
            @if (userRole == "Admin" || userRole == "Yönetici")
            {
                <li class="menu-item @(isPersonelAyarlarActive ? "active" : "")">
                  <a asp-controller="PersonelAyarlar" asp-action="Index" class="menu-link">
                    <div class="text-truncate" data-i18n="Personel Ayarları">Personel Ayarları</div>
                  </a>
                </li>
            }
          </ul>
        </li>
    }

    @if (userRole == "Admin" || userRole == "Yönetici")
    {
        <!-- Bildirim Modülü (Admin, Yönetici) -->
        <li class="menu-item @(string.Equals(currentController, "BildirimModulu", StringComparison.OrdinalIgnoreCase) ? "active" : "")">
          <a asp-controller="BildirimModulu" asp-action="Index" class="menu-link">
            <i class="menu-icon tf-icons bx bx-broadcast"></i>
            <div class="text-truncate fw-bold" data-i18n="Bildirim Modülü">Bildirim Modülü</div>
          </a>
        </li>
    }

    @if (userRole == "Admin" || userRole == "Yönetici")
    {
        <!-- Loglar Modülü (Admin, Yönetici) -->
        <li class="menu-item @(string.Equals(currentController, "Loglar", StringComparison.OrdinalIgnoreCase) ? "active" : "")">
          <a asp-controller="Loglar" asp-action="Index" class="menu-link">
            <i class="menu-icon tf-icons bx bx-history"></i>
            <div class="text-truncate fw-bold" data-i18n="Sistem Logları">Sistem Logları</div>
          </a>
        </li>

        <!-- İstatistik ve Raporlar -->
        <li class="menu-item @(string.Equals(currentController, "Istatistik", StringComparison.OrdinalIgnoreCase) ? "active" : "")">
          <a asp-controller="Istatistik" asp-action="Index" class="menu-link">
            <i class="menu-icon tf-icons bx bx-bar-chart-alt-2"></i>
            <div class="text-truncate fw-bold" data-i18n="İstatistikler">İstatistik ve Raporlar</div>
          </a>
        </li>
    }

    @if (userRole == "Admin" || userRole == "Yönetici" || userRole == "Editör")
    {
        <!-- Yetkilendirme Modülü (New) -->
        <!-- Yetkilendirme Modülü (New - Direct Link) -->
        <li class="menu-item @(isYetkilendirmeActive ? "active" : "")">
           <a asp-controller="Personel" asp-action="Yetkilendirme" class="menu-link">
            <i class="menu-icon tf-icons bx bx-shield-quarter"></i>
            <div class="text-truncate" data-i18n="Yetkilendirme Modülü">Yetkilendirme Modülü</div>
          </a>
        </li>
    }



    <!-- Birimler Modülü (Admin, Yönetici) -->
    @if (userRole == "Admin" || userRole == "Yönetici")
    {
         var isBirimlerController = string.Equals(currentController, "Birimler", StringComparison.OrdinalIgnoreCase);
         var isBirimAyarlar = isBirimlerController && string.Equals(currentAction, "Ayarlar", StringComparison.OrdinalIgnoreCase);
         var isBirimTopluAtama = isBirimlerController && string.Equals(currentAction, "TopluAtama", StringComparison.OrdinalIgnoreCase);
         var isBirimlerOpen = isBirimlerController;

        <li class="menu-item @(isBirimlerOpen ? "active open" : "")">
          <a href="javascript:void(0);" class="menu-link menu-toggle">
            <i class="menu-icon tf-icons bx bx-buildings"></i>
            <div class="text-truncate" data-i18n="Birimler Modülü">Birimler Modülü</div>
          </a>
          <ul class="menu-sub">
            <li class="menu-item @(isBirimAyarlar ? "active" : "")">
              <a asp-controller="Birimler" asp-action="Ayarlar" class="menu-link">
                <div class="text-truncate" data-i18n="Birim Ayarları">Birim Ayarları</div>
              </a>
            </li>
            <li class="menu-item @(isBirimTopluAtama ? "active" : "")">
              <a asp-controller="Birimler" asp-action="TopluAtama" class="menu-link">
                <div class="text-truncate" data-i18n="Toplu Atama">Toplu Atama</div>
              </a>
            </li>
          </ul>
        </li>
    }

    <!-- Görevler Modülü (Tüm Yetkililer Erişebilir Varsayımı - veya Admin/Yönetici) -->
    @{
        bool isGorevlerController = string.Equals(currentController, "Gorevler", StringComparison.OrdinalIgnoreCase);
        bool isGorevYeni = isGorevlerController && string.Equals(currentAction, "Yeni", StringComparison.OrdinalIgnoreCase);
        bool isGorevKategori = isGorevlerController && string.Equals(currentAction, "KategoriYeni", StringComparison.OrdinalIgnoreCase);
        bool isGorevListe = isGorevlerController && string.Equals(currentAction, "Liste", StringComparison.OrdinalIgnoreCase);
        // bool isGorevModuleOpen = isGorevlerController; // This variable is no longer used directly for the parent li's active state
    }
    @if (userRole == "Admin" || userRole == "Yönetici")
    {
        <!-- Görevler Modülü -->
        <li class="menu-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Gorevler" && !string.Equals(currentAction, "Gorevlerim", StringComparison.OrdinalIgnoreCase) && !string.Equals(currentAction, "Detay", StringComparison.OrdinalIgnoreCase) ? "active open" : "")">
          <a href="javascript:void(0);" class="menu-link menu-toggle">
            <i class="menu-icon tf-icons bx bx-task"></i>
            <div class="text-truncate" data-i18n="Görevler Modülü">Görevler Modülü</div>
          </a>
          <ul class="menu-sub">
            <li class="menu-item @(isGorevYeni ? "active" : "")">
              <a asp-controller="Gorevler" asp-action="Yeni" class="menu-link">
                <div class="text-truncate" data-i18n="Yeni Görev Ekle">Yeni Görev Ekle</div>
              </a>
            </li>
            <li class="menu-item @(isGorevKategori ? "active" : "")">
              <a asp-controller="Gorevler" asp-action="KategoriYeni" class="menu-link">
                <div class="text-truncate" data-i18n="Görev Kategorisi Ekle">Görev Kategorisi Ekle</div>
              </a>
            </li>
            <li class="menu-item @(isGorevListe ? "active" : "")">
              <a asp-controller="Gorevler" asp-action="Liste" class="menu-link">
                 <div class="text-truncate" data-i18n="Görev Listele">Görev Listele</div>
              </a>
            </li>
          </ul>
        </li>
    }

    <!-- Profilim & Bildirimler (Tüm Kullanıcılar İçin - En Altta) -->
    <li class="menu-item @(isProfileActive || string.Equals(currentAction, "Gorevlerim", StringComparison.OrdinalIgnoreCase) ? "active open" : "")">
         <a href="javascript:void(0);" class="menu-link menu-toggle">
            <i class="menu-icon tf-icons bx bx-user-circle"></i>
            <div class="text-truncate" data-i18n="Profilim">Profilim</div>
          </a>
          <ul class="menu-sub">
            <li class="menu-item @(string.Equals(currentAction, "Gorevlerim", StringComparison.OrdinalIgnoreCase) ? "active" : "")">
                <a asp-controller="Gorevler" asp-action="Gorevlerim" class="menu-link">
                    <div class="text-truncate" data-i18n="Görevlerim">Görevlerim</div>
                </a>
            </li>
            <li class="menu-item @(currentAction == "BenimDetay" || (currentAction == "Detay" && ViewContext.RouteData.Values["id"]?.ToString() == currentUserIdStr) ? "active" : "")">
                <a asp-controller="Personel" asp-action="BenimDetay" class="menu-link">
                    <div class="text-truncate" data-i18n="Profil Bilgileri">Profil Bilgileri</div>
                </a>
            </li>
             <li class="menu-item @(currentAction == "Ekle" && ViewContext.RouteData.Values["id"]?.ToString() == currentUserIdStr ? "active" : "")">
                <a asp-controller="Personel" asp-action="Ekle" asp-route-id="@currentUserIdStr" class="menu-link">
                    <div class="text-truncate" data-i18n="Profili Düzenle">Profili Düzenle</div>
                </a>
            </li>
             <li class="menu-item @(currentController == "Bildirimler" ? "active" : "")">
                <a asp-controller="Bildirimler" asp-action="Index" class="menu-link">
                    <div class="text-truncate" data-i18n="Bildirimler">Bildirimler</div>
                </a>
            </li>
          </ul>
    </li>

    <!-- Placeholder for other menus -->
  </ul>
</aside>
